---
title: "10x-plot-classification"
author: "Genevieve Housman"
date: "May 2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 10X Data Cellranger Analysis - Cell Classification Plots

Make plots of cell classification findings and assess functional enrichments.
Visualize gene expression correlations across cell classifications.
Examine overlap of cells across classification schemes.

https://cran.r-project.org/web/packages/cvms/vignettes/creating_a_confusion_matrix.html

```{r}

#Load libraries
library(Seurat)
library(cvms)
library(broom)
library(tibble)
library(dplyr)
library(stringi)
library(stringr)
library(ggplot2)
library(GGally)
library(colorspace)
library(RColorBrewer)
library(ggplot2)
library(cowplot)
library(edgeR)

```

```{r}

#Load data
#data integrated across individuals - total (conservative cell filter + non-zero genes + regress out UMI/mito)
scrna <- "./data/cellranger-data-full/data.filterC.log.indv-cell.intNo0.reg-tot.assign.rds"
data <- readRDS(scrna)

#Define individual-replicate sets
data@meta.data$Individual.Replicate <- paste0(data@meta.data$Individual,".",data@meta.data$Replicate)

```

```{r}

#Load libraries for GO enrichment analysis
library(clusterProfiler)
library(org.Hs.eg.db)
library(viridis)

#Define functions to assess GO functional enrichment
goEnrich <- function(totGenes, deGenes, ontology) {
  ref.df <- bitr(totGenes, fromType="SYMBOL", toType=c("ENSEMBL","ENTREZID"), OrgDb=org.Hs.eg.db)
  gene.df <- bitr(deGenes, fromType="SYMBOL", toType=c("ENSEMBL","ENTREZID"), OrgDb=org.Hs.eg.db)
  ego <- enrichGO(gene          = gene.df$ENSEMBL,
                  OrgDb         = org.Hs.eg.db,
                  universe      = ref.df$ENSEMBL,
                  keyType       = 'ENSEMBL',
                  ont           = ontology,
                  pAdjustMethod = "BH",
                  pvalueCutoff  = 0.01,
                  qvalueCutoff  = 0.05,
                  readable      = TRUE)
  return(ego)
}

#Define function to plot GO functional enrichment results
goEnPlot <- function(goTot, title) {
  print(ggplot(goTot, aes(x=Count, y=Description, color=p.adjust, size=Count), split='ONTOLOGY') +
          geom_point() +
          theme(axis.text.x=element_text(angle=-40, hjust=0)) +
          facet_grid(ONTOLOGY~., scale="free") +
          scale_size_area(max_size=6) +
          scale_color_viridis(option="C") +
          theme_bw() +
          labs(title=title))
}

#Get total genes
counts <- as.matrix(data@assays$RNA@counts) #do not use integrated data
counts <- counts[rowSums(counts>0)>0,]      #remove genes with 0 counts across cells
geneTot <- rownames(counts)

#Get mitochondrial and ribosomal genes
genes <- rownames(data@assays$RNA@counts)
genes.mito <- c("MT-ATP6","MT-ATP8","MT-CO1","MT-CO2","MT-CO3","MT-CYB","MT-ND1","MT-ND2","MT-ND3","MT-ND4","MT-ND4L","MT-ND5")
genes.ribo <- grep('^RP',genes,value=T)
genes.no.mito.ribo <- genes[which(!(genes %in% c(genes.mito,genes.ribo)))]
rm(genes,genes.mito,genes.ribo)

```

## Stage of differentiation at collection

### Plots
Make plots of cell classification findings.

```{r}

#umap
DimPlot(data,
        group.by="Stage",
        reduction="umap",
        cols=c("pink","mediumorchid","dodgerblue")) +
  labs(x="UMAP1",y="UMAP2")
DimPlot(data,
        group.by="Stage",
        split.by="Species",
        reduction="umap",
        cols=c("pink","mediumorchid","dodgerblue")) +
  labs(x="UMAP1",y="UMAP2")

#cell counts
ggplot(data@meta.data, aes(x=Stage, fill=Stage)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("pink","mediumorchid","dodgerblue")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12))

#umi counts
ggplot(data@meta.data, aes(x=Stage, y=nCount_RNA, fill=Stage)) +
  geom_violin(width=0.8) +
  labs(y="UMIs per Cell", x="") +
  scale_fill_manual(name="", values=c("pink","mediumorchid","dodgerblue")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12))

#gene counts
ggplot(data@meta.data, aes(x=Stage, y=nFeature_RNA, fill=Stage)) +
  geom_violin(width=0.8) +
  labs(y="Genes per Cell", x="") +
  scale_fill_manual(name="", values=c("pink","mediumorchid","dodgerblue")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12))

#marker genes
VlnPlot(data, features=c("POU5F1","CD44","COL1A1"), group.by="Stage", cols=c("pink","mediumorchid","dodgerblue"), pt.size=0)
DotPlot(subset(data,subset=Species=="Human"), features=c("COL1A1","CD44","POU5F1"), group.by="Stage", dot.scale=20, cols=c("grey99","black"), col.max=5)
DotPlot(subset(data,subset=Species=="Chimp"), features=c("COL1A1","CD44","POU5F1"), group.by="Stage", dot.scale=20, cols=c("grey99","black"), col.max=5)
#DotPlot(subset(data,subset=Species=="Human"), features=c("COL1A1","CD44","POU5F1"), group.by="Stage", dot.scale=20, cols=c("grey99","pink"), col.max=5)
#DotPlot(subset(data,subset=Species=="Human"), features=c("COL1A1","CD44","POU5F1"), group.by="Stage", dot.scale=20, cols=c("grey99","mediumorchid"), col.max=5)
#DotPlot(subset(data,subset=Species=="Human"), features=c("COL1A1","CD44","POU5F1"), group.by="Stage", dot.scale=20, cols=c("grey99","dodgerblue"), col.max=5)
#DotPlot(subset(data,subset=Species=="Chimp"), features=c("COL1A1","CD44","POU5F1"), group.by="Stage", dot.scale=20, cols=c("grey99","pink"), col.max=5)
#DotPlot(subset(data,subset=Species=="Chimp"), features=c("COL1A1","CD44","POU5F1"), group.by="Stage", dot.scale=20, cols=c("grey99","mediumorchid"), col.max=5)
#DotPlot(subset(data,subset=Species=="Chimp"), features=c("COL1A1","CD44","POU5F1"), group.by="Stage", dot.scale=20, cols=c("grey99","dodgerblue"), col.max=5)

```

### Enrichment
Assess GO functional enrichment of genes defining each cluster.

```{r, eval=FALSE}

#Find markers for each stage of differentiation
markers.i <- FindMarkers(data, ident.1="Time 0", group.by="Stage", only.pos=TRUE, min.pct=0.25, logfc.threshold=0.25) #ipsc
markers.m <- FindMarkers(data, ident.1="Time 1", group.by="Stage", only.pos=TRUE, min.pct=0.25, logfc.threshold=0.25) #msc
markers.o <- FindMarkers(data, ident.1="Time 2", group.by="Stage", only.pos=TRUE, min.pct=0.25, logfc.threshold=0.25) #osteo
saveRDS(markers.i, file="./output/markersStage-I.data.filterC.log.indv-cell.intNo0.reg-tot.rds")
saveRDS(markers.m, file="./output/markersStage-M.data.filterC.log.indv-cell.intNo0.reg-tot.rds")
saveRDS(markers.o, file="./output/markersStage-O.data.filterC.log.indv-cell.intNo0.reg-tot.rds")

```

```{r}

#Stage-iPSC
genes <- readRDS("./output/markersStage-I.data.filterC.log.indv-cell.intNo0.reg-tot.rds")
#Find top 100 markers, report only the positive ones
geneSub <- genes %>% top_n(n=100, wt=avg_logFC)
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=rownames(geneSub), ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Time 0 Genes")

#Stage-MSC
genes <- readRDS("./output/markersStage-M.data.filterC.log.indv-cell.intNo0.reg-tot.rds")
#Find top 100 markers, report only the positive ones
geneSub <- genes %>% top_n(n=100, wt=avg_logFC)
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=rownames(geneSub), ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Time 1 Genes")

#Stage-Osteogenic
genes <- readRDS("./output/markersStage-O.data.filterC.log.indv-cell.intNo0.reg-tot.rds")
#Find top 100 markers, report only the positive ones
geneSub <- genes %>% top_n(n=100, wt=avg_logFC)
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=rownames(geneSub), ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Time 2 Genes")

rm(genes,geneSub,goTot)

```

### Correlations (pseudobulk: sum)
Visualize gene expression correlations across cell classifications.

```{r}

# Compile log2 normalized gene expression data
#make count matrix and metadata for edgeR object - pseudobulk (pseudocounts, filter genes mean(log2cpm)>0)
cell.subset <- c("Time 0","Time 1","Time 2")
counts <- c()
metadata <- c()
labels <- c()
for(j in cell.subset) {
  dataSub <- subset(data,subset=Stage==j)
  for (i in unique(dataSub@meta.data$Individual.Replicate)) {
    x.lab <- paste0(i,"_",j)
    w <- which(dataSub@meta.data$Individual.Replicate==i)
    if (length(w)>0) {
      x.spp <- dataSub@meta.data$Species[w][1]
      x.col <- dataSub@meta.data$Collection[w][1]
      x.ind <- dataSub@meta.data$Individual[w][1]
      x.rep <- dataSub@meta.data$Replicate[w][1]
      x.idr <- dataSub@meta.data$Individual.Replicate[w][1]
      x.stg <- dataSub@meta.data$Stage[w][1]
      if (length(w)==1) {
        x.cnt <- dataSub@assays$RNA@counts[,w]
      } else {
        x.cnt <- Matrix::rowSums(dataSub@assays$RNA@counts[,w])
      }
      counts <- cbind(counts, x.cnt)
      metadata <- rbind(metadata, c(x.lab, x.spp, x.col, x.ind, x.rep, x.idr, x.stg))
      labels <- c(labels, x.lab)
    }
  }
}
colnames(counts) <- labels
rownames(metadata) <- labels
colnames(metadata) <- c("Sample","Species","Collection","Individual","Replicate","Individual.Replicate","Stage")
metadata <- as.data.frame(metadata)
#remove mitochondrial and ribosomal genes
counts <- counts[which(rownames(counts) %in% genes.no.mito.ribo),]
#make edgeR object
dge <- DGEList(counts)
meta_dge <- dge$samples[,c("lib.size","norm.factors")]
meta_dge <- cbind(meta_dge, metadata)
dge$samples <- meta_dge
rm(counts,metadata,meta_dge)
#filter genes
keep <- rowMeans(edgeR::cpm(dge,log=TRUE,prior.count=0.25))>0
dge$counts <- dge$counts[keep,]
#normalize data
dge <- calcNormFactors(dge, method="TMM")
#log2 transformed cpm
tmm <- edgeR::cpm(dge,normalized.lib.sizes=TRUE,log=TRUE,prior.count=0.25)

rm(cell.subset,labels,dataSub,i,j,w,x.lab,x.spp,x.col,x.ind,x.rep,x.idr,x.stg,x.cnt,keep,dge)

```

Keep human and chimp samples together.

```{r}

avg <- data.frame("Time0"=rowMeans(tmm[,1:14]),
                  "Time1"=rowMeans(tmm[,15:28]),
                  "Time2"=rowMeans(tmm[,29:42]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:3,
        columnLabels=c("Time 0",
                       "Time 1",
                       "Time 2"),
        mapping=ggplot2::aes(alpha=0.5))

```

Look at humans separately.

```{r}

avg <- data.frame("Time0"=rowMeans(tmm[,1:7]),
                  "Time1"=rowMeans(tmm[,15:21]),
                  "Time2"=rowMeans(tmm[,29:35]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:3,
        columnLabels=c("Time 0",
                       "Time 1",
                       "Time 2"),
        mapping=ggplot2::aes(alpha=0.5))

```

Look at chimps separately.

```{r}

avg <- data.frame("Time0"=rowMeans(tmm[,8:14]),
                  "Time1"=rowMeans(tmm[,12:28]),
                  "Time2"=rowMeans(tmm[,36:42]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:3,
        columnLabels=c("Time 0",
                       "Time 1",
                       "Time 2"),
        mapping=ggplot2::aes(alpha=0.5))

```

```{r}

rm(tmm,avg)

```

### Correlations (pseudobulk: average)
Visualize gene expression correlations across cell classifications.

Keep human and chimp samples together.

```{r}

t0 <- subset(data, subset=(Stage=="Time 0"))
Idents(t0) <- "t0"
avg.t0 <- log1p(AverageExpression(t0, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.t0$gene <- rownames(avg.t0)

t1 <- subset(data, subset=(Stage=="Time 1"))
Idents(t1) <- "t1"
avg.t1 <- log1p(AverageExpression(t1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.t1$gene <- rownames(avg.t1)

t2 <- subset(data, subset=(Stage=="Time 2"))
Idents(t2) <- "t2"
avg.t2 <- log1p(AverageExpression(t2, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.t2$gene <- rownames(avg.t2)

t.avg <- merge(avg.t0, merge(avg.t1, avg.t2, by="gene"), by="gene")

ggpairs(t.avg,
        columns=2:4,
        columnLabels=c("Time 0",
                       "Time 1",
                       "Time 2"),
        mapping=ggplot2::aes(alpha=0.5))

rm(t0,t1,t2,avg.t0,avg.t1,avg.t2,t.avg)

```

Look at humans separately.

```{r}

t0 <- subset(data, subset=(Stage=="Time 0" & Species=="Human"))
Idents(t0) <- "t0"
avg.t0 <- log1p(AverageExpression(t0, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.t0$gene <- rownames(avg.t0)

t1 <- subset(data, subset=(Stage=="Time 1" & Species=="Human"))
Idents(t1) <- "t1"
avg.t1 <- log1p(AverageExpression(t1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.t1$gene <- rownames(avg.t1)

t2 <- subset(data, subset=(Stage=="Time 2" & Species=="Human"))
Idents(t2) <- "t2"
avg.t2 <- log1p(AverageExpression(t2, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.t2$gene <- rownames(avg.t2)

t.avg <- merge(avg.t0, merge(avg.t1, avg.t2, by="gene"), by="gene")

ggpairs(t.avg,
        columns=2:4,
        columnLabels=c("Time 0",
                       "Time 1",
                       "Time 2"),
        mapping=ggplot2::aes(alpha=0.5))

rm(t0,t1,t2,avg.t0,avg.t1,avg.t2,t.avg)

```

Look at chimps separately.

```{r}

t0 <- subset(data, subset=(Stage=="Time 0" & Species=="Chimp"))
Idents(t0) <- "t0"
avg.t0 <- log1p(AverageExpression(t0, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.t0$gene <- rownames(avg.t0)

t1 <- subset(data, subset=(Stage=="Time 1" & Species=="Chimp"))
Idents(t1) <- "t1"
avg.t1 <- log1p(AverageExpression(t1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.t1$gene <- rownames(avg.t1)

t2 <- subset(data, subset=(Stage=="Time 2" & Species=="Chimp"))
Idents(t2) <- "t2"
avg.t2 <- log1p(AverageExpression(t2, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.t2$gene <- rownames(avg.t2)

t.avg <- merge(avg.t0, merge(avg.t1, avg.t2, by="gene"), by="gene")

ggpairs(t.avg,
        columns=2:4,
        columnLabels=c("Time 0",
                       "Time 1",
                       "Time 2"),
        mapping=ggplot2::aes(alpha=0.5))

rm(t0,t1,t2,avg.t0,avg.t1,avg.t2,t.avg)

```

## Unsupervised clustering

### Plots
Make plots of cell classification findings.

#### Resolution=0.05

```{r}

#umap
DimPlot(data,
        group.by="Cluster0.05",
        reduction="umap",
        cols=c("pink","pink4","grey","mediumorchid","dodgerblue","navyblue")) +
  labs(x="UMAP1",y="UMAP2")
DimPlot(data,
        group.by="Cluster0.05",
        split.by="Species",
        reduction="umap",
        cols=c("pink","pink4","grey","mediumorchid","dodgerblue","navyblue")) +
  labs(x="UMAP1",y="UMAP2")

#cell counts
ggplot(data@meta.data, aes(x=Cluster0.05, fill=Cluster0.05)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("pink","pink4","grey","mediumorchid","dodgerblue","navyblue")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))

#umi counts
ggplot(data@meta.data, aes(x=Cluster0.05, y=nCount_RNA, fill=Cluster0.05)) +
  geom_violin(width=0.8) +
  labs(y="UMIs per Cell", x="") +
  scale_fill_manual(name="", values=c("pink","pink4","grey","mediumorchid","dodgerblue","navyblue")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))

#gene counts
ggplot(data@meta.data, aes(x=Cluster0.05, y=nFeature_RNA, fill=Cluster0.05)) +
  geom_violin(width=0.8) +
  labs(y="Genes per Cell", x="") +
  scale_fill_manual(name="", values=c("pink","pink4","grey","mediumorchid","dodgerblue","navyblue")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))

#marker genes
VlnPlot(data,
        features=c("POU5F1","CD44","COL1A1"),
        group.by="Cluster0.05",
        cols=c("pink","pink4","grey","mediumorchid","dodgerblue","navyblue"),
        pt.size=0)
DotPlot(subset(data,subset=Species=="Human"),
        features=c("COL1A1","CD44","POU5F1"),
        group.by="Cluster0.05", dot.scale=20,
        cols=c("grey99","black"),
        col.max=5)
DotPlot(subset(data,subset=Species=="Chimp"),
        features=c("COL1A1","CD44","POU5F1"),
        group.by="Cluster0.05",
        dot.scale=20,
        cols=c("grey99","black"),
        col.max=5)

```

#### Resolution=0.25

```{r}

#umap
DimPlot(data,
        group.by="Cluster0.25",
        reduction="umap",
        cols=c("pink","palevioletred1","pink3","pink4","grey40","grey",
               "mediumorchid","orchid4","purple",
               "dodgerblue","dodgerblue4","navyblue")) +
  labs(x="UMAP1",y="UMAP2")
DimPlot(data,
        group.by="Cluster0.25",
        split.by="Species",
        reduction="umap",
        cols=c("pink","palevioletred1","pink3","pink4","grey40","grey",
               "mediumorchid","orchid4","purple",
               "dodgerblue","dodgerblue4","navyblue")) +
  labs(x="UMAP1",y="UMAP2")

#cell counts
ggplot(data@meta.data, aes(x=Cluster0.25, fill=Cluster0.25)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("pink","palevioletred1","pink3","pink4","grey40","grey",
                                      "mediumorchid","orchid4","purple",
                                      "dodgerblue","dodgerblue4","navyblue")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12))

#umi counts
ggplot(data@meta.data, aes(x=Cluster0.25, y=nCount_RNA, fill=Cluster0.25)) +
  geom_violin(width=0.8) +
  labs(y="UMIs per Cell", x="") +
  scale_fill_manual(name="", values=c("pink","palevioletred1","pink3","pink4","grey40","grey",
                                      "mediumorchid","orchid4","purple",
                                      "dodgerblue","dodgerblue4","navyblue")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12))

#gene counts
ggplot(data@meta.data, aes(x=Cluster0.25, y=nFeature_RNA, fill=Cluster0.25)) +
  geom_violin(width=0.8) +
  labs(y="Genes per Cell", x="") +
  scale_fill_manual(name="", values=c("pink","palevioletred1","pink3","pink4","grey40","grey",
                                      "mediumorchid","orchid4","purple",
                                      "dodgerblue","dodgerblue4","navyblue")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12))

#marker genes
VlnPlot(data,
        features=c("POU5F1","CD44","COL1A1"),
        group.by="Cluster0.25",
        cols=c("pink","palevioletred1","pink3","pink4","grey40","grey",
                                      "mediumorchid","orchid4","purple",
                                      "dodgerblue","dodgerblue4","navyblue"),
        pt.size=0)
DotPlot(subset(data,subset=Species=="Human"),
        features=c("COL1A1","CD44","POU5F1"),
        group.by="Cluster0.25", dot.scale=20,
        cols=c("grey99","black"),
        col.max=5)
DotPlot(subset(data,subset=Species=="Chimp"),
        features=c("COL1A1","CD44","POU5F1"),
        group.by="Cluster0.25",
        dot.scale=20,
        cols=c("grey99","black"),
        col.max=5)
```

#### Resolution=0.50

```{r}

#umap
DimPlot(data,
        group.by="Cluster0.50",
        reduction="umap",
        cols=c("pink","palevioletred1","palevioletred3","palevioletred4",
               "pink3","pink4","grey40","grey",
               "mediumorchid","orchid2","orchid4","purple",
               "dodgerblue","deepskyblue2","dodgerblue4","navyblue")) +
  labs(x="UMAP1",y="UMAP2")
DimPlot(data,
        group.by="Cluster0.50",
        split.by="Species",
        reduction="umap",
        cols=c("pink","palevioletred1","palevioletred3","palevioletred4",
               "pink3","pink4","grey40","grey",
               "mediumorchid","orchid2","orchid4","purple",
               "dodgerblue","deepskyblue2","dodgerblue4","navyblue")) +
  labs(x="UMAP1",y="UMAP2")

#cell counts
ggplot(data@meta.data, aes(x=Cluster0.50, fill=Cluster0.50)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("pink","palevioletred1","palevioletred3","palevioletred4",
                                      "pink3","pink4","grey40","grey",
                                      "mediumorchid","orchid2","orchid4","purple",
                                      "dodgerblue","deepskyblue2","dodgerblue4","navyblue")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12))

#umi counts
ggplot(data@meta.data, aes(x=Cluster0.50, y=nCount_RNA, fill=Cluster0.50)) +
  geom_violin(width=0.8) +
  labs(y="UMIs per Cell", x="") +
  scale_fill_manual(name="", values=c("pink","palevioletred1","palevioletred3","palevioletred4",
                                      "pink3","pink4","grey40","grey",
                                      "mediumorchid","orchid2","orchid4","purple",
                                      "dodgerblue","deepskyblue2","dodgerblue4","navyblue")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12))

#gene counts
ggplot(data@meta.data, aes(x=Cluster0.50, y=nFeature_RNA, fill=Cluster0.50)) +
  geom_violin(width=0.8) +
  labs(y="Genes per Cell", x="") +
  scale_fill_manual(name="", values=c("pink","palevioletred1","palevioletred3","palevioletred4",
                                      "pink3","pink4","grey40","grey",
                                      "mediumorchid","orchid2","orchid4","purple",
                                      "dodgerblue","deepskyblue2","dodgerblue4","navyblue")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12))

#marker genes
VlnPlot(data,
        features=c("POU5F1","CD44","COL1A1"),
        group.by="Cluster0.50",
        cols=c("pink","palevioletred1","palevioletred3","palevioletred4",
               "pink3","pink4","grey40","grey",
               "mediumorchid","orchid2","orchid4","purple",
               "dodgerblue","deepskyblue2","dodgerblue4","navyblue"),
        pt.size=0)
DotPlot(subset(data,subset=Species=="Human"),
        features=c("COL1A1","CD44","POU5F1"),
        group.by="Cluster0.50",
        dot.scale=20,
        cols=c("grey99","black"),
        col.max=5)
DotPlot(subset(data,subset=Species=="Chimp"),
        features=c("COL1A1","CD44","POU5F1"),
        group.by="Cluster0.50",
        dot.scale=20,
        cols=c("grey99","black"),
        col.max=5)

```

### Enrichment
Assess GO functional enrichment of genes defining each cluster.

#### Resolution=0.05

```{r}

#resolution=0.05-iPSC
genes <- readRDS("./output/markers0.05-I.data.filterC.log.indv-cell.intNo0.reg-tot.rds")
#Find top 100 markers, report only the positive ones
geneSub <- genes %>% top_n(n=100, wt=avg_logFC)
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=rownames(geneSub), ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.05(iPSC) Genes")

#resolution=0.05-MSC
genes <- readRDS("./output/markers0.05-M.data.filterC.log.indv-cell.intNo0.reg-tot.rds")
#Find top 100 markers, report only the positive ones
geneSub <- genes %>% top_n(n=100, wt=avg_logFC)
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=rownames(geneSub), ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.05(MSC) Genes")

#resolution=0.05-Osteogenic
genes <- readRDS("./output/markers0.05-O.data.filterC.log.indv-cell.intNo0.reg-tot.rds")
#Find top 100 markers, report only the positive ones
geneSub <- genes %>% top_n(n=100, wt=avg_logFC)
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=rownames(geneSub), ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.05(Osteogenic) Genes")

rm(genes,geneSub,goTot)

```

```{r}

#resolution=0.05
genes <- readRDS("./output/markers0.05.data.filterC.log.indv-cell.intNo0.reg-tot.rds")

#Find top 100 markers for every cluster compared to all remaining clusters, report only the positive ones
#Test for functional enrichment

#resolution=0.05-iPSC.c1
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==1)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.05(iPSC.c1) Genes")

#resolution=0.05-iPSC.c2
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==4)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.05(iPSC.c2) Genes")

#resolution=0.05-iPSC.c3
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==5)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.05(iPSC.c3) Genes")

#resolution=0.05-MSC.c1
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==0)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.05(MSC.c1) Genes")

#resolution=0.05-Osteogenic.c1
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==2)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.05(Osteogenic.c1) Genes")

#resolution=0.05-Osteogenic.c2
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==3)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.05(Osteogenic.c2) Genes")

rm(genes,geneSub,goTot)

```

#### Resolution=0.25

```{r}

#resolution=0.25
genes <- readRDS("./output/markers0.25.data.filterC.log.indv-cell.intNo0.reg-tot.rds")

#Find top 100 markers for every cluster compared to all remaining clusters, report only the positive ones
#Test for functional enrichment

#resolution=0.25-iPSC.c1
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==2)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.25(iPSC.c1) Genes")

#resolution=0.25-iPSC.c2
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==3)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.25(iPSC.c2) Genes")

#resolution=0.25-iPSC.c3
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==9)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.25(iPSC.c3) Genes")

#resolution=0.25-iPSC.c4
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==7)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.25(iPSC.c4) Genes")

#resolution=0.25-iPSC.c5
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==10)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.25(iPSC.c5) Genes")

#resolution=0.25-iPSC.c6
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==11)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.25(iPSC.c6) Genes")

#resolution=0.25-MSC.c1
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==0)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.25(MSC.c1) Genes")

#resolution=0.25-MSC.c2
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==4)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.25(MSC.c2) Genes")

#resolution=0.25-MSC.c3
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==8)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.25(MSC.c3) Genes")

#resolution=0.25-Osteogenic.c1
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==1)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.25(Osteogenic.c1) Genes")

#resolution=0.25-Osteogenic.c2
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==6)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.25(Osteogenic.c2) Genes")

#resolution=0.25-Osteogenic.c3
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==5)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.25(Osteogenic.c3) Genes")

rm(genes,geneSub,goTot)

```

#### Resolution=0.50

```{r}

#resolution=0.50
genes <- readRDS("./output/markers0.5.data.filterC.log.indv-cell.intNo0.reg-tot.rds")

#resolution=0.50-iPSC.c1
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==2)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.50(iPSC.c1) Genes")

#resolution=0.50-iPSC.c2
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==3)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.50(iPSC.c2) Genes")

#resolution=0.50-iPSC.c3
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==9)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.50(iPSC.c3) Genes")

#resolution=0.50-iPSC.c4
#no genes
#geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==12)
#goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
#goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
#goEnPlot(goTot,title="Cluster0.50(iPSC.c4) Genes")

#resolution=0.50-iPSC.c5
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==11)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.50(iPSC.c5) Genes")

#resolution=0.50-iPSC.c6
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==10)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.50(iPSC.c6) Genes")

#resolution=0.50-iPSC.c7
#no genes
#geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==14)
#goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
#goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
#goEnPlot(goTot,title="Cluster0.50(iPSC.c7) Genes")

#resolution=0.50-iPSC.c8
#no genes
#geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==15)
#goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
#goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
#goEnPlot(goTot,title="Cluster0.50(iPSC.c8) Genes")

#resolution=0.50-MSC.c1
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==1)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.50(MSC.c1) Genes")

#resolution=0.50-MSC.c2
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==4)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.50(MSC.c2) Genes")

#resolution=0.50-MSC.c3
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==7)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.50(MSC.c3) Genes")

#resolution=0.50-MSC.c4
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==5)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.50(MSC.c4) Genes")

#resolution=0.50-Osteogenic.c1
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==0)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.50(Osteogenic.c1) Genes")

#resolution=0.50-Osteogenic.c2
#no genes
#geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==13)
#goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
#goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
#goEnPlot(goTot,title="Cluster0.50(Osteogenic.c2) Genes")

#resolution=0.50-Osteogenic.c3
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==8)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.50(Osteogenic.c3) Genes")

#resolution=0.50-Osteogenic.c4
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==6)
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="Cluster0.50(Osteogenic.c4) Genes")

rm(genes,geneSub,goTot)

```

### Correlations (pseudobulk: sum)
Visualize gene expression correlations across cell classifications.

#### Resolution=0.05

```{r}

# Compile log2 normalized gene expression data
#make count matrix and metadata for edgeR object - pseudobulk (pseudocounts, filter genes mean(log2cpm)>0)
cell.subset <- c("iPSC.c1","iPSC.c2","iPSC.c3","MSC.c1","Osteogenic.c1","Osteogenic.c2")
counts <- c()
metadata <- c()
labels <- c()
for(j in cell.subset) {
  dataSub <- subset(data,subset=Cluster0.05==j)
  for (i in unique(dataSub@meta.data$Individual.Replicate)) {
    x.lab <- paste0(i,"_",j)
    w <- which(dataSub@meta.data$Individual.Replicate==i)
    if (length(w)>0) {
      x.spp <- dataSub@meta.data$Species[w][1]
      x.col <- dataSub@meta.data$Collection[w][1]
      x.ind <- dataSub@meta.data$Individual[w][1]
      x.rep <- dataSub@meta.data$Replicate[w][1]
      x.idr <- dataSub@meta.data$Individual.Replicate[w][1]
      x.clt <- dataSub@meta.data$Cluster0.05[w][1]
      if (length(w)==1) {
        x.cnt <- dataSub@assays$RNA@counts[,w]
      } else {
        x.cnt <- Matrix::rowSums(dataSub@assays$RNA@counts[,w])
      }
      counts <- cbind(counts, x.cnt)
      metadata <- rbind(metadata, c(x.lab, x.spp, x.col, x.ind, x.rep, x.idr, x.clt))
      labels <- c(labels, x.lab)
    }
  }
}
colnames(counts) <- labels
rownames(metadata) <- labels
colnames(metadata) <- c("Sample","Species","Collection","Individual","Replicate","Individual.Replicate","Cluster")
metadata <- as.data.frame(metadata)
#remove mitochondrial and ribosomal genes
counts <- counts[which(rownames(counts) %in% genes.no.mito.ribo),]
#make edgeR object
dge <- DGEList(counts)
meta_dge <- dge$samples[,c("lib.size","norm.factors")]
meta_dge <- cbind(meta_dge, metadata)
dge$samples <- meta_dge
rm(counts,metadata,meta_dge)
#filter genes
keep <- rowMeans(edgeR::cpm(dge,log=TRUE,prior.count=0.25))>0
dge$counts <- dge$counts[keep,]
#normalize data
dge <- calcNormFactors(dge, method="TMM")
#log2 transformed cpm
tmm <- edgeR::cpm(dge,normalized.lib.sizes=TRUE,log=TRUE,prior.count=0.25)

rm(cell.subset,labels,dataSub,i,j,w,x.lab,x.spp,x.col,x.ind,x.rep,x.idr,x.clt,x.cnt,keep,dge)

```

Keep human and chimp samples together.

```{r}

avg <- data.frame("iPSC.c1"=rowMeans(tmm[,1:14]),
                  "iPSC.c2"=rowMeans(tmm[,15:28]),
                  "iPSC.c3"=rowMeans(tmm[,29:39]),
                  "MSC.c1"=rowMeans(tmm[,40:53]),
                  "Osteogenic.c1"=rowMeans(tmm[,54:67]),
                  "Osteogenic.c2"=rowMeans(tmm[,68:81]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:6,
        columnLabels=c("iPSC.c1",
                       "iPSC.c2",
                       "iPSC.c3",
                       "MSC.c1",
                       "Osteogenic.c1",
                       "Osteogenic.c2"),
        mapping=ggplot2::aes(alpha=0.5))

```

Look at humans separately.

```{r}

avg <- data.frame("iPSC.c1"=rowMeans(tmm[,1:7]),
                  "iPSC.c2"=rowMeans(tmm[,15:21]),
                  "iPSC.c3"=rowMeans(tmm[,29:33]),
                  "MSC.c1"=rowMeans(tmm[,40:46]),
                  "Osteogenic.c1"=rowMeans(tmm[,54:60]),
                  "Osteogenic.c2"=rowMeans(tmm[,68:74]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:6,
        columnLabels=c("iPSC.c1",
                       "iPSC.c2",
                       "iPSC.c3",
                       "MSC.c1",
                       "Osteogenic.c1",
                       "Osteogenic.c2"),
        mapping=ggplot2::aes(alpha=0.5))

```

Look at chimps separately.

```{r}

avg <- data.frame("iPSC.c1"=rowMeans(tmm[,8:14]),
                  "iPSC.c2"=rowMeans(tmm[,22:28]),
                  "iPSC.c3"=rowMeans(tmm[,34:39]),
                  "MSC.c1"=rowMeans(tmm[,47:53]),
                  "Osteogenic.c1"=rowMeans(tmm[,61:67]),
                  "Osteogenic.c2"=rowMeans(tmm[,75:81]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:6,
        columnLabels=c("iPSC.c1",
                       "iPSC.c2",
                       "iPSC.c3",
                       "MSC.c1",
                       "Osteogenic.c1",
                       "Osteogenic.c2"),
        mapping=ggplot2::aes(alpha=0.5))

```

```{r}

rm(tmm,avg)

```

#### Resolution=0.25

```{r}

# Compile log2 normalized gene expression data
#make count matrix and metadata for edgeR object - pseudobulk (pseudocounts, filter genes mean(log2cpm)>0)
cell.subset <- c("iPSC.c1","iPSC.c2","iPSC.c3","iPSC.c4","iPSC.c5","iPSC.c6",
                 "MSC.c1","MSC.c2","MSC.c3",
                 "Osteogenic.c1","Osteogenic.c2","Osteogenic.c3")
counts <- c()
metadata <- c()
labels <- c()
for(j in cell.subset) {
  dataSub <- subset(data,subset=Cluster0.25==j)
  for (i in unique(dataSub@meta.data$Individual.Replicate)) {
    x.lab <- paste0(i,"_",j)
    w <- which(dataSub@meta.data$Individual.Replicate==i)
    if (length(w)>0) {
      x.spp <- dataSub@meta.data$Species[w][1]
      x.col <- dataSub@meta.data$Collection[w][1]
      x.ind <- dataSub@meta.data$Individual[w][1]
      x.rep <- dataSub@meta.data$Replicate[w][1]
      x.idr <- dataSub@meta.data$Individual.Replicate[w][1]
      x.clt <- dataSub@meta.data$Cluster0.25[w][1]
      if (length(w)==1) {
        x.cnt <- dataSub@assays$RNA@counts[,w]
      } else {
        x.cnt <- Matrix::rowSums(dataSub@assays$RNA@counts[,w])
      }
      counts <- cbind(counts, x.cnt)
      metadata <- rbind(metadata, c(x.lab, x.spp, x.col, x.ind, x.rep, x.idr, x.clt))
      labels <- c(labels, x.lab)
    }
  }
}
colnames(counts) <- labels
rownames(metadata) <- labels
colnames(metadata) <- c("Sample","Species","Collection","Individual","Replicate","Individual.Replicate","Cluster")
metadata <- as.data.frame(metadata)
#remove mitochondrial and ribosomal genes
counts <- counts[which(rownames(counts) %in% genes.no.mito.ribo),]
#make edgeR object
dge <- DGEList(counts)
meta_dge <- dge$samples[,c("lib.size","norm.factors")]
meta_dge <- cbind(meta_dge, metadata)
dge$samples <- meta_dge
rm(counts,metadata,meta_dge)
#filter genes
keep <- rowMeans(edgeR::cpm(dge,log=TRUE,prior.count=0.25))>0
dge$counts <- dge$counts[keep,]
#normalize data
dge <- calcNormFactors(dge, method="TMM")
#log2 transformed cpm
tmm <- edgeR::cpm(dge,normalized.lib.sizes=TRUE,log=TRUE,prior.count=0.25)

rm(cell.subset,labels,dataSub,i,j,w,x.lab,x.spp,x.col,x.ind,x.rep,x.idr,x.clt,x.cnt,keep,dge)

```

Keep human and chimp samples together.

```{r}

avg <- data.frame("iPSC.c1"=rowMeans(tmm[,1:14]),
                  "iPSC.c2"=rowMeans(tmm[,15:28]),
                  "iPSC.c3"=rowMeans(tmm[,29:42]),
                  "iPSC.c4"=rowMeans(tmm[,43:56]),
                  "iPSC.c5"=rowMeans(tmm[,57:70]),
                  "iPSC.c6"=rowMeans(tmm[,68:81]),
                  "MSC.c1"=rowMeans(tmm[,82:95]),
                  "MSC.c2"=rowMeans(tmm[,96:109]),
                  "MSC.c3"=rowMeans(tmm[,110:123]),
                  "Osteogenic.c1"=rowMeans(tmm[,124:137]),
                  "Osteogenic.c2"=rowMeans(tmm[,138:151]),
                  "Osteogenic.c3"=rowMeans(tmm[,152:165]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:12,
        columnLabels=c("iPSC.c1",
                       "iPSC.c2",
                       "iPSC.c3",
                       "iPSC.c4",
                       "iPSC.c5",
                       "iPSC.c6",
                       "MSC.c1",
                       "MSC.c2",
                       "MSC.c3",
                       "Osteogenic.c1",
                       "Osteogenic.c2",
                       "Osteogenic.c3"),
        mapping=ggplot2::aes(alpha=0.5))

```

Look at humans separately.

```{r}

avg <- data.frame("iPSC.c1"=rowMeans(tmm[,1:7]),
                  "iPSC.c2"=rowMeans(tmm[,15:21]),
                  "iPSC.c3"=rowMeans(tmm[,29:35]),
                  "iPSC.c4"=rowMeans(tmm[,43:49]),
                  "iPSC.c5"=rowMeans(tmm[,57:61]),
                  "iPSC.c6"=rowMeans(tmm[,68:74]),
                  "MSC.c1"=rowMeans(tmm[,82:88]),
                  "MSC.c2"=rowMeans(tmm[,96:102]),
                  "MSC.c3"=rowMeans(tmm[,110:116]),
                  "Osteogenic.c1"=rowMeans(tmm[,124:130]),
                  "Osteogenic.c2"=rowMeans(tmm[,138:144]),
                  "Osteogenic.c3"=rowMeans(tmm[,152:158]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:12,
        columnLabels=c("iPSC.c1",
                       "iPSC.c2",
                       "iPSC.c3",
                       "iPSC.c4",
                       "iPSC.c5",
                       "iPSC.c6",
                       "MSC.c1",
                       "MSC.c2",
                       "MSC.c3",
                       "Osteogenic.c1",
                       "Osteogenic.c2",
                       "Osteogenic.c3"),
        mapping=ggplot2::aes(alpha=0.5))

```

Look at chimps separately.

```{r}

avg <- data.frame("iPSC.c1"=rowMeans(tmm[,8:14]),
                  "iPSC.c2"=rowMeans(tmm[,22:28]),
                  "iPSC.c3"=rowMeans(tmm[,36:42]),
                  "iPSC.c4"=rowMeans(tmm[,50:56]),
                  "iPSC.c5"=rowMeans(tmm[,62:67]),
                  "iPSC.c6"=rowMeans(tmm[,75:81]),
                  "MSC.c1"=rowMeans(tmm[,89:95]),
                  "MSC.c2"=rowMeans(tmm[,103:109]),
                  "MSC.c3"=rowMeans(tmm[,117:123]),
                  "Osteogenic.c1"=rowMeans(tmm[,131:137]),
                  "Osteogenic.c2"=rowMeans(tmm[,145:151]),
                  "Osteogenic.c3"=rowMeans(tmm[,159:165]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:12,
        columnLabels=c("iPSC.c1",
                       "iPSC.c2",
                       "iPSC.c3",
                       "iPSC.c4",
                       "iPSC.c5",
                       "iPSC.c6",
                       "MSC.c1",
                       "MSC.c2",
                       "MSC.c3",
                       "Osteogenic.c1",
                       "Osteogenic.c2",
                       "Osteogenic.c3"),
        mapping=ggplot2::aes(alpha=0.5))

```

```{r}

rm(tmm,avg)

```

#### Resolution=0.50

```{r}

# Compile log2 normalized gene expression data
#make count matrix and metadata for edgeR object - pseudobulk (pseudocounts, filter genes mean(log2cpm)>0)
cell.subset <- c("iPSC.c1","iPSC.c2","iPSC.c3","iPSC.c4","iPSC.c5","iPSC.c6","iPSC.c7","iPSC.c8",
                 "MSC.c1","MSC.c2","MSC.c3","MSC.c4",
                 "Osteogenic.c1","Osteogenic.c2","Osteogenic.c3","Osteogenic.c4")
counts <- c()
metadata <- c()
labels <- c()
for(j in cell.subset) {
  dataSub <- subset(data,subset=Cluster0.50==j)
  for (i in unique(dataSub@meta.data$Individual.Replicate)) {
    x.lab <- paste0(i,"_",j)
    w <- which(dataSub@meta.data$Individual.Replicate==i)
    if (length(w)>0) {
      x.spp <- dataSub@meta.data$Species[w][1]
      x.col <- dataSub@meta.data$Collection[w][1]
      x.ind <- dataSub@meta.data$Individual[w][1]
      x.rep <- dataSub@meta.data$Replicate[w][1]
      x.idr <- dataSub@meta.data$Individual.Replicate[w][1]
      x.clt <- dataSub@meta.data$Cluster0.50[w][1]
      if (length(w)==1) {
        x.cnt <- dataSub@assays$RNA@counts[,w]
      } else {
        x.cnt <- Matrix::rowSums(dataSub@assays$RNA@counts[,w])
      }
      counts <- cbind(counts, x.cnt)
      metadata <- rbind(metadata, c(x.lab, x.spp, x.col, x.ind, x.rep, x.idr, x.clt))
      labels <- c(labels, x.lab)
    }
  }
}
colnames(counts) <- labels
rownames(metadata) <- labels
colnames(metadata) <- c("Sample","Species","Collection","Individual","Replicate","Individual.Replicate","Cluster")
metadata <- as.data.frame(metadata)
#remove mitochondrial and ribosomal genes
counts <- counts[which(rownames(counts) %in% genes.no.mito.ribo),]
#make edgeR object
dge <- DGEList(counts)
meta_dge <- dge$samples[,c("lib.size","norm.factors")]
meta_dge <- cbind(meta_dge, metadata)
dge$samples <- meta_dge
rm(counts,metadata,meta_dge)
#filter genes
keep <- rowMeans(edgeR::cpm(dge,log=TRUE,prior.count=0.25))>0
dge$counts <- dge$counts[keep,]
#normalize data
dge <- calcNormFactors(dge, method="TMM")
#log2 transformed cpm
tmm <- edgeR::cpm(dge,normalized.lib.sizes=TRUE,log=TRUE,prior.count=0.25)

rm(cell.subset,labels,dataSub,i,j,w,x.lab,x.spp,x.col,x.ind,x.rep,x.idr,x.clt,x.cnt,keep,dge)

```

Keep human and chimp samples together.

```{r}

avg <- data.frame("iPSC.c1"=rowMeans(tmm[,1:14]),
                  "iPSC.c2"=rowMeans(tmm[,15:28]),
                  "iPSC.c3"=rowMeans(tmm[,29:42]),
                  "iPSC.c4"=rowMeans(tmm[,43:56]),
                  "iPSC.c5"=rowMeans(tmm[,57:70]),
                  "iPSC.c6"=rowMeans(tmm[,71:84]),
                  "iPSC.c7"=rowMeans(tmm[,85:95]),
                  "iPSC.c8"=rowMeans(tmm[,96:109]),
                  "MSC.c1"=rowMeans(tmm[,110:123]),
                  "MSC.c2"=rowMeans(tmm[,124:137]),
                  "MSC.c3"=rowMeans(tmm[,138:151]),
                  "MSC.c4"=rowMeans(tmm[,152:165]),
                  "Osteogenic.c1"=rowMeans(tmm[,166:179]),
                  "Osteogenic.c2"=rowMeans(tmm[,180:186]),
                  "Osteogenic.c3"=rowMeans(tmm[,187:200]),
                  "Osteogenic.c4"=rowMeans(tmm[,201:214]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:16,
        columnLabels=c("iPSC.c1",
                       "iPSC.c2",
                       "iPSC.c3",
                       "iPSC.c4",
                       "iPSC.c5",
                       "iPSC.c6",
                       "iPSC.c7",
                       "iPSC.c8",
                       "MSC.c1",
                       "MSC.c2",
                       "MSC.c3",
                       "MSC.c4",
                       "Osteogenic.c1",
                       "Osteogenic.c2",
                       "Osteogenic.c3",
                       "Osteogenic.c4"),
        mapping=ggplot2::aes(alpha=0.5))

```

Look at humans separately.

```{r}

avg <- data.frame("iPSC.c1"=rowMeans(tmm[,1:7]),
                  "iPSC.c2"=rowMeans(tmm[,15:21]),
                  "iPSC.c3"=rowMeans(tmm[,29:35]),
                  "iPSC.c4"=rowMeans(tmm[,43:49]),
                  "iPSC.c5"=rowMeans(tmm[,57:63]),
                  "iPSC.c6"=rowMeans(tmm[,71:77]),
                  "iPSC.c7"=rowMeans(tmm[,85:89]),
                  "iPSC.c8"=rowMeans(tmm[,96:102]),
                  "MSC.c1"=rowMeans(tmm[,110:116]),
                  "MSC.c2"=rowMeans(tmm[,124:130]),
                  "MSC.c3"=rowMeans(tmm[,138:144]),
                  "MSC.c4"=rowMeans(tmm[,152:158]),
                  "Osteogenic.c1"=rowMeans(tmm[,166:172]),
                  "Osteogenic.c2"=rowMeans(tmm[,180:181]),
                  "Osteogenic.c3"=rowMeans(tmm[,187:193]),
                  "Osteogenic.c4"=rowMeans(tmm[,201:207]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:16,
        columnLabels=c("iPSC.c1",
                       "iPSC.c2",
                       "iPSC.c3",
                       "iPSC.c4",
                       "iPSC.c5",
                       "iPSC.c6",
                       "iPSC.c7",
                       "iPSC.c8",
                       "MSC.c1",
                       "MSC.c2",
                       "MSC.c3",
                       "MSC.c4",
                       "Osteogenic.c1",
                       "Osteogenic.c2",
                       "Osteogenic.c3",
                       "Osteogenic.c4"),
        mapping=ggplot2::aes(alpha=0.5))

```

Look at chimps separately.

```{r}

avg <- data.frame("iPSC.c1"=rowMeans(tmm[,8:14]),
                  "iPSC.c2"=rowMeans(tmm[,22:28]),
                  "iPSC.c3"=rowMeans(tmm[,36:42]),
                  "iPSC.c4"=rowMeans(tmm[,50:56]),
                  "iPSC.c5"=rowMeans(tmm[,64:70]),
                  "iPSC.c6"=rowMeans(tmm[,78:84]),
                  "iPSC.c7"=rowMeans(tmm[,90:95]),
                  "iPSC.c8"=rowMeans(tmm[,103:109]),
                  "MSC.c1"=rowMeans(tmm[,117:123]),
                  "MSC.c2"=rowMeans(tmm[,131:137]),
                  "MSC.c3"=rowMeans(tmm[,145:151]),
                  "MSC.c4"=rowMeans(tmm[,159:165]),
                  "Osteogenic.c1"=rowMeans(tmm[,173:179]),
                  "Osteogenic.c2"=rowMeans(tmm[,182:186]),
                  "Osteogenic.c3"=rowMeans(tmm[,194:200]),
                  "Osteogenic.c4"=rowMeans(tmm[,208:214]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:16,
        columnLabels=c("iPSC.c1",
                       "iPSC.c2",
                       "iPSC.c3",
                       "iPSC.c4",
                       "iPSC.c5",
                       "iPSC.c6",
                       "iPSC.c7",
                       "iPSC.c8",
                       "MSC.c1",
                       "MSC.c2",
                       "MSC.c3",
                       "MSC.c4",
                       "Osteogenic.c1",
                       "Osteogenic.c2",
                       "Osteogenic.c3",
                       "Osteogenic.c4"),
        mapping=ggplot2::aes(alpha=0.5))
```

```{r}

rm(tmm,avg)

```

### Correlations (pseudobulk: average)
Visualize gene expression correlations across cell classifications.

#### Resolution=0.05

Keep human and chimp samples together.

```{r}

i1 <- subset(data, subset=(Cluster0.05=="iPSC.c1"))
Idents(i1) <- "i1"
avg.i1 <- log1p(AverageExpression(i1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i1$gene <- rownames(avg.i1)

i2 <- subset(data, subset=(Cluster0.05=="iPSC.c2"))
Idents(i2) <- "i2"
avg.i2 <- log1p(AverageExpression(i2, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i2$gene <- rownames(avg.i2)

i3 <- subset(data, subset=(Cluster0.05=="iPSC.c3"))
Idents(i3) <- "i3"
avg.i3 <- log1p(AverageExpression(i3, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i3$gene <- rownames(avg.i3)

m1 <- subset(data, subset=(Cluster0.05=="MSC.c1"))
Idents(m1) <- "m1"
avg.m1 <- log1p(AverageExpression(m1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.m1$gene <- rownames(avg.m1)

o1 <- subset(data, subset=(Cluster0.05=="Osteogenic.c1"))
Idents(o1) <- "o1"
avg.o1 <- log1p(AverageExpression(o1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.o1$gene <- rownames(avg.o1)

o2 <- subset(data, subset=(Cluster0.05=="Osteogenic.c2"))
Idents(o2) <- "o2"
avg.o2 <- log1p(AverageExpression(o2, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.o2$gene <- rownames(avg.o2)

avg <- merge(avg.i1,
             merge(avg.i2, 
                   merge(avg.i3,
                         merge(avg.m1,
                               merge(avg.o1,
                                     avg.o2, by="gene"),
                               by="gene"),
                         by="gene"),
                   by="gene"),
             by="gene")

ggpairs(avg,
        columns=2:length(colnames(avg)),
        columnLabels=c("iPSC.c1",
                       "iPSC.c2",
                       "iPSC.c3",
                       "MSC.c1",
                       "Osteogenic.c1",
                       "Osteogenic.c2"),
        mapping=ggplot2::aes(alpha=0.5))

rm(i1,i2,i3,m1,o1,o2)
rm(avg.i1,avg.i2,avg.i3,avg.m1,avg.o1,avg.o2)
rm(avg)

```

Look at humans separately.

```{r}

i1 <- subset(data, subset=(Cluster0.05=="iPSC.c1" & Species=="Human"))
Idents(i1) <- "i1"
avg.i1 <- log1p(AverageExpression(i1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i1$gene <- rownames(avg.i1)

i2 <- subset(data, subset=(Cluster0.05=="iPSC.c2" & Species=="Human"))
Idents(i2) <- "i2"
avg.i2 <- log1p(AverageExpression(i2, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i2$gene <- rownames(avg.i2)

i3 <- subset(data, subset=(Cluster0.05=="iPSC.c3" & Species=="Human"))
Idents(i3) <- "i3"
avg.i3 <- log1p(AverageExpression(i3, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i3$gene <- rownames(avg.i3)

m1 <- subset(data, subset=(Cluster0.05=="MSC.c1" & Species=="Human"))
Idents(m1) <- "m1"
avg.m1 <- log1p(AverageExpression(m1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.m1$gene <- rownames(avg.m1)

o1 <- subset(data, subset=(Cluster0.05=="Osteogenic.c1" & Species=="Human"))
Idents(o1) <- "o1"
avg.o1 <- log1p(AverageExpression(o1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.o1$gene <- rownames(avg.o1)

o2 <- subset(data, subset=(Cluster0.05=="Osteogenic.c2" & Species=="Human"))
Idents(o2) <- "o2"
avg.o2 <- log1p(AverageExpression(o2, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.o2$gene <- rownames(avg.o2)

avg <- merge(avg.i1,
             merge(avg.i2, 
                   merge(avg.i3,
                         merge(avg.m1,
                               merge(avg.o1,
                                     avg.o2, by="gene"),
                               by="gene"),
                         by="gene"),
                   by="gene"),
             by="gene")

ggpairs(avg,
        columns=2:length(colnames(avg)),
        columnLabels=c("iPSC.c1",
                       "iPSC.c2",
                       "iPSC.c3",
                       "MSC.c1",
                       "Osteogenic.c1",
                       "Osteogenic.c2"),
        mapping=ggplot2::aes(alpha=0.5))

rm(i1,i2,i3,m1,o1,o2)
rm(avg.i1,avg.i2,avg.i3,avg.m1,avg.o1,avg.o2)
rm(avg)

```

Look at chimps separately.

```{r}

i1 <- subset(data, subset=(Cluster0.05=="iPSC.c1" & Species=="Chimp"))
Idents(i1) <- "i1"
avg.i1 <- log1p(AverageExpression(i1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i1$gene <- rownames(avg.i1)

i2 <- subset(data, subset=(Cluster0.05=="iPSC.c2" & Species=="Chimp"))
Idents(i2) <- "i2"
avg.i2 <- log1p(AverageExpression(i2, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i2$gene <- rownames(avg.i2)

i3 <- subset(data, subset=(Cluster0.05=="iPSC.c3" & Species=="Chimp"))
Idents(i3) <- "i3"
avg.i3 <- log1p(AverageExpression(i3, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i3$gene <- rownames(avg.i3)

m1 <- subset(data, subset=(Cluster0.05=="MSC.c1" & Species=="Chimp"))
Idents(m1) <- "m1"
avg.m1 <- log1p(AverageExpression(m1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.m1$gene <- rownames(avg.m1)

o1 <- subset(data, subset=(Cluster0.05=="Osteogenic.c1" & Species=="Chimp"))
Idents(o1) <- "o1"
avg.o1 <- log1p(AverageExpression(o1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.o1$gene <- rownames(avg.o1)

o2 <- subset(data, subset=(Cluster0.05=="Osteogenic.c2" & Species=="Chimp"))
Idents(o2) <- "o2"
avg.o2 <- log1p(AverageExpression(o2, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.o2$gene <- rownames(avg.o2)

avg <- merge(avg.i1,
             merge(avg.i2, 
                   merge(avg.i3,
                         merge(avg.m1,
                               merge(avg.o1,
                                     avg.o2, by="gene"),
                               by="gene"),
                         by="gene"),
                   by="gene"),
             by="gene")

ggpairs(avg,
        columns=2:length(colnames(avg)),
        columnLabels=c("iPSC.c1",
                       "iPSC.c2",
                       "iPSC.c3",
                       "MSC.c1",
                       "Osteogenic.c1",
                       "Osteogenic.c2"),
        mapping=ggplot2::aes(alpha=0.5))

rm(i1,i2,i3,m1,o1,o2)
rm(avg.i1,avg.i2,avg.i3,avg.m1,avg.o1,avg.o2)
rm(avg)

```

#### Resolution=0.25

Keep human and chimp samples together.

```{r}

i1 <- subset(data, subset=(Cluster0.25=="iPSC.c1"))
Idents(i1) <- "i1"
avg.i1 <- log1p(AverageExpression(i1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i1$gene <- rownames(avg.i1)

i2 <- subset(data, subset=(Cluster0.25=="iPSC.c2"))
Idents(i2) <- "i2"
avg.i2 <- log1p(AverageExpression(i2, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i2$gene <- rownames(avg.i2)

i3 <- subset(data, subset=(Cluster0.25=="iPSC.c3"))
Idents(i3) <- "i3"
avg.i3 <- log1p(AverageExpression(i3, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i3$gene <- rownames(avg.i3)

i4 <- subset(data, subset=(Cluster0.25=="iPSC.c4"))
Idents(i4) <- "i4"
avg.i4 <- log1p(AverageExpression(i4, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i4$gene <- rownames(avg.i4)

i5 <- subset(data, subset=(Cluster0.25=="iPSC.c5"))
Idents(i5) <- "i5"
avg.i5 <- log1p(AverageExpression(i5, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i5$gene <- rownames(avg.i5)

i6 <- subset(data, subset=(Cluster0.25=="iPSC.c6"))
Idents(i6) <- "i6"
avg.i6 <- log1p(AverageExpression(i6, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i6$gene <- rownames(avg.i6)

m1 <- subset(data, subset=(Cluster0.25=="MSC.c1"))
Idents(m1) <- "m1"
avg.m1 <- log1p(AverageExpression(m1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.m1$gene <- rownames(avg.m1)

m2 <- subset(data, subset=(Cluster0.25=="MSC.c2"))
Idents(m2) <- "m2"
avg.m2 <- log1p(AverageExpression(m2, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.m2$gene <- rownames(avg.m2)

m3 <- subset(data, subset=(Cluster0.25=="MSC.c3"))
Idents(m3) <- "m3"
avg.m3 <- log1p(AverageExpression(m3, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.m3$gene <- rownames(avg.m3)

o1 <- subset(data, subset=(Cluster0.25=="Osteogenic.c1"))
Idents(o1) <- "o1"
avg.o1 <- log1p(AverageExpression(o1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.o1$gene <- rownames(avg.o1)

o2 <- subset(data, subset=(Cluster0.25=="Osteogenic.c2"))
Idents(o2) <- "o2"
avg.o2 <- log1p(AverageExpression(o2, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.o2$gene <- rownames(avg.o2)

o3 <- subset(data, subset=(Cluster0.25=="Osteogenic.c3"))
Idents(o3) <- "o3"
avg.o3 <- log1p(AverageExpression(o3, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.o3$gene <- rownames(avg.o3)

avg <- merge(avg.i1,
             merge(avg.i2, 
                   merge(avg.i3,
                         merge(avg.i4,
                               merge(avg.i5,
                                     merge(avg.i6,
                                           merge(avg.m1,
                                                 merge(avg.m2,
                                                       merge(avg.m3,
                                                             merge(avg.o1,
                                                                   merge(avg.o2, avg.o3, by="gene"),
                                                                   by="gene"),
                                                             by="gene"),
                                                       by="gene"),
                                                 by="gene"),
                                           by="gene"),
                                     by="gene"),
                               by="gene"),
                         by="gene"),
                   by="gene"),
             by="gene")

ggpairs(avg,
        columns=2:length(colnames(avg)),
        columnLabels=c("iPSC.c1",
                       "iPSC.c2",
                       "iPSC.c3",
                       "iPSC.c4",
                       "iPSC.c5",
                       "iPSC.c6",
                       "MSC.c1",
                       "MSC.c2",
                       "MSC.c3",
                       "Osteogenic.c1",
                       "Osteogenic.c2",
                       "Osteogenic.c3"),
        mapping=ggplot2::aes(alpha=0.5))

rm(i1,i2,i3,i4,i5,i6,m1,m2,m3,o1,o2,o3)
rm(avg.i1,avg.i2,avg.i3,avg.i4,avg.i5,avg.i6,avg.m1,avg.m2,avg.m3,avg.o1,avg.o2,avg.o3)
rm(avg)

```

Look at humans separately.

```{r}

i1 <- subset(data, subset=(Cluster0.25=="iPSC.c1" & Species=="Human"))
Idents(i1) <- "i1"
avg.i1 <- log1p(AverageExpression(i1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i1$gene <- rownames(avg.i1)

i2 <- subset(data, subset=(Cluster0.25=="iPSC.c2" & Species=="Human"))
Idents(i2) <- "i2"
avg.i2 <- log1p(AverageExpression(i2, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i2$gene <- rownames(avg.i2)

i3 <- subset(data, subset=(Cluster0.25=="iPSC.c3" & Species=="Human"))
Idents(i3) <- "i3"
avg.i3 <- log1p(AverageExpression(i3, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i3$gene <- rownames(avg.i3)

i4 <- subset(data, subset=(Cluster0.25=="iPSC.c4" & Species=="Human"))
Idents(i4) <- "i4"
avg.i4 <- log1p(AverageExpression(i4, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i4$gene <- rownames(avg.i4)

i5 <- subset(data, subset=(Cluster0.25=="iPSC.c5" & Species=="Human"))
Idents(i5) <- "i5"
avg.i5 <- log1p(AverageExpression(i5, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i5$gene <- rownames(avg.i5)

i6 <- subset(data, subset=(Cluster0.25=="iPSC.c6" & Species=="Human"))
Idents(i6) <- "i6"
avg.i6 <- log1p(AverageExpression(i6, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i6$gene <- rownames(avg.i6)

m1 <- subset(data, subset=(Cluster0.25=="MSC.c1" & Species=="Human"))
Idents(m1) <- "m1"
avg.m1 <- log1p(AverageExpression(m1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.m1$gene <- rownames(avg.m1)

m2 <- subset(data, subset=(Cluster0.25=="MSC.c2" & Species=="Human"))
Idents(m2) <- "m2"
avg.m2 <- log1p(AverageExpression(m2, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.m2$gene <- rownames(avg.m2)

m3 <- subset(data, subset=(Cluster0.25=="MSC.c3" & Species=="Human"))
Idents(m3) <- "m3"
avg.m3 <- log1p(AverageExpression(m3, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.m3$gene <- rownames(avg.m3)

o1 <- subset(data, subset=(Cluster0.25=="Osteogenic.c1" & Species=="Human"))
Idents(o1) <- "o1"
avg.o1 <- log1p(AverageExpression(o1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.o1$gene <- rownames(avg.o1)

o2 <- subset(data, subset=(Cluster0.25=="Osteogenic.c2" & Species=="Human"))
Idents(o2) <- "o2"
avg.o2 <- log1p(AverageExpression(o2, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.o2$gene <- rownames(avg.o2)

o3 <- subset(data, subset=(Cluster0.25=="Osteogenic.c3" & Species=="Human"))
Idents(o3) <- "o3"
avg.o3 <- log1p(AverageExpression(o3, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.o3$gene <- rownames(avg.o3)

avg <- merge(avg.i1,
             merge(avg.i2, 
                   merge(avg.i3,
                         merge(avg.i4,
                               merge(avg.i5,
                                     merge(avg.i6,
                                           merge(avg.m1,
                                                 merge(avg.m2,
                                                       merge(avg.m3,
                                                             merge(avg.o1,
                                                                   merge(avg.o2, avg.o3, by="gene"),
                                                                   by="gene"),
                                                             by="gene"),
                                                       by="gene"),
                                                 by="gene"),
                                           by="gene"),
                                     by="gene"),
                               by="gene"),
                         by="gene"),
                   by="gene"),
             by="gene")

ggpairs(avg,
        columns=2:length(colnames(avg)),
        columnLabels=c("iPSC.c1",
                       "iPSC.c2",
                       "iPSC.c3",
                       "iPSC.c4",
                       "iPSC.c5",
                       "iPSC.c6",
                       "MSC.c1",
                       "MSC.c2",
                       "MSC.c3",
                       "Osteogenic.c1",
                       "Osteogenic.c2",
                       "Osteogenic.c3"),
        mapping=ggplot2::aes(alpha=0.5))

rm(i1,i2,i3,i4,i5,i6,m1,m2,m3,o1,o2,o3)
rm(avg.i1,avg.i2,avg.i3,avg.i4,avg.i5,avg.i6,avg.m1,avg.m2,avg.m3,avg.o1,avg.o2,avg.o3)
rm(avg)

```

Look at chimps separately.

```{r}

i1 <- subset(data, subset=(Cluster0.25=="iPSC.c1" & Species=="Chimp"))
Idents(i1) <- "i1"
avg.i1 <- log1p(AverageExpression(i1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i1$gene <- rownames(avg.i1)

i2 <- subset(data, subset=(Cluster0.25=="iPSC.c2" & Species=="Chimp"))
Idents(i2) <- "i2"
avg.i2 <- log1p(AverageExpression(i2, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i2$gene <- rownames(avg.i2)

i3 <- subset(data, subset=(Cluster0.25=="iPSC.c3" & Species=="Chimp"))
Idents(i3) <- "i3"
avg.i3 <- log1p(AverageExpression(i3, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i3$gene <- rownames(avg.i3)

i4 <- subset(data, subset=(Cluster0.25=="iPSC.c4" & Species=="Chimp"))
Idents(i4) <- "i4"
avg.i4 <- log1p(AverageExpression(i4, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i4$gene <- rownames(avg.i4)

i5 <- subset(data, subset=(Cluster0.25=="iPSC.c5" & Species=="Chimp"))
Idents(i5) <- "i5"
avg.i5 <- log1p(AverageExpression(i5, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i5$gene <- rownames(avg.i5)

i6 <- subset(data, subset=(Cluster0.25=="iPSC.c6" & Species=="Chimp"))
Idents(i6) <- "i6"
avg.i6 <- log1p(AverageExpression(i6, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i6$gene <- rownames(avg.i6)

m1 <- subset(data, subset=(Cluster0.25=="MSC.c1" & Species=="Chimp"))
Idents(m1) <- "m1"
avg.m1 <- log1p(AverageExpression(m1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.m1$gene <- rownames(avg.m1)

m2 <- subset(data, subset=(Cluster0.25=="MSC.c2" & Species=="Chimp"))
Idents(m2) <- "m2"
avg.m2 <- log1p(AverageExpression(m2, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.m2$gene <- rownames(avg.m2)

m3 <- subset(data, subset=(Cluster0.25=="MSC.c3" & Species=="Chimp"))
Idents(m3) <- "m3"
avg.m3 <- log1p(AverageExpression(m3, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.m3$gene <- rownames(avg.m3)

o1 <- subset(data, subset=(Cluster0.25=="Osteogenic.c1" & Species=="Chimp"))
Idents(o1) <- "o1"
avg.o1 <- log1p(AverageExpression(o1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.o1$gene <- rownames(avg.o1)

o2 <- subset(data, subset=(Cluster0.25=="Osteogenic.c2" & Species=="Chimp"))
Idents(o2) <- "o2"
avg.o2 <- log1p(AverageExpression(o2, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.o2$gene <- rownames(avg.o2)

o3 <- subset(data, subset=(Cluster0.25=="Osteogenic.c3" & Species=="Chimp"))
Idents(o3) <- "o3"
avg.o3 <- log1p(AverageExpression(o3, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.o3$gene <- rownames(avg.o3)

avg <- merge(avg.i1,
             merge(avg.i2, 
                   merge(avg.i3,
                         merge(avg.i4,
                               merge(avg.i5,
                                     merge(avg.i6,
                                           merge(avg.m1,
                                                 merge(avg.m2,
                                                       merge(avg.m3,
                                                             merge(avg.o1,
                                                                   merge(avg.o2, avg.o3, by="gene"),
                                                                   by="gene"),
                                                             by="gene"),
                                                       by="gene"),
                                                 by="gene"),
                                           by="gene"),
                                     by="gene"),
                               by="gene"),
                         by="gene"),
                   by="gene"),
             by="gene")

ggpairs(avg,
        columns=2:length(colnames(avg)),
        columnLabels=c("iPSC.c1",
                       "iPSC.c2",
                       "iPSC.c3",
                       "iPSC.c4",
                       "iPSC.c5",
                       "iPSC.c6",
                       "MSC.c1",
                       "MSC.c2",
                       "MSC.c3",
                       "Osteogenic.c1",
                       "Osteogenic.c2",
                       "Osteogenic.c3"),
        mapping=ggplot2::aes(alpha=0.5))

rm(i1,i2,i3,i4,i5,i6,m1,m2,m3,o1,o2,o3)
rm(avg.i1,avg.i2,avg.i3,avg.i4,avg.i5,avg.i6,avg.m1,avg.m2,avg.m3,avg.o1,avg.o2,avg.o3)
rm(avg)

```

#### Resolution=0.50

Keep human and chimp samples together.

```{r}

i1 <- subset(data, subset=(Cluster0.50=="iPSC.c1"))
Idents(i1) <- "i1"
avg.i1 <- log1p(AverageExpression(i1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i1$gene <- rownames(avg.i1)

i2 <- subset(data, subset=(Cluster0.50=="iPSC.c2"))
Idents(i2) <- "i2"
avg.i2 <- log1p(AverageExpression(i2, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i2$gene <- rownames(avg.i2)

i3 <- subset(data, subset=(Cluster0.50=="iPSC.c3"))
Idents(i3) <- "i3"
avg.i3 <- log1p(AverageExpression(i3, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i3$gene <- rownames(avg.i3)

i4 <- subset(data, subset=(Cluster0.50=="iPSC.c4"))
Idents(i4) <- "i4"
avg.i4 <- log1p(AverageExpression(i4, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i4$gene <- rownames(avg.i4)

i5 <- subset(data, subset=(Cluster0.50=="iPSC.c5"))
Idents(i5) <- "i5"
avg.i5 <- log1p(AverageExpression(i5, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i5$gene <- rownames(avg.i5)

i6 <- subset(data, subset=(Cluster0.50=="iPSC.c6"))
Idents(i6) <- "i6"
avg.i6 <- log1p(AverageExpression(i6, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i6$gene <- rownames(avg.i6)

i7 <- subset(data, subset=(Cluster0.50=="iPSC.c7"))
Idents(i7) <- "i7"
avg.i7 <- log1p(AverageExpression(i7, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i7$gene <- rownames(avg.i7)

i8 <- subset(data, subset=(Cluster0.50=="iPSC.c8"))
Idents(i8) <- "i8"
avg.i8 <- log1p(AverageExpression(i8, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i8$gene <- rownames(avg.i8)

m1 <- subset(data, subset=(Cluster0.50=="MSC.c1"))
Idents(m1) <- "m1"
avg.m1 <- log1p(AverageExpression(m1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.m1$gene <- rownames(avg.m1)

m2 <- subset(data, subset=(Cluster0.50=="MSC.c2"))
Idents(m2) <- "m2"
avg.m2 <- log1p(AverageExpression(m2, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.m2$gene <- rownames(avg.m2)

m3 <- subset(data, subset=(Cluster0.50=="MSC.c3"))
Idents(m3) <- "m3"
avg.m3 <- log1p(AverageExpression(m3, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.m3$gene <- rownames(avg.m3)

m4 <- subset(data, subset=(Cluster0.50=="MSC.c4"))
Idents(m4) <- "m4"
avg.m4 <- log1p(AverageExpression(m4, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.m4$gene <- rownames(avg.m4)

o1 <- subset(data, subset=(Cluster0.50=="Osteogenic.c1"))
Idents(o1) <- "o1"
avg.o1 <- log1p(AverageExpression(o1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.o1$gene <- rownames(avg.o1)

o2 <- subset(data, subset=(Cluster0.50=="Osteogenic.c2"))
Idents(o2) <- "o2"
avg.o2 <- log1p(AverageExpression(o2, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.o2$gene <- rownames(avg.o2)

o3 <- subset(data, subset=(Cluster0.50=="Osteogenic.c3"))
Idents(o3) <- "o3"
avg.o3 <- log1p(AverageExpression(o3, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.o3$gene <- rownames(avg.o3)

o4 <- subset(data, subset=(Cluster0.50=="Osteogenic.c4"))
Idents(o4) <- "o4"
avg.o4 <- log1p(AverageExpression(o4, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.o4$gene <- rownames(avg.o4)

avg <- merge(avg.i1,
             merge(avg.i2, 
                   merge(avg.i3,
                         merge(avg.i4,
                               merge(avg.i5,
                                     merge(avg.i6,
                                           merge(avg.i7,
                                                 merge(avg.i8,
                                                       merge(avg.m1,
                                                             merge(avg.m2,
                                                                   merge(avg.m3,
                                                                         merge(avg.m4,
                                                                               merge(avg.o1,
                                                                                     merge(avg.o2,
                                                                                           merge(avg.o3, avg.o4, by="gene"),
                                                                                           by="gene"),
                                                                                     by="gene"),
                                                                               by="gene"),
                                                                         by="gene"),
                                                                   by="gene"),
                                                             by="gene"),
                                                       by="gene"),
                                                 by="gene"),
                                           by="gene"),
                                     by="gene"),
                               by="gene"),
                         by="gene"),
                   by="gene"),
             by="gene")

ggpairs(avg,
        columns=2:length(colnames(avg)),
        columnLabels=c("iPSC.c1",
                       "iPSC.c2",
                       "iPSC.c3",
                       "iPSC.c4",
                       "iPSC.c5",
                       "iPSC.c6",
                       "iPSC.c7",
                       "iPSC.c8",
                       "MSC.c1",
                       "MSC.c2",
                       "MSC.c3",
                       "MSC.c4",
                       "Osteogenic.c1",
                       "Osteogenic.c2",
                       "Osteogenic.c3",
                       "Osteogenic.c4"),
        mapping=ggplot2::aes(alpha=0.5))

rm(i1,i2,i3,i4,i5,i6,i7,i8,m1,m2,m3,m4,o1,o2,o3,o4)
rm(avg.i1,avg.i2,avg.i3,avg.i4,avg.i5,avg.i6,avg.i7,avg.i8,avg.m1,avg.m2,avg.m3,avg.m4,avg.o1,avg.o2,avg.o3,avg.o4)
rm(avg)

```

Look at humans separately.

```{r}

i1 <- subset(data, subset=(Cluster0.50=="iPSC.c1" & Species=="Human"))
Idents(i1) <- "i1"
avg.i1 <- log1p(AverageExpression(i1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i1$gene <- rownames(avg.i1)

i2 <- subset(data, subset=(Cluster0.50=="iPSC.c2" & Species=="Human"))
Idents(i2) <- "i2"
avg.i2 <- log1p(AverageExpression(i2, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i2$gene <- rownames(avg.i2)

i3 <- subset(data, subset=(Cluster0.50=="iPSC.c3" & Species=="Human"))
Idents(i3) <- "i3"
avg.i3 <- log1p(AverageExpression(i3, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i3$gene <- rownames(avg.i3)

i4 <- subset(data, subset=(Cluster0.50=="iPSC.c4" & Species=="Human"))
Idents(i4) <- "i4"
avg.i4 <- log1p(AverageExpression(i4, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i4$gene <- rownames(avg.i4)

i5 <- subset(data, subset=(Cluster0.50=="iPSC.c5" & Species=="Human"))
Idents(i5) <- "i5"
avg.i5 <- log1p(AverageExpression(i5, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i5$gene <- rownames(avg.i5)

i6 <- subset(data, subset=(Cluster0.50=="iPSC.c6" & Species=="Human"))
Idents(i6) <- "i6"
avg.i6 <- log1p(AverageExpression(i6, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i6$gene <- rownames(avg.i6)

i7 <- subset(data, subset=(Cluster0.50=="iPSC.c7" & Species=="Human"))
Idents(i7) <- "i7"
avg.i7 <- log1p(AverageExpression(i7, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i7$gene <- rownames(avg.i7)

i8 <- subset(data, subset=(Cluster0.50=="iPSC.c8" & Species=="Human"))
Idents(i8) <- "i8"
avg.i8 <- log1p(AverageExpression(i8, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i8$gene <- rownames(avg.i8)

m1 <- subset(data, subset=(Cluster0.50=="MSC.c1" & Species=="Human"))
Idents(m1) <- "m1"
avg.m1 <- log1p(AverageExpression(m1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.m1$gene <- rownames(avg.m1)

m2 <- subset(data, subset=(Cluster0.50=="MSC.c2" & Species=="Human"))
Idents(m2) <- "m2"
avg.m2 <- log1p(AverageExpression(m2, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.m2$gene <- rownames(avg.m2)

m3 <- subset(data, subset=(Cluster0.50=="MSC.c3" & Species=="Human"))
Idents(m3) <- "m3"
avg.m3 <- log1p(AverageExpression(m3, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.m3$gene <- rownames(avg.m3)

m4 <- subset(data, subset=(Cluster0.50=="MSC.c4" & Species=="Human"))
Idents(m4) <- "m4"
avg.m4 <- log1p(AverageExpression(m4, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.m4$gene <- rownames(avg.m4)

o1 <- subset(data, subset=(Cluster0.50=="Osteogenic.c1" & Species=="Human"))
Idents(o1) <- "o1"
avg.o1 <- log1p(AverageExpression(o1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.o1$gene <- rownames(avg.o1)

o2 <- subset(data, subset=(Cluster0.50=="Osteogenic.c2" & Species=="Human"))
Idents(o2) <- "o2"
avg.o2 <- log1p(AverageExpression(o2, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.o2$gene <- rownames(avg.o2)

o3 <- subset(data, subset=(Cluster0.50=="Osteogenic.c3" & Species=="Human"))
Idents(o3) <- "o3"
avg.o3 <- log1p(AverageExpression(o3, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.o3$gene <- rownames(avg.o3)

o4 <- subset(data, subset=(Cluster0.50=="Osteogenic.c4" & Species=="Human"))
Idents(o4) <- "o4"
avg.o4 <- log1p(AverageExpression(o4, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.o4$gene <- rownames(avg.o4)

avg <- merge(avg.i1,
             merge(avg.i2, 
                   merge(avg.i3,
                         merge(avg.i4,
                               merge(avg.i5,
                                     merge(avg.i6,
                                           merge(avg.i7,
                                                 merge(avg.i8,
                                                       merge(avg.m1,
                                                             merge(avg.m2,
                                                                   merge(avg.m3,
                                                                         merge(avg.m4,
                                                                               merge(avg.o1,
                                                                                     merge(avg.o2,
                                                                                           merge(avg.o3, avg.o4, by="gene"),
                                                                                           by="gene"),
                                                                                     by="gene"),
                                                                               by="gene"),
                                                                         by="gene"),
                                                                   by="gene"),
                                                             by="gene"),
                                                       by="gene"),
                                                 by="gene"),
                                           by="gene"),
                                     by="gene"),
                               by="gene"),
                         by="gene"),
                   by="gene"),
             by="gene")

ggpairs(avg,
        columns=2:length(colnames(avg)),
        columnLabels=c("iPSC.c1",
                       "iPSC.c2",
                       "iPSC.c3",
                       "iPSC.c4",
                       "iPSC.c5",
                       "iPSC.c6",
                       "iPSC.c7",
                       "iPSC.c8",
                       "MSC.c1",
                       "MSC.c2",
                       "MSC.c3",
                       "MSC.c4",
                       "Osteogenic.c1",
                       "Osteogenic.c2",
                       "Osteogenic.c3",
                       "Osteogenic.c4"),
        mapping=ggplot2::aes(alpha=0.5))

rm(i1,i2,i3,i4,i5,i6,i7,i8,m1,m2,m3,m4,o1,o2,o3,o4)
rm(avg.i1,avg.i2,avg.i3,avg.i4,avg.i5,avg.i6,avg.i7,avg.i8,avg.m1,avg.m2,avg.m3,avg.m4,avg.o1,avg.o2,avg.o3,avg.o4)
rm(avg)

```

Look at chimps separately.

```{r}

i1 <- subset(data, subset=(Cluster0.50=="iPSC.c1" & Species=="Chimp"))
Idents(i1) <- "i1"
avg.i1 <- log1p(AverageExpression(i1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i1$gene <- rownames(avg.i1)

i2 <- subset(data, subset=(Cluster0.50=="iPSC.c2" & Species=="Chimp"))
Idents(i2) <- "i2"
avg.i2 <- log1p(AverageExpression(i2, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i2$gene <- rownames(avg.i2)

i3 <- subset(data, subset=(Cluster0.50=="iPSC.c3" & Species=="Chimp"))
Idents(i3) <- "i3"
avg.i3 <- log1p(AverageExpression(i3, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i3$gene <- rownames(avg.i3)

i4 <- subset(data, subset=(Cluster0.50=="iPSC.c4" & Species=="Chimp"))
Idents(i4) <- "i4"
avg.i4 <- log1p(AverageExpression(i4, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i4$gene <- rownames(avg.i4)

i5 <- subset(data, subset=(Cluster0.50=="iPSC.c5" & Species=="Chimp"))
Idents(i5) <- "i5"
avg.i5 <- log1p(AverageExpression(i5, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i5$gene <- rownames(avg.i5)

i6 <- subset(data, subset=(Cluster0.50=="iPSC.c6" & Species=="Chimp"))
Idents(i6) <- "i6"
avg.i6 <- log1p(AverageExpression(i6, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i6$gene <- rownames(avg.i6)

i7 <- subset(data, subset=(Cluster0.50=="iPSC.c7" & Species=="Chimp"))
Idents(i7) <- "i7"
avg.i7 <- log1p(AverageExpression(i7, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i7$gene <- rownames(avg.i7)

i8 <- subset(data, subset=(Cluster0.50=="iPSC.c8" & Species=="Chimp"))
Idents(i8) <- "i8"
avg.i8 <- log1p(AverageExpression(i8, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.i8$gene <- rownames(avg.i8)

m1 <- subset(data, subset=(Cluster0.50=="MSC.c1" & Species=="Chimp"))
Idents(m1) <- "m1"
avg.m1 <- log1p(AverageExpression(m1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.m1$gene <- rownames(avg.m1)

m2 <- subset(data, subset=(Cluster0.50=="MSC.c2" & Species=="Chimp"))
Idents(m2) <- "m2"
avg.m2 <- log1p(AverageExpression(m2, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.m2$gene <- rownames(avg.m2)

m3 <- subset(data, subset=(Cluster0.50=="MSC.c3" & Species=="Chimp"))
Idents(m3) <- "m3"
avg.m3 <- log1p(AverageExpression(m3, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.m3$gene <- rownames(avg.m3)

m4 <- subset(data, subset=(Cluster0.50=="MSC.c4" & Species=="Chimp"))
Idents(m4) <- "m4"
avg.m4 <- log1p(AverageExpression(m4, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.m4$gene <- rownames(avg.m4)

o1 <- subset(data, subset=(Cluster0.50=="Osteogenic.c1" & Species=="Chimp"))
Idents(o1) <- "o1"
avg.o1 <- log1p(AverageExpression(o1, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.o1$gene <- rownames(avg.o1)

o2 <- subset(data, subset=(Cluster0.50=="Osteogenic.c2" & Species=="Chimp"))
Idents(o2) <- "o2"
avg.o2 <- log1p(AverageExpression(o2, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.o2$gene <- rownames(avg.o2)

o3 <- subset(data, subset=(Cluster0.50=="Osteogenic.c3" & Species=="Chimp"))
Idents(o3) <- "o3"
avg.o3 <- log1p(AverageExpression(o3, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.o3$gene <- rownames(avg.o3)

o4 <- subset(data, subset=(Cluster0.50=="Osteogenic.c4" & Species=="Chimp"))
Idents(o4) <- "o4"
avg.o4 <- log1p(AverageExpression(o4, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.o4$gene <- rownames(avg.o4)

avg <- merge(avg.i1,
             merge(avg.i2, 
                   merge(avg.i3,
                         merge(avg.i4,
                               merge(avg.i5,
                                     merge(avg.i6,
                                           merge(avg.i7,
                                                 merge(avg.i8,
                                                       merge(avg.m1,
                                                             merge(avg.m2,
                                                                   merge(avg.m3,
                                                                         merge(avg.m4,
                                                                               merge(avg.o1,
                                                                                     merge(avg.o2,
                                                                                           merge(avg.o3, avg.o4, by="gene"),
                                                                                           by="gene"),
                                                                                     by="gene"),
                                                                               by="gene"),
                                                                         by="gene"),
                                                                   by="gene"),
                                                             by="gene"),
                                                       by="gene"),
                                                 by="gene"),
                                           by="gene"),
                                     by="gene"),
                               by="gene"),
                         by="gene"),
                   by="gene"),
             by="gene")

ggpairs(avg,
        columns=2:length(colnames(avg)),
        columnLabels=c("iPSC.c1",
                       "iPSC.c2",
                       "iPSC.c3",
                       "iPSC.c4",
                       "iPSC.c5",
                       "iPSC.c6",
                       "iPSC.c7",
                       "iPSC.c8",
                       "MSC.c1",
                       "MSC.c2",
                       "MSC.c3",
                       "MSC.c4",
                       "Osteogenic.c1",
                       "Osteogenic.c2",
                       "Osteogenic.c3",
                       "Osteogenic.c4"),
        mapping=ggplot2::aes(alpha=0.5))

rm(i1,i2,i3,i4,i5,i6,i7,i8,m1,m2,m3,m4,o1,o2,o3,o4)
rm(avg.i1,avg.i2,avg.i3,avg.i4,avg.i5,avg.i6,avg.i7,avg.i8,avg.m1,avg.m2,avg.m3,avg.m4,avg.o1,avg.o2,avg.o3,avg.o4)
rm(avg)

```

## Grades of Membership

### Plots
Make plots of cell classification findings.

#### K=3

```{r}

#Read fastTopics data
fit <- readRDS(paste0("./data/gom-data/topics3.data.filterC.log.indv-cell.intNo0.reg-tot.bc1.rds"))

#Compute omega (weights, cells x k)
l <- fit$L
f <- fit$F
omega <- sweep(l, MARGIN=2, colSums(f), `*`)
omega <- omega / rowSums(omega)

#Create labels
labels <- sapply(strsplit(rownames(omega),"_"), `[`, 1)
celltype <- labels
celltype[celltype %in% c("C1.I","C1r2.I","C2.I","C3.I","C4.I","C5.I","C6.I")] <- "Chimp\nTime 0"
celltype[celltype %in% c("C1.M","C1r2.M","C2.M","C3.M","C4.M","C5.M","C6.M")] <- "Chimp\nTime 1"
celltype[celltype %in% c("C1.O","C1r2.O","C2.O","C3.O","C4.O","C5.O","C6.O")] <- "Chimp\nTime 2"
celltype[celltype %in% c("H1.I","H1r2.I","H2.I","H3.I","H4.I","H5.I","H6.I")] <- "Human\nTime 0"
celltype[celltype %in% c("H1.M","H1r2.M","H2.M","H3.M","H4.M","H5.M","H6.M")] <- "Human\nTime 1"
celltype[celltype %in% c("H1.O","H1r2.O","H2.O","H3.O","H4.O","H5.O","H6.O")] <- "Human\nTime 2"
annotation <- data.frame(sample_id=paste0("X", c(1:NROW(omega))), tissue_label=as.factor(celltype))

#Define colors
colclust <- c("pink","mediumorchid","dodgerblue")

#Reorder k
omega <- omega[,c(3,1,2)]

#Structure plots
rownames(omega) <- annotation$sample_id
CountClust::StructureGGplot(omega=omega,
                            annotation=annotation,
                            palette=colclust,
                            yaxis_label="Species",
                            order_sample=TRUE,
                            axis_tick=list(axis_ticks_length=0.1,
                                           axis_ticks_lwd_y=0.1,
                                           axis_ticks_lwd_x=0.1,
                                           axis_label_size=10,
                                           axis_label_face="bold"),
                            legend_text_size=0,
                            legend_key_size=1,
                            legend_title_size=0)

rm(fit,l,f,omega,labels,celltype,annotation,colclust)

```

#### K=4

```{r}

#Read fastTopics data
fit <- readRDS(paste0("./data/gom-data/topics4.data.filterC.log.indv-cell.intNo0.reg-tot.bc1.rds"))

#Compute omega (weights, cells x k)
l <- fit$L
f <- fit$F
omega <- sweep(l, MARGIN=2, colSums(f), `*`)
omega <- omega / rowSums(omega)

#Create labels
labels <- sapply(strsplit(rownames(omega),"_"), `[`, 1)
celltype <- labels
celltype[celltype %in% c("C1.I","C1r2.I","C2.I","C3.I","C4.I","C5.I","C6.I")] <- "Chimp\nTime 0"
celltype[celltype %in% c("C1.M","C1r2.M","C2.M","C3.M","C4.M","C5.M","C6.M")] <- "Chimp\nTime 1"
celltype[celltype %in% c("C1.O","C1r2.O","C2.O","C3.O","C4.O","C5.O","C6.O")] <- "Chimp\nTime 2"
celltype[celltype %in% c("H1.I","H1r2.I","H2.I","H3.I","H4.I","H5.I","H6.I")] <- "Human\nTime 0"
celltype[celltype %in% c("H1.M","H1r2.M","H2.M","H3.M","H4.M","H5.M","H6.M")] <- "Human\nTime 1"
celltype[celltype %in% c("H1.O","H1r2.O","H2.O","H3.O","H4.O","H5.O","H6.O")] <- "Human\nTime 2"
annotation <- data.frame(sample_id=paste0("X", c(1:NROW(omega))), tissue_label=as.factor(celltype))

#Define colors
colclust <- c("pink","mediumorchid","orchid4","dodgerblue")

#Reorder k
omega <- omega[,c(4,2,3,1)]

#Structure plots
rownames(omega) <- annotation$sample_id
CountClust::StructureGGplot(omega=omega,
                            annotation=annotation,
                            palette=colclust,
                            yaxis_label="Species",
                            order_sample=TRUE,
                            axis_tick=list(axis_ticks_length=0.1,
                                           axis_ticks_lwd_y=0.1,
                                           axis_ticks_lwd_x=0.1,
                                           axis_label_size=10,
                                           axis_label_face="bold"),
                            legend_text_size=0,
                            legend_key_size=1,
                            legend_title_size=0)

rm(fit,l,f,omega,labels,celltype,annotation,colclust)

```

#### K=5

```{r}

#Read fastTopics data
fit <- readRDS(paste0("./data/gom-data/topics5.data.filterC.log.indv-cell.intNo0.reg-tot.bc1.rds"))

#Compute omega (weights, cells x k)
l <- fit$L
f <- fit$F
omega <- sweep(l, MARGIN=2, colSums(f), `*`)
omega <- omega / rowSums(omega)

#Create labels
labels <- sapply(strsplit(rownames(omega),"_"), `[`, 1)
celltype <- labels
celltype[celltype %in% c("C1.I","C1r2.I","C2.I","C3.I","C4.I","C5.I","C6.I")] <- "Chimp\nTime 0"
celltype[celltype %in% c("C1.M","C1r2.M","C2.M","C3.M","C4.M","C5.M","C6.M")] <- "Chimp\nTime 1"
celltype[celltype %in% c("C1.O","C1r2.O","C2.O","C3.O","C4.O","C5.O","C6.O")] <- "Chimp\nTime 2"
celltype[celltype %in% c("H1.I","H1r2.I","H2.I","H3.I","H4.I","H5.I","H6.I")] <- "Human\nTime 0"
celltype[celltype %in% c("H1.M","H1r2.M","H2.M","H3.M","H4.M","H5.M","H6.M")] <- "Human\nTime 1"
celltype[celltype %in% c("H1.O","H1r2.O","H2.O","H3.O","H4.O","H5.O","H6.O")] <- "Human\nTime 2"
annotation <- data.frame(sample_id=paste0("X", c(1:NROW(omega))), tissue_label=as.factor(celltype))

#Define colors
colclust <- c("pink","pink4","mediumorchid","orchid4","dodgerblue")

#Reorder k
omega <- omega[,c(4,3,2,5,1)]

#Structure plots
rownames(omega) <- annotation$sample_id
CountClust::StructureGGplot(omega=omega,
                            annotation=annotation,
                            palette=colclust,
                            yaxis_label="Species",
                            order_sample=TRUE,
                            axis_tick=list(axis_ticks_length=0.1,
                                           axis_ticks_lwd_y=0.1,
                                           axis_ticks_lwd_x=0.1,
                                           axis_label_size=10,
                                           axis_label_face="bold"),
                            legend_text_size=0,
                            legend_key_size=1,
                            legend_title_size=0)

rm(fit,l,f,omega,labels,celltype,annotation,colclust)

```

#### K=6

```{r}

#Read fastTopics data
fit <- readRDS(paste0("./data/gom-data/topics6.data.filterC.log.indv-cell.intNo0.reg-tot.bc1.rds"))

#Compute omega (weights, cells x k)
l <- fit$L
f <- fit$F
omega <- sweep(l, MARGIN=2, colSums(f), `*`)
omega <- omega / rowSums(omega)

#Create labels
labels <- sapply(strsplit(rownames(omega),"_"), `[`, 1)
celltype <- labels
celltype[celltype %in% c("C1.I","C1r2.I","C2.I","C3.I","C4.I","C5.I","C6.I")] <- "Chimp\nTime 0"
celltype[celltype %in% c("C1.M","C1r2.M","C2.M","C3.M","C4.M","C5.M","C6.M")] <- "Chimp\nTime 1"
celltype[celltype %in% c("C1.O","C1r2.O","C2.O","C3.O","C4.O","C5.O","C6.O")] <- "Chimp\nTime 2"
celltype[celltype %in% c("H1.I","H1r2.I","H2.I","H3.I","H4.I","H5.I","H6.I")] <- "Human\nTime 0"
celltype[celltype %in% c("H1.M","H1r2.M","H2.M","H3.M","H4.M","H5.M","H6.M")] <- "Human\nTime 1"
celltype[celltype %in% c("H1.O","H1r2.O","H2.O","H3.O","H4.O","H5.O","H6.O")] <- "Human\nTime 2"
annotation <- data.frame(sample_id=paste0("X", c(1:NROW(omega))), tissue_label=as.factor(celltype))

#Define colors
colclust <- c("pink","pink4","mediumorchid","orchid4","dodgerblue","grey")

#Reorder k
omega <- omega[,c(3,2,5,6,4,1)]

#Structure plots
rownames(omega) <- annotation$sample_id
CountClust::StructureGGplot(omega=omega,
                            annotation=annotation,
                            palette=colclust,
                            yaxis_label="Species",
                            order_sample=TRUE,
                            axis_tick=list(axis_ticks_length=0.1,
                                           axis_ticks_lwd_y=0.1,
                                           axis_ticks_lwd_x=0.1,
                                           axis_label_size=10,
                                           axis_label_face="bold"),
                            legend_text_size=0,
                            legend_key_size=1,
                            legend_title_size=0)

rm(fit,l,f,omega,labels,celltype,annotation,colclust)

```

#### K=7

```{r}

#Read fastTopics data
fit <- readRDS(paste0("./data/gom-data/topics7.data.filterC.log.indv-cell.intNo0.reg-tot.bc1.rds"))

#Compute omega (weights, cells x k)
l <- fit$L
f <- fit$F
omega <- sweep(l, MARGIN=2, colSums(f), `*`)
omega <- omega / rowSums(omega)

#Create labels
labels <- sapply(strsplit(rownames(omega),"_"), `[`, 1)
celltype <- labels
celltype[celltype %in% c("C1.I","C1r2.I","C2.I","C3.I","C4.I","C5.I","C6.I")] <- "Chimp\nTime 0"
celltype[celltype %in% c("C1.M","C1r2.M","C2.M","C3.M","C4.M","C5.M","C6.M")] <- "Chimp\nTime 1"
celltype[celltype %in% c("C1.O","C1r2.O","C2.O","C3.O","C4.O","C5.O","C6.O")] <- "Chimp\nTime 2"
celltype[celltype %in% c("H1.I","H1r2.I","H2.I","H3.I","H4.I","H5.I","H6.I")] <- "Human\nTime 0"
celltype[celltype %in% c("H1.M","H1r2.M","H2.M","H3.M","H4.M","H5.M","H6.M")] <- "Human\nTime 1"
celltype[celltype %in% c("H1.O","H1r2.O","H2.O","H3.O","H4.O","H5.O","H6.O")] <- "Human\nTime 2"
annotation <- data.frame(sample_id=paste0("X", c(1:NROW(omega))), tissue_label=as.factor(celltype))

#Define colors
colclust <- c("pink","pink4","mediumorchid","orchid4","dodgerblue1","dodgerblue4","grey")

#Reorder k
omega <- omega[,c(6,7,4,2,5,3,1)]

#Structure plots
rownames(omega) <- annotation$sample_id
CountClust::StructureGGplot(omega=omega,
                            annotation=annotation,
                            palette=colclust,
                            yaxis_label="Species",
                            order_sample=TRUE,
                            axis_tick=list(axis_ticks_length=0.1,
                                           axis_ticks_lwd_y=0.1,
                                           axis_ticks_lwd_x=0.1,
                                           axis_label_size=10,
                                           axis_label_face="bold"),
                            legend_text_size=0,
                            legend_key_size=1,
                            legend_title_size=0)

rm(fit,l,f,omega,labels,celltype,annotation,colclust)

```

### Enrichment
Assess GO functional enrichment of genes defining each topic.

#### K=3

```{r}

#Find top 100 markers, report only the positive ones
genes <- readRDS(paste0("./data/gom-data/topics3.100genes.data.filterC.log.indv-cell.intNo0.reg-tot.bc1.rds"))

#k3
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=genes[[1]][3,], ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="GoM(k=3) k3 Genes")

#k1
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=genes[[1]][1,], ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="GoM(k=3) k1 Genes")

#k2
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=genes[[1]][2,], ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="GoM(k=3) k2 Genes")

rm(genes,goTot)

```

#### K=4

```{r}

#Find top 100 markers, report only the positive ones
genes <- readRDS(paste0("./data/gom-data/topics4.100genes.data.filterC.log.indv-cell.intNo0.reg-tot.bc1.rds"))

#k4
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=genes[[1]][4,], ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="GoM(k=4) k4 Genes")

#k2
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=genes[[1]][2,], ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="GoM(k=4) k2 Genes")

#k3
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=genes[[1]][3,], ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="GoM(k=4) k3 Genes")

#k1
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=genes[[1]][1,], ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="GoM(k=4) k1 Genes")

rm(genes,goTot)

```

#### K=5

```{r}

#Find top 100 markers, report only the positive ones
genes <- readRDS(paste0("./data/gom-data/topics5.100genes.data.filterC.log.indv-cell.intNo0.reg-tot.bc1.rds"))

#k4
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=genes[[1]][4,], ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="GoM(k=5) k4 Genes")

#k3
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=genes[[1]][3,], ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="GoM(k=5) k3 Genes")

#k2
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=genes[[1]][2,], ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="GoM(k=5) k2 Genes")

#k5
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=genes[[1]][5,], ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="GoM(k=5) k5 Genes")

#k1
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=genes[[1]][1,], ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="GoM(k=5) k1 Genes")

rm(genes,goTot)

```

#### K=6

```{r}

#Find top 100 markers, report only the positive ones
genes <- readRDS(paste0("./data/gom-data/topics6.100genes.data.filterC.log.indv-cell.intNo0.reg-tot.bc1.rds"))

#k3
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=genes[[1]][3,], ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="GoM(k=6) k3 Genes")

#k2
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=genes[[1]][2,], ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="GoM(k=6) k2 Genes")

#k5
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=genes[[1]][5,], ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="GoM(k=6) k5 Genes")

#k6
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=genes[[1]][6,], ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="GoM(k=6) k6 Genes")

#k4
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=genes[[1]][4,], ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="GoM(k=6) k4 Genes")

#k1
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=genes[[1]][1,], ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="GoM(k=6) k1 Genes")

rm(genes,goTot)

```

#### K=7

```{r}

#Find top 100 markers, report only the positive ones
genes <- readRDS(paste0("./data/gom-data/topics7.100genes.data.filterC.log.indv-cell.intNo0.reg-tot.bc1.rds"))

#k6
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=genes[[1]][6,], ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="GoM(k=7) k6 Genes")

#k7
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=genes[[1]][7,], ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="GoM(k=7) k7 Genes")

#k4
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=genes[[1]][4,], ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="GoM(k=7) k4 Genes")

#k2
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=genes[[1]][2,], ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="GoM(k=7) k2 Genes")

#k5
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=genes[[1]][5,], ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="GoM(k=7) k5 Genes")

#k3
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=genes[[1]][3,], ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="GoM(k=7) k3 Genes")

#k1
#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=genes[[1]][1,], ontology="ALL")
goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
goEnPlot(goTot,title="GoM(k=7) k1 Genes")

rm(genes,goTot)

```

### Correlations
Visualize gene expression correlations across cell classifications not done because official cell classification were not made.

## General Ad Hoc

### Plots
Make plots of cell classification findings.

```{r}

#umap
DimPlot(data,
        group.by="AdHoc.Assign.thresh0",
        reduction="umap",
        cols=c("pink","mediumorchid","dodgerblue","grey")) +
  labs(x="UMAP1",y="UMAP2")
CombinePlots(plots=list((DimPlot(subset(data,subset=Species=="Chimp"),
                                 group.by="AdHoc.Assign.thresh0",
                                 reduction="umap",
                                 cols=c("pink","mediumorchid","dodgerblue","grey")) +
                           labs(x="UMAP1",y="UMAP2")),
                        (DimPlot(subset(data,subset=Species=="Human"),
                                 group.by="AdHoc.Assign.thresh0",
                                 reduction="umap",
                                 cols=c("pink","mediumorchid","dodgerblue","grey")) +
                           labs(x="UMAP1",y="UMAP2"))),
             legend="right",
             ncol=2)
CombinePlots(plots=list((DimPlot(subset(data,subset=Species=="Human"),
                                 group.by="Stage",
                                 split.by="AdHoc.Assign.thresh0",
                                 reduction="umap",
                                 cols=c("pink","mediumorchid","dodgerblue")) +
                           labs(x="UMAP1",y="UMAP2")),
                        (DimPlot(subset(data,subset=Species=="Chimp"),
                                 group.by="Stage",
                                 split.by="AdHoc.Assign.thresh0",
                                 reduction="umap",
                                 cols=c("pink","mediumorchid","dodgerblue")) +
                           labs(x="UMAP1",y="UMAP2"))), ncol=1)

#cell counts
ggplot(data@meta.data, aes(x=AdHoc.Assign.thresh0, fill=AdHoc.Assign.thresh0)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("pink","mediumorchid","dodgerblue","grey")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))

#umi counts
ggplot(data@meta.data, aes(x=AdHoc.Assign.thresh0, y=nCount_RNA, fill=AdHoc.Assign.thresh0)) +
  geom_violin(width=0.8) +
  labs(y="UMIs per Cell", x="") +
  scale_fill_manual(name="", values=c("pink","mediumorchid","dodgerblue","grey")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))

#gene counts
ggplot(data@meta.data, aes(x=AdHoc.Assign.thresh0, y=nFeature_RNA, fill=AdHoc.Assign.thresh0)) +
  geom_violin(width=0.8) +
  labs(y="Genes per Cell", x="") +
  scale_fill_manual(name="", values=c("pink","mediumorchid","dodgerblue","grey")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))

#marker genes
VlnPlot(data,
        features=c("POU5F1","CD44","COL1A1"),
        group.by="AdHoc.Assign.thresh0",
        cols=c("pink","mediumorchid","dodgerblue","grey"),
        pt.size=0)
DotPlot(subset(data,subset=Species=="Human"),
        features=c("COL1A1","CD44","POU5F1"),
        group.by="AdHoc.Assign.thresh0",
        dot.scale=20,
        cols=c("grey99","black"),
        col.max=5)
DotPlot(subset(data,subset=Species=="Chimp"),
        features=c("COL1A1","CD44","POU5F1"),
        group.by="AdHoc.Assign.thresh0",
        dot.scale=20,
        cols=c("grey99","black"),
        col.max=5)

```

### Enrichment
GO functional enrichment not assessed because classifications were determined based on candidate genes.

### Correlations (pseudobulk: sum)
Visualize gene expression correlations across cell classifications.

```{r}

# Compile log2 normalized gene expression data
#make count matrix and metadata for edgeR object - pseudobulk (pseudocounts, filter genes mean(log2cpm)>0)
cell.subset <- c("iPSC","MSC","Osteogenic","other")
counts <- c()
metadata <- c()
labels <- c()
for(j in cell.subset) {
  dataSub <- subset(data,subset=AdHoc.Assign.thresh0==j)
  for (i in unique(dataSub@meta.data$Individual.Replicate)) {
    x.lab <- paste0(i,"_",j)
    w <- which(dataSub@meta.data$Individual.Replicate==i)
    if (length(w)>0) {
      x.spp <- dataSub@meta.data$Species[w][1]
      x.col <- dataSub@meta.data$Collection[w][1]
      x.ind <- dataSub@meta.data$Individual[w][1]
      x.rep <- dataSub@meta.data$Replicate[w][1]
      x.idr <- dataSub@meta.data$Individual.Replicate[w][1]
      x.adh <- as.character(dataSub@meta.data$AdHoc.Assign.thresh0[w][1])
      if (length(w)==1) {
        x.cnt <- dataSub@assays$RNA@counts[,w]
      } else {
        x.cnt <- Matrix::rowSums(dataSub@assays$RNA@counts[,w])
      }
      counts <- cbind(counts, x.cnt)
      metadata <- rbind(metadata, c(x.lab, x.spp, x.col, x.ind, x.rep, x.idr, x.adh))
      labels <- c(labels, x.lab)
    }
  }
}
colnames(counts) <- labels
rownames(metadata) <- labels
colnames(metadata) <- c("Sample","Species","Collection","Individual","Replicate","Individual.Replicate","AdHoc")
metadata <- as.data.frame(metadata)
#remove mitochondrial and ribosomal genes
counts <- counts[which(rownames(counts) %in% genes.no.mito.ribo),]
#make edgeR object
dge <- DGEList(counts)
meta_dge <- dge$samples[,c("lib.size","norm.factors")]
meta_dge <- cbind(meta_dge, metadata)
dge$samples <- meta_dge
rm(counts,metadata,meta_dge)
#filter genes
keep <- rowMeans(edgeR::cpm(dge,log=TRUE,prior.count=0.25))>0
dge$counts <- dge$counts[keep,]
#normalize data
dge <- calcNormFactors(dge, method="TMM")
#log2 transformed cpm
tmm <- edgeR::cpm(dge,normalized.lib.sizes=TRUE,log=TRUE,prior.count=0.25)

rm(cell.subset,labels,dataSub,i,j,w,x.lab,x.spp,x.col,x.ind,x.rep,x.idr,x.stg,x.cnt,keep,dge)

```

Keep human and chimp samples together.

```{r}

avg <- data.frame("iPSC"=rowMeans(tmm[,1:14]),
                  "MSC"=rowMeans(tmm[,15:28]),
                  "Osteogenic"=rowMeans(tmm[,29:42]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:3,
        columnLabels=c("iPSC",
                       "MSC",
                       "Osteogenic"),
        mapping=ggplot2::aes(alpha=0.5))

```

Look at humans separately.

```{r}

avg <- data.frame("iPSC"=rowMeans(tmm[,1:7]),
                  "MSC"=rowMeans(tmm[,15:21]),
                  "Osteogenic"=rowMeans(tmm[,29:35]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:3,
        columnLabels=c("iPSC",
                       "MSC",
                       "Osteogenic"),
        mapping=ggplot2::aes(alpha=0.5))

```

Look at chimps separately.

```{r}

avg <- data.frame("iPSC"=rowMeans(tmm[,8:14]),
                  "MSC"=rowMeans(tmm[,22:28]),
                  "Osteogenic"=rowMeans(tmm[,36:42]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:3,
        columnLabels=c("iPSC",
                       "MSC",
                       "Osteogenic"),
        mapping=ggplot2::aes(alpha=0.5))

```

```{r}

rm(tmm,avg)

```

### Correlations (pseudobulk: average)
Visualize gene expression correlations across cell classifications.

Keep human and chimp samples together.

```{r}

ips <- subset(data, subset=(AdHoc.Assign.thresh0=="iPSC"))
Idents(ips) <- "ips"
avg.ips <- log1p(AverageExpression(ips, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.ips$gene <- rownames(avg.ips)

msc <- subset(data, subset=(AdHoc.Assign.thresh0=="MSC"))
Idents(msc) <- "msc"
avg.msc <- log1p(AverageExpression(msc, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.msc$gene <- rownames(avg.msc)

ost <- subset(data, subset=(AdHoc.Assign.thresh0=="Osteogenic"))
Idents(ost) <- "ost"
avg.ost <- log1p(AverageExpression(ost, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.ost$gene <- rownames(avg.ost)

nan <- subset(data, subset=(AdHoc.Assign.thresh0=="other"))
Idents(nan) <- "nan"
avg.nan <- log1p(AverageExpression(nan, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.nan$gene <- rownames(avg.nan)

avg <- merge(avg.ips,
             merge(avg.msc,
                   merge(avg.ost,
                         avg.nan,
                         by="gene"),
                   by="gene"),
             by="gene")

ggpairs(avg,
        columns=2:length(colnames(avg)),
        columnLabels=c("iPSC",
                       "MSC",
                       "Osteogenic",
                       "other"),
        mapping=ggplot2::aes(alpha=0.5))

ggpairs(avg,
        columns=2:4,
        columnLabels=c("iPSC",
                       "MSC",
                       "Osteogenic"),
        mapping=ggplot2::aes(alpha=0.5))

rm(ips,msc,ost,nan,avg.ips,avg.msc,avg.ost,avg.nan,avg)

```

Raw Data: Look at humans separately.

```{r}

ips <- subset(data, subset=(AdHoc.Assign.thresh0=="iPSC" & Species=="Human"))
Idents(ips) <- "ips"
avg.ips <- log1p(AverageExpression(ips, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.ips$gene <- rownames(avg.ips)

msc <- subset(data, subset=(AdHoc.Assign.thresh0=="MSC" & Species=="Human"))
Idents(msc) <- "msc"
avg.msc <- log1p(AverageExpression(msc, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.msc$gene <- rownames(avg.msc)

ost <- subset(data, subset=(AdHoc.Assign.thresh0=="Osteogenic" & Species=="Human"))
Idents(ost) <- "ost"
avg.ost <- log1p(AverageExpression(ost, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.ost$gene <- rownames(avg.ost)

nan <- subset(data, subset=(AdHoc.Assign.thresh0=="other" & Species=="Human"))
Idents(nan) <- "nan"
avg.nan <- log1p(AverageExpression(nan, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.nan$gene <- rownames(avg.nan)

avg <- merge(avg.ips,
             merge(avg.msc,
                   merge(avg.ost,
                         avg.nan,
                         by="gene"),
                   by="gene"),
             by="gene")

ggpairs(avg,
        columns=2:length(colnames(avg)),
        columnLabels=c("iPSC",
                       "MSC",
                       "Osteogenic",
                       "other"),
        mapping=ggplot2::aes(alpha=0.5))

ggpairs(avg,
        columns=2:4,
        columnLabels=c("iPSC",
                       "MSC",
                       "Osteogenic"),
        mapping=ggplot2::aes(alpha=0.5))

rm(ips,msc,ost,nan,avg.ips,avg.msc,avg.ost,avg.nan,avg)

```

Raw Data: Look at chimps separately.

```{r}

ips <- subset(data, subset=(AdHoc.Assign.thresh0=="iPSC" & Species=="Chimp"))
Idents(ips) <- "ips"
avg.ips <- log1p(AverageExpression(ips, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.ips$gene <- rownames(avg.ips)

msc <- subset(data, subset=(AdHoc.Assign.thresh0=="MSC" & Species=="Chimp"))
Idents(msc) <- "msc"
avg.msc <- log1p(AverageExpression(msc, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.msc$gene <- rownames(avg.msc)

ost <- subset(data, subset=(AdHoc.Assign.thresh0=="Osteogenic" & Species=="Chimp"))
Idents(ost) <- "ost"
avg.ost <- log1p(AverageExpression(ost, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.ost$gene <- rownames(avg.ost)

nan <- subset(data, subset=(AdHoc.Assign.thresh0=="other" & Species=="Chimp"))
Idents(nan) <- "nan"
avg.nan <- log1p(AverageExpression(nan, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.nan$gene <- rownames(avg.nan)

avg <- merge(avg.ips,
             merge(avg.msc,
                   merge(avg.ost,
                         avg.nan,
                         by="gene"),
                   by="gene"),
             by="gene")

ggpairs(avg,
        columns=2:length(colnames(avg)),
        columnLabels=c("iPSC",
                       "MSC",
                       "Osteogenic",
                       "other"),
        mapping=ggplot2::aes(alpha=0.5))

ggpairs(avg,
        columns=2:4,
        columnLabels=c("iPSC",
                       "MSC",
                       "Osteogenic"),
        mapping=ggplot2::aes(alpha=0.5))

rm(ips,msc,ost,nan,avg.ips,avg.msc,avg.ost,avg.nan,avg)

```

## Osteogenic Ad Hoc

### Plots
Make plots of cell classification findings.

#### 8 genes

Make nicer plots of osteogenic ad hoc assignments (8 gene, thresh0).

```{r}

#8 genes

#umap
DimPlot(data,
        group.by="OstAdHoc.Assign.8gene.thresh0",
        reduction="umap",
        cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  labs(x="UMAP1",y="UMAP2")
CombinePlots(plots=list((DimPlot(subset(data,subset=Species=="Chimp"),
                                 group.by="OstAdHoc.Assign.8gene.thresh0",
                                 reduction="umap",
                                 cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
                           labs(x="UMAP1",y="UMAP2")),
                        (DimPlot(subset(data,subset=Species=="Human"),
                                 group.by="OstAdHoc.Assign.8gene.thresh0",
                                 reduction="umap",
                                 cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
                           labs(x="UMAP1",y="UMAP2"))),
             legend="right",
             ncol=2)
CombinePlots(plots=list((DimPlot(subset(data,subset=Species=="Human"),
                                 group.by="Stage",
                                 split.by="OstAdHoc.Assign.8gene.thresh0",
                                 reduction="umap",
                                 cols=c("pink","mediumorchid","dodgerblue")) +
                           labs(x="UMAP1",y="UMAP2")),
                        (DimPlot(subset(data,subset=Species=="Chimp"),
                                 group.by="Stage",
                                 split.by="OstAdHoc.Assign.8gene.thresh0",
                                 reduction="umap",
                                 cols=c("pink","mediumorchid","dodgerblue")) +
                           labs(x="UMAP1",y="UMAP2"))), ncol=1)
DimPlot(data,
        group.by="OstAdHoc.Assign.8gene.thresh0",
        split.by="OstAdHoc.Assign.8gene.thresh0",
        reduction="umap",
        cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  labs(x="UMAP1",y="UMAP2")
DimPlot(subset(data,subset=Stage=="Time 2"),
        group.by="OstAdHoc.Assign.8gene.thresh0",
        split.by="OstAdHoc.Assign.8gene.thresh0",
        reduction="umap",
        cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  labs(x="UMAP1",y="UMAP2")

#cell counts
ggplot(data@meta.data, aes(x=OstAdHoc.Assign.8gene.thresh0, fill=OstAdHoc.Assign.8gene.thresh0)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$Stage=="Time 2"),], aes(x=OstAdHoc.Assign.8gene.thresh0, fill=OstAdHoc.Assign.8gene.thresh0)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$OstAdHoc.Assign.8gene.thresh0!="not osteogenic"),],
       aes(x=OstAdHoc.Assign.8gene.thresh0, fill=OstAdHoc.Assign.8gene.thresh0)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$Stage=="Time 2" & data@meta.data$OstAdHoc.Assign.8gene.thresh0!="not osteogenic"),],
       aes(x=OstAdHoc.Assign.8gene.thresh0, fill=OstAdHoc.Assign.8gene.thresh0)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))

#umi counts
ggplot(data@meta.data, aes(x=OstAdHoc.Assign.8gene.thresh0, y=nCount_RNA, fill=OstAdHoc.Assign.8gene.thresh0)) +
  geom_violin(width=0.8) +
  labs(y="UMIs per Cell", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$Stage=="Time 2"),], aes(x=OstAdHoc.Assign.8gene.thresh0, y=nCount_RNA, fill=OstAdHoc.Assign.8gene.thresh0)) +
  geom_violin(width=0.8) +
  labs(y="UMIs per Cell", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))

#gene counts
ggplot(data@meta.data, aes(x=OstAdHoc.Assign.8gene.thresh0, y=nFeature_RNA, fill=OstAdHoc.Assign.8gene.thresh0)) +
  geom_violin(width=0.8) +
  labs(y="Genes per Cell", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$Stage=="Time 2"),], aes(x=OstAdHoc.Assign.8gene.thresh0, y=nFeature_RNA, fill=OstAdHoc.Assign.8gene.thresh0)) +
  geom_violin(width=0.8) +
  labs(y="Genes per Cell", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))

#marker genes
VlnPlot(data,
        features=c("POU5F1","CD44","COL1A1"),
        group.by="OstAdHoc.Assign.8gene.thresh0",
        cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90"),
        pt.size=0)
DotPlot(subset(data,subset=Species=="Human"),
        features=c("COL1A1","CD44","POU5F1"),
        group.by="OstAdHoc.Assign.8gene.thresh0",
        dot.scale=20,
        cols=c("grey99","black"),
        col.max=5)
DotPlot(subset(data,subset=Species=="Chimp"),
        features=c("COL1A1","CD44","POU5F1"),
        group.by="OstAdHoc.Assign.8gene.thresh0",
        dot.scale=20,
        cols=c("grey99","black"),
        col.max=5)

```

#### 8 genes.x

Make nicer plots of osteogenic ad hoc assignments (8 gene.x, thresh0).

```{r}

#8 genes.x

#umap
DimPlot(data,
        group.by="OstAdHoc.Assign.x.8gene.thresh0",
        reduction="umap",
        cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3",
               "grey90","grey90","grey90","grey90",
               "grey90","grey90","grey90")) +
  labs(x="UMAP1",y="UMAP2")
CombinePlots(plots=list((DimPlot(subset(data,subset=Species=="Chimp"),
                                 group.by="OstAdHoc.Assign.x.8gene.thresh0",
                                 reduction="umap",
                                 cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3",
                                        "grey90","grey90","grey90","grey90",
                                        "grey90","grey90","grey90")) +
                           labs(x="UMAP1",y="UMAP2")),
                        (DimPlot(subset(data,subset=Species=="Human"),
                                 group.by="OstAdHoc.Assign.x.8gene.thresh0",
                                 reduction="umap",
                                 cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3",
                                        "grey90","grey90","grey90","grey90",
                                        "grey90","grey90","grey90")) +
                           labs(x="UMAP1",y="UMAP2"))),
             legend="right",
             ncol=2)
CombinePlots(plots=list((DimPlot(subset(data,subset=Species=="Human"),
                                 group.by="Stage",
                                 split.by="OstAdHoc.Assign.x.8gene.thresh0",
                                 reduction="umap",
                                 cols=c("pink","mediumorchid","dodgerblue")) +
                           labs(x="UMAP1",y="UMAP2")),
                        (DimPlot(subset(data,subset=Species=="Chimp"),
                                 group.by="Stage",
                                 split.by="OstAdHoc.Assign.x.8gene.thresh0",
                                 reduction="umap",
                                 cols=c("pink","mediumorchid","dodgerblue")) +
                           labs(x="UMAP1",y="UMAP2"))), ncol=1)
DimPlot(data,
        group.by="OstAdHoc.Assign.x.8gene.thresh0",
        split.by="OstAdHoc.Assign.x.8gene.thresh0",
        reduction="umap",
        cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3",
               "deepskyblue","dodgerblue2","royalblue3","royalblue4",
               "grey90","grey90","grey90")) +
  labs(x="UMAP1",y="UMAP2")
DimPlot(subset(data,subset=Stage=="Time 2"),
        group.by="OstAdHoc.Assign.x.8gene.thresh0",
        split.by="OstAdHoc.Assign.x.8gene.thresh0",
        reduction="umap",
        cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3",
               "deepskyblue","dodgerblue2","royalblue3","royalblue4",
               "grey90","grey90","grey90")) +
  labs(x="UMAP1",y="UMAP2")

#cell counts
ggplot(data@meta.data, aes(x=OstAdHoc.Assign.x.8gene.thresh0, fill=OstAdHoc.Assign.x.8gene.thresh0)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3",
                                      "deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$Stage=="Time 2"),], aes(x=OstAdHoc.Assign.x.8gene.thresh0, fill=OstAdHoc.Assign.x.8gene.thresh0)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3",
                                      "deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$OstAdHoc.Assign.x.8gene.thresh0!="not osteogenic"),],
       aes(x=OstAdHoc.Assign.x.8gene.thresh0, fill=OstAdHoc.Assign.x.8gene.thresh0)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3",
                                      "deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$Stage=="Time 2" & data@meta.data$OstAdHoc.Assign.x.8gene.thresh0!="not osteogenic"),],
       aes(x=OstAdHoc.Assign.x.8gene.thresh0, fill=OstAdHoc.Assign.x.8gene.thresh0)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3",
                                      "deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))

#umi counts
ggplot(data@meta.data, aes(x=OstAdHoc.Assign.x.8gene.thresh0, y=nCount_RNA, fill=OstAdHoc.Assign.x.8gene.thresh0)) +
  geom_violin(width=0.8) +
  labs(y="UMIs per Cell", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3",
                                      "deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$Stage=="Time 2"),], aes(x=OstAdHoc.Assign.x.8gene.thresh0, y=nCount_RNA, fill=OstAdHoc.Assign.x.8gene.thresh0)) +
  geom_violin(width=0.8) +
  labs(y="UMIs per Cell", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3",
                                      "deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))

#gene counts
ggplot(data@meta.data, aes(x=OstAdHoc.Assign.x.8gene.thresh0, y=nFeature_RNA, fill=OstAdHoc.Assign.x.8gene.thresh0)) +
  geom_violin(width=0.8) +
  labs(y="Genes per Cell", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3",
                                      "deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$Stage=="Time 2"),], aes(x=OstAdHoc.Assign.x.8gene.thresh0, y=nFeature_RNA, fill=OstAdHoc.Assign.x.8gene.thresh0)) +
  geom_violin(width=0.8) +
  labs(y="Genes per Cell", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3",
                                      "deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))

#marker genes
VlnPlot(data,
        features=c("POU5F1","CD44","COL1A1"),
        group.by="OstAdHoc.Assign.x.8gene.thresh0",
        cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3",
               "deepskyblue","dodgerblue2","royalblue3","royalblue4",
               "grey90","grey90","grey90"),
        pt.size=0)
DotPlot(subset(data,subset=Species=="Human"),
        features=c("COL1A1","CD44","POU5F1"),
        group.by="OstAdHoc.Assign.x.8gene.thresh0",
        dot.scale=20,
        cols=c("grey99","black"),
        col.max=5)
DotPlot(subset(data,subset=Species=="Chimp"),
        features=c("COL1A1","CD44","POU5F1"),
        group.by="OstAdHoc.Assign.x.8gene.thresh0",
        dot.scale=20,
        cols=c("grey99","black"),
        col.max=5)

```

#### 6 genes

Make nicer plots of osteogenic ad hoc assignments (6 gene, thresh0).

```{r}

#6 genes

#umap
DimPlot(data,
        group.by="OstAdHoc.Assign.6gene.thresh0",
        reduction="umap",
        cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  labs(x="UMAP1",y="UMAP2")
CombinePlots(plots=list((DimPlot(subset(data,subset=Species=="Chimp"),
                                 group.by="OstAdHoc.Assign.6gene.thresh0",
                                 reduction="umap",
                                 cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
                           labs(x="UMAP1",y="UMAP2")),
                        (DimPlot(subset(data,subset=Species=="Human"),
                                 group.by="OstAdHoc.Assign.6gene.thresh0",
                                 reduction="umap",
                                 cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
                           labs(x="UMAP1",y="UMAP2"))),
             legend="right",
             ncol=2)
CombinePlots(plots=list((DimPlot(subset(data,subset=Species=="Human"),
                                 group.by="Stage",
                                 split.by="OstAdHoc.Assign.6gene.thresh0",
                                 reduction="umap",
                                 cols=c("pink","mediumorchid","dodgerblue")) +
                           labs(x="UMAP1",y="UMAP2")),
                        (DimPlot(subset(data,subset=Species=="Chimp"),
                                 group.by="Stage",
                                 split.by="OstAdHoc.Assign.6gene.thresh0",
                                 reduction="umap",
                                 cols=c("pink","mediumorchid","dodgerblue")) +
                           labs(x="UMAP1",y="UMAP2"))), ncol=1)
DimPlot(data,
        group.by="OstAdHoc.Assign.6gene.thresh0",
        split.by="OstAdHoc.Assign.6gene.thresh0",
        reduction="umap",
        cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  labs(x="UMAP1",y="UMAP2")
DimPlot(subset(data,subset=Stage=="Time 2"),
        group.by="OstAdHoc.Assign.6gene.thresh0",
        split.by="OstAdHoc.Assign.6gene.thresh0",
        reduction="umap",
        cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  labs(x="UMAP1",y="UMAP2")

#cell counts
ggplot(data@meta.data, aes(x=OstAdHoc.Assign.6gene.thresh0, fill=OstAdHoc.Assign.6gene.thresh0)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$Stage=="Time 2"),], aes(x=OstAdHoc.Assign.6gene.thresh0, fill=OstAdHoc.Assign.6gene.thresh0)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$OstAdHoc.Assign.6gene.thresh0!="not osteogenic"),],
       aes(x=OstAdHoc.Assign.6gene.thresh0, fill=OstAdHoc.Assign.6gene.thresh0)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$Stage=="Time 2" & data@meta.data$OstAdHoc.Assign.6gene.thresh0!="not osteogenic"),],
       aes(x=OstAdHoc.Assign.6gene.thresh0, fill=OstAdHoc.Assign.6gene.thresh0)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))

#umi counts
ggplot(data@meta.data, aes(x=OstAdHoc.Assign.6gene.thresh0, y=nCount_RNA, fill=OstAdHoc.Assign.6gene.thresh0)) +
  geom_violin(width=0.8) +
  labs(y="UMIs per Cell", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$Stage=="Time 2"),], aes(x=OstAdHoc.Assign.6gene.thresh0, y=nCount_RNA, fill=OstAdHoc.Assign.6gene.thresh0)) +
  geom_violin(width=0.8) +
  labs(y="UMIs per Cell", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))

#gene counts
ggplot(data@meta.data, aes(x=OstAdHoc.Assign.6gene.thresh0, y=nFeature_RNA, fill=OstAdHoc.Assign.6gene.thresh0)) +
  geom_violin(width=0.8) +
  labs(y="Genes per Cell", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$Stage=="Time 2"),], aes(x=OstAdHoc.Assign.6gene.thresh0, y=nFeature_RNA, fill=OstAdHoc.Assign.6gene.thresh0)) +
  geom_violin(width=0.8) +
  labs(y="Genes per Cell", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))

#marker genes
VlnPlot(data,
        features=c("POU5F1","CD44","COL1A1"),
        group.by="OstAdHoc.Assign.6gene.thresh0",
        cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90"),
        pt.size=0)
DotPlot(subset(data,subset=Species=="Human"),
        features=c("COL1A1","CD44","POU5F1"),
        group.by="OstAdHoc.Assign.6gene.thresh0",
        dot.scale=20,
        cols=c("grey99","black"),
        col.max=5)
DotPlot(subset(data,subset=Species=="Chimp"),
        features=c("COL1A1","CD44","POU5F1"),
        group.by="OstAdHoc.Assign.6gene.thresh0",
        dot.scale=20,
        cols=c("grey99","black"),
        col.max=5)

```

#### 6 genes.x

Make nicer plots of osteogenic ad hoc assignments (6 gene.x, thresh0).

```{r}

#6 genes.x

#umap
DimPlot(data,
        group.by="OstAdHoc.Assign.x.6gene.thresh0",
        reduction="umap",
        cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
               "grey90","grey90","grey90","grey90",
               "grey90","grey90","grey90")) +
  labs(x="UMAP1",y="UMAP2")
CombinePlots(plots=list((DimPlot(subset(data,subset=Species=="Chimp"),
                                 group.by="OstAdHoc.Assign.x.6gene.thresh0",
                                 reduction="umap",
                                 cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                        "grey90","grey90","grey90","grey90",
                                        "grey90","grey90","grey90")) +
                           labs(x="UMAP1",y="UMAP2")),
                        (DimPlot(subset(data,subset=Species=="Human"),
                                 group.by="OstAdHoc.Assign.x.6gene.thresh0",
                                 reduction="umap",
                                 cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                        "grey90","grey90","grey90","grey90",
                                        "grey90","grey90","grey90")) +
                           labs(x="UMAP1",y="UMAP2"))),
             legend="right",
             ncol=2)
CombinePlots(plots=list((DimPlot(subset(data,subset=Species=="Human"),
                                 group.by="Stage",
                                 split.by="OstAdHoc.Assign.x.6gene.thresh0",
                                 reduction="umap",
                                 cols=c("pink","mediumorchid","dodgerblue")) +
                           labs(x="UMAP1",y="UMAP2")),
                        (DimPlot(subset(data,subset=Species=="Chimp"),
                                 group.by="Stage",
                                 split.by="OstAdHoc.Assign.x.6gene.thresh0",
                                 reduction="umap",
                                 cols=c("pink","mediumorchid","dodgerblue")) +
                           labs(x="UMAP1",y="UMAP2"))), ncol=1)
DimPlot(data,
        group.by="OstAdHoc.Assign.x.6gene.thresh0",
        split.by="OstAdHoc.Assign.x.6gene.thresh0",
        reduction="umap",
        cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
               "deepskyblue","dodgerblue2","royalblue3","royalblue4",
               "grey90","grey90","grey90")) +
  labs(x="UMAP1",y="UMAP2")
DimPlot(subset(data,subset=Stage=="Time 2"),
        group.by="OstAdHoc.Assign.x.6gene.thresh0",
        split.by="OstAdHoc.Assign.x.6gene.thresh0",
        reduction="umap",
        cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
               "deepskyblue","dodgerblue2","royalblue3","royalblue4",
               "grey90","grey90","grey90")) +
  labs(x="UMAP1",y="UMAP2")

#cell counts
ggplot(data@meta.data, aes(x=OstAdHoc.Assign.x.6gene.thresh0, fill=OstAdHoc.Assign.x.6gene.thresh0)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$Stage=="Time 2"),], aes(x=OstAdHoc.Assign.x.6gene.thresh0, fill=OstAdHoc.Assign.x.6gene.thresh0)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$OstAdHoc.Assign.x.6gene.thresh0!="not osteogenic"),],
       aes(x=OstAdHoc.Assign.x.6gene.thresh0, fill=OstAdHoc.Assign.x.6gene.thresh0)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$Stage=="Time 2" & data@meta.data$OstAdHoc.Assign.x.6gene.thresh0!="not osteogenic"),],
       aes(x=OstAdHoc.Assign.x.6gene.thresh0, fill=OstAdHoc.Assign.x.6gene.thresh0)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))

#umi counts
ggplot(data@meta.data, aes(x=OstAdHoc.Assign.x.6gene.thresh0, y=nCount_RNA, fill=OstAdHoc.Assign.x.6gene.thresh0)) +
  geom_violin(width=0.8) +
  labs(y="UMIs per Cell", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$Stage=="Time 2"),], aes(x=OstAdHoc.Assign.x.6gene.thresh0, y=nCount_RNA, fill=OstAdHoc.Assign.x.6gene.thresh0)) +
  geom_violin(width=0.8) +
  labs(y="UMIs per Cell", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))

#gene counts
ggplot(data@meta.data, aes(x=OstAdHoc.Assign.x.6gene.thresh0, y=nFeature_RNA, fill=OstAdHoc.Assign.x.6gene.thresh0)) +
  geom_violin(width=0.8) +
  labs(y="Genes per Cell", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$Stage=="Time 2"),], aes(x=OstAdHoc.Assign.x.6gene.thresh0, y=nFeature_RNA, fill=OstAdHoc.Assign.x.6gene.thresh0)) +
  geom_violin(width=0.8) +
  labs(y="Genes per Cell", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))

#marker genes
VlnPlot(data,
        features=c("POU5F1","CD44","COL1A1"),
        group.by="OstAdHoc.Assign.x.6gene.thresh0",
        cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
               "deepskyblue","dodgerblue2","royalblue3","royalblue4",
               "grey90","grey90","grey90"),
        pt.size=0)
DotPlot(subset(data,subset=Species=="Human"),
        features=c("COL1A1","CD44","POU5F1"),
        group.by="OstAdHoc.Assign.x.6gene.thresh0",
        dot.scale=20,
        cols=c("grey99","black"),
        col.max=5)
DotPlot(subset(data,subset=Species=="Chimp"),
        features=c("COL1A1","CD44","POU5F1"),
        group.by="OstAdHoc.Assign.x.6gene.thresh0",
        dot.scale=20,
        cols=c("grey99","black"),
        col.max=5)

```

#### 4 genes

Make nicer plots of osteogenic ad hoc assignments (4 gene, thresh0).

```{r}

#4 genes

#umap
DimPlot(data,
        group.by="OstAdHoc.Assign.4gene.thresh0",
        reduction="umap",
        cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  labs(x="UMAP1",y="UMAP2")
CombinePlots(plots=list((DimPlot(subset(data,subset=Species=="Chimp"),
                                 group.by="OstAdHoc.Assign.4gene.thresh0",
                                 reduction="umap",
                                 cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
                           labs(x="UMAP1",y="UMAP2")),
                        (DimPlot(subset(data,subset=Species=="Human"),
                                 group.by="OstAdHoc.Assign.4gene.thresh0",
                                 reduction="umap",
                                 cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
                           labs(x="UMAP1",y="UMAP2"))),
             legend="right",
             ncol=2)
CombinePlots(plots=list((DimPlot(subset(data,subset=Species=="Human"),
                                 group.by="Stage",
                                 split.by="OstAdHoc.Assign.4gene.thresh0",
                                 reduction="umap",
                                 cols=c("pink","mediumorchid","dodgerblue")) +
                           labs(x="UMAP1",y="UMAP2")),
                        (DimPlot(subset(data,subset=Species=="Chimp"),
                                 group.by="Stage",
                                 split.by="OstAdHoc.Assign.4gene.thresh0",
                                 reduction="umap",
                                 cols=c("pink","mediumorchid","dodgerblue")) +
                           labs(x="UMAP1",y="UMAP2"))), ncol=1)
DimPlot(data,
        group.by="OstAdHoc.Assign.4gene.thresh0",
        split.by="OstAdHoc.Assign.4gene.thresh0",
        reduction="umap",
        cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  labs(x="UMAP1",y="UMAP2")
DimPlot(subset(data,subset=Stage=="Time 2"),
        group.by="OstAdHoc.Assign.4gene.thresh0",
        split.by="OstAdHoc.Assign.4gene.thresh0",
        reduction="umap",
        cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  labs(x="UMAP1",y="UMAP2")

#cell counts
ggplot(data@meta.data, aes(x=OstAdHoc.Assign.4gene.thresh0, fill=OstAdHoc.Assign.4gene.thresh0)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$Stage=="Time 2"),], aes(x=OstAdHoc.Assign.4gene.thresh0, fill=OstAdHoc.Assign.4gene.thresh0)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$OstAdHoc.Assign.4gene.thresh0!="not osteogenic"),],
       aes(x=OstAdHoc.Assign.4gene.thresh0, fill=OstAdHoc.Assign.4gene.thresh0)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$Stage=="Time 2" & data@meta.data$OstAdHoc.Assign.4gene.thresh0!="not osteogenic"),],
       aes(x=OstAdHoc.Assign.4gene.thresh0, fill=OstAdHoc.Assign.4gene.thresh0)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))

#umi counts
ggplot(data@meta.data, aes(x=OstAdHoc.Assign.4gene.thresh0, y=nCount_RNA, fill=OstAdHoc.Assign.4gene.thresh0)) +
  geom_violin(width=0.8) +
  labs(y="UMIs per Cell", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$Stage=="Time 2"),], aes(x=OstAdHoc.Assign.4gene.thresh0, y=nCount_RNA, fill=OstAdHoc.Assign.4gene.thresh0)) +
  geom_violin(width=0.8) +
  labs(y="UMIs per Cell", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))

#gene counts
ggplot(data@meta.data, aes(x=OstAdHoc.Assign.4gene.thresh0, y=nFeature_RNA, fill=OstAdHoc.Assign.4gene.thresh0)) +
  geom_violin(width=0.8) +
  labs(y="Genes per Cell", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$Stage=="Time 2"),], aes(x=OstAdHoc.Assign.4gene.thresh0, y=nFeature_RNA, fill=OstAdHoc.Assign.4gene.thresh0)) +
  geom_violin(width=0.8) +
  labs(y="Genes per Cell", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))

#marker genes
VlnPlot(data,
        features=c("POU5F1","CD44","COL1A1"),
        group.by="OstAdHoc.Assign.4gene.thresh0",
        cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4","grey90","grey90","grey90"),
        pt.size=0)
DotPlot(subset(data,subset=Species=="Human"),
        features=c("COL1A1","CD44","POU5F1"),
        group.by="OstAdHoc.Assign.4gene.thresh0",
        dot.scale=20,
        cols=c("grey99","black"),
        col.max=5)
DotPlot(subset(data,subset=Species=="Chimp"),
        features=c("COL1A1","CD44","POU5F1"),
        group.by="OstAdHoc.Assign.4gene.thresh0",
        dot.scale=20,
        cols=c("grey99","black"),
        col.max=5)

```

#### 4 genes.x

Make nicer plots of osteogenic ad hoc assignments (4 gene.x, thresh0).

```{r}

#4 genes.x

#umap
DimPlot(data,
        group.by="OstAdHoc.Assign.x.4gene.thresh0",
        reduction="umap",
        cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
               "grey90","grey90","grey90","grey90",
               "grey90","grey90","grey90")) +
  labs(x="UMAP1",y="UMAP2")
CombinePlots(plots=list((DimPlot(subset(data,subset=Species=="Chimp"),
                                 group.by="OstAdHoc.Assign.x.4gene.thresh0",
                                 reduction="umap",
                                 cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                        "grey90","grey90","grey90","grey90",
                                        "grey90","grey90","grey90")) +
                           labs(x="UMAP1",y="UMAP2")),
                        (DimPlot(subset(data,subset=Species=="Human"),
                                 group.by="OstAdHoc.Assign.x.4gene.thresh0",
                                 reduction="umap",
                                 cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                        "grey90","grey90","grey90","grey90",
                                        "grey90","grey90","grey90")) +
                           labs(x="UMAP1",y="UMAP2"))),
             legend="right",
             ncol=2)
CombinePlots(plots=list((DimPlot(subset(data,subset=Species=="Human"),
                                 group.by="Stage",
                                 split.by="OstAdHoc.Assign.x.4gene.thresh0",
                                 reduction="umap",
                                 cols=c("pink","mediumorchid","dodgerblue")) +
                           labs(x="UMAP1",y="UMAP2")),
                        (DimPlot(subset(data,subset=Species=="Chimp"),
                                 group.by="Stage",
                                 split.by="OstAdHoc.Assign.x.4gene.thresh0",
                                 reduction="umap",
                                 cols=c("pink","mediumorchid","dodgerblue")) +
                           labs(x="UMAP1",y="UMAP2"))), ncol=1)
DimPlot(data,
        group.by="OstAdHoc.Assign.x.4gene.thresh0",
        split.by="OstAdHoc.Assign.x.4gene.thresh0",
        reduction="umap",
        cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
               "deepskyblue","dodgerblue2","royalblue3","royalblue4",
               "grey90","grey90","grey90")) +
  labs(x="UMAP1",y="UMAP2")
DimPlot(subset(data,subset=Stage=="Time 2"),
        group.by="OstAdHoc.Assign.x.4gene.thresh0",
        split.by="OstAdHoc.Assign.x.4gene.thresh0",
        reduction="umap",
        cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
               "deepskyblue","dodgerblue2","royalblue3","royalblue4",
               "grey90","grey90","grey90")) +
  labs(x="UMAP1",y="UMAP2")

#cell counts
ggplot(data@meta.data, aes(x=OstAdHoc.Assign.x.4gene.thresh0, fill=OstAdHoc.Assign.x.4gene.thresh0)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$Stage=="Time 2"),], aes(x=OstAdHoc.Assign.x.4gene.thresh0, fill=OstAdHoc.Assign.x.4gene.thresh0)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$OstAdHoc.Assign.x.4gene.thresh0!="not osteogenic"),],
       aes(x=OstAdHoc.Assign.x.4gene.thresh0, fill=OstAdHoc.Assign.x.4gene.thresh0)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$Stage=="Time 2" & data@meta.data$OstAdHoc.Assign.x.4gene.thresh0!="not osteogenic"),],
       aes(x=OstAdHoc.Assign.x.4gene.thresh0, fill=OstAdHoc.Assign.x.4gene.thresh0)) +
  geom_bar(position="dodge") +
  labs(y="Number of Cells", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))

#umi counts
ggplot(data@meta.data, aes(x=OstAdHoc.Assign.x.4gene.thresh0, y=nCount_RNA, fill=OstAdHoc.Assign.x.4gene.thresh0)) +
  geom_violin(width=0.8) +
  labs(y="UMIs per Cell", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$Stage=="Time 2"),], aes(x=OstAdHoc.Assign.x.4gene.thresh0, y=nCount_RNA, fill=OstAdHoc.Assign.x.4gene.thresh0)) +
  geom_violin(width=0.8) +
  labs(y="UMIs per Cell", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))

#gene counts
ggplot(data@meta.data, aes(x=OstAdHoc.Assign.x.4gene.thresh0, y=nFeature_RNA, fill=OstAdHoc.Assign.x.4gene.thresh0)) +
  geom_violin(width=0.8) +
  labs(y="Genes per Cell", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))
ggplot(data@meta.data[which(data@meta.data$Stage=="Time 2"),], aes(x=OstAdHoc.Assign.x.4gene.thresh0, y=nFeature_RNA, fill=OstAdHoc.Assign.x.4gene.thresh0)) +
  geom_violin(width=0.8) +
  labs(y="Genes per Cell", x="") +
  scale_fill_manual(name="", values=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "deepskyblue","dodgerblue2","royalblue3","royalblue4",
                                      "grey90","grey90","grey90")) +
  facet_grid(~Species)+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12),
        strip.text.x=element_text(size=12),
        axis.text.x=element_text(angle=90))

#marker genes
VlnPlot(data,
        features=c("POU5F1","CD44","COL1A1"),
        group.by="OstAdHoc.Assign.x.4gene.thresh0",
        cols=c("lightblue1","deepskyblue","dodgerblue2","royalblue3","royalblue4",
               "deepskyblue","dodgerblue2","royalblue3","royalblue4",
               "grey90","grey90","grey90"),
        pt.size=0)
DotPlot(subset(data,subset=Species=="Human"),
        features=c("COL1A1","CD44","POU5F1"),
        group.by="OstAdHoc.Assign.x.4gene.thresh0",
        dot.scale=20,
        cols=c("grey99","black"),
        col.max=5)
DotPlot(subset(data,subset=Species=="Chimp"),
        features=c("COL1A1","CD44","POU5F1"),
        group.by="OstAdHoc.Assign.x.4gene.thresh0",
        dot.scale=20,
        cols=c("grey99","black"),
        col.max=5)

```

### Enrichment
GO functional enrichment not assessed because classifications were determined based on candidate genes.

### Correlations (pseudobulk: sum)
Visualize gene expression correlations across cell classifications.

#### 8 genes

```{r}

# Compile log2 normalized gene expression data
#make count matrix and metadata for edgeR object - pseudobulk (pseudocounts, filter genes mean(log2cpm)>0)
cell.subset <- c("preosteoblast","osteoblast","embedding osteoblast","mineralizing osteoblast","maturing osteocyte","unknown osteogenic","not osteogenic")
counts <- c()
metadata <- c()
labels <- c()
for(j in cell.subset) {
  dataSub <- subset(data,subset=OstAdHoc.Assign.8gene.thresh0==j)
  #dataSub <- subset(data,subset=OstAdHoc.Assign.8gene.thresh0==j & Stage=="Time 2"))
  for (i in unique(dataSub@meta.data$Individual.Replicate)) {
    x.lab <- paste0(i,"_",sub(" ",".",j))
    w <- which(dataSub@meta.data$Individual.Replicate==i)
    if (length(w)>0) {
      x.spp <- dataSub@meta.data$Species[w][1]
      x.col <- dataSub@meta.data$Collection[w][1]
      x.ind <- dataSub@meta.data$Individual[w][1]
      x.rep <- dataSub@meta.data$Replicate[w][1]
      x.idr <- dataSub@meta.data$Individual.Replicate[w][1]
      x.adh <- sub(" ",".",as.character(dataSub@meta.data$OstAdHoc.Assign.8gene.thresh0[w][1]))
      if (length(w)==1) {
        x.cnt <- dataSub@assays$RNA@counts[,w]
      } else {
        x.cnt <- Matrix::rowSums(dataSub@assays$RNA@counts[,w])
      }
      counts <- cbind(counts, x.cnt)
      metadata <- rbind(metadata, c(x.lab, x.spp, x.col, x.ind, x.rep, x.idr, x.adh))
      labels <- c(labels, x.lab)
    }
  }
}
colnames(counts) <- labels
rownames(metadata) <- labels
colnames(metadata) <- c("Sample","Species","Collection","Individual","Replicate","Individual.Replicate","AdHoc")
metadata <- as.data.frame(metadata)
#remove mitochondrial and ribosomal genes
counts <- counts[which(rownames(counts) %in% genes.no.mito.ribo),]
#make edgeR object
dge <- DGEList(counts)
meta_dge <- dge$samples[,c("lib.size","norm.factors")]
meta_dge <- cbind(meta_dge, metadata)
dge$samples <- meta_dge
rm(counts,metadata,meta_dge)
#filter genes
keep <- rowMeans(edgeR::cpm(dge,log=TRUE,prior.count=0.25))>0
dge$counts <- dge$counts[keep,]
#normalize data
dge <- calcNormFactors(dge, method="TMM")
#log2 transformed cpm
tmm <- edgeR::cpm(dge,normalized.lib.sizes=TRUE,log=TRUE,prior.count=0.25)

rm(cell.subset,labels,dataSub,i,j,w,x.lab,x.spp,x.col,x.ind,x.rep,x.idr,x.adh,x.cnt,keep,dge)

```

Keep human and chimp samples together.

```{r}

avg <- data.frame("pre"=rowMeans(tmm[,1:14]),
                  "obl"=rowMeans(tmm[,15:27]),
                  "emb"=rowMeans(tmm[,28:41]),
                  "min"=rowMeans(tmm[,42:55]),
                  "mat"=rowMeans(tmm[,56:69]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:5,
        columnLabels=c("pre",
                       "obl",
                       "emb",
                       "min",
                       "mat"),
        mapping=ggplot2::aes(alpha=0.5))

```

Look at humans separately.

```{r}

avg <- data.frame("pre"=rowMeans(tmm[,1:7]),
                  "obl"=rowMeans(tmm[,15:20]),
                  "emb"=rowMeans(tmm[,28:34]),
                  "min"=rowMeans(tmm[,42:48]),
                  "mat"=rowMeans(tmm[,56:62]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:5,
        columnLabels=c("pre",
                       "obl",
                       "emb",
                       "min",
                       "mat"),
        mapping=ggplot2::aes(alpha=0.5))

```

Look at chimps separately.

```{r}

avg <- data.frame("pre"=rowMeans(tmm[,8:14]),
                  "obl"=rowMeans(tmm[,21:27]),
                  "emb"=rowMeans(tmm[,35:41]),
                  "min"=rowMeans(tmm[,49:55]),
                  "mat"=rowMeans(tmm[,63:69]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:5,
        columnLabels=c("pre",
                       "obl",
                       "emb",
                       "min",
                       "mat"),
        mapping=ggplot2::aes(alpha=0.5))

```

```{r}

rm(tmm,avg)

```

#### 8 genes.x

```{r}

# Compile log2 normalized gene expression data
#make count matrix and metadata for edgeR object - pseudobulk (pseudocounts, filter genes mean(log2cpm)>0)
cell.subset <- c("preosteoblast","osteoblast","embedding osteoblast","mineralizing osteoblast",
                 "x.osteoblast","x.embedding osteoblast","x.mineralizing osteoblast","x.maturing osteocyte"
                 ,"unknown osteogenic","not osteogenic")
counts <- c()
metadata <- c()
labels <- c()
for(j in cell.subset) {
  dataSub <- subset(data,subset=OstAdHoc.Assign.x.8gene.thresh0==j)
  #dataSub <- subset(data,subset=OstAdHoc.Assign.x.8gene.thresh0==j & Stage=="Time 2"))
  for (i in unique(dataSub@meta.data$Individual.Replicate)) {
    x.lab <- paste0(i,"_",sub(" ",".",j))
    w <- which(dataSub@meta.data$Individual.Replicate==i)
    if (length(w)>0) {
      x.spp <- dataSub@meta.data$Species[w][1]
      x.col <- dataSub@meta.data$Collection[w][1]
      x.ind <- dataSub@meta.data$Individual[w][1]
      x.rep <- dataSub@meta.data$Replicate[w][1]
      x.idr <- dataSub@meta.data$Individual.Replicate[w][1]
      x.adh <- sub(" ",".",as.character(dataSub@meta.data$OstAdHoc.Assign.x.8gene.thresh0[w][1]))
      if (length(w)==1) {
        x.cnt <- dataSub@assays$RNA@counts[,w]
      } else {
        x.cnt <- Matrix::rowSums(dataSub@assays$RNA@counts[,w])
      }
      counts <- cbind(counts, x.cnt)
      metadata <- rbind(metadata, c(x.lab, x.spp, x.col, x.ind, x.rep, x.idr, x.adh))
      labels <- c(labels, x.lab)
    }
  }
}
colnames(counts) <- labels
rownames(metadata) <- labels
colnames(metadata) <- c("Sample","Species","Collection","Individual","Replicate","Individual.Replicate","AdHoc")
metadata <- as.data.frame(metadata)
#remove mitochondrial and ribosomal genes
counts <- counts[which(rownames(counts) %in% genes.no.mito.ribo),]
#make edgeR object
dge <- DGEList(counts)
meta_dge <- dge$samples[,c("lib.size","norm.factors")]
meta_dge <- cbind(meta_dge, metadata)
dge$samples <- meta_dge
rm(counts,metadata,meta_dge)
#filter genes
keep <- rowMeans(edgeR::cpm(dge,log=TRUE,prior.count=0.25))>0
dge$counts <- dge$counts[keep,]
#normalize data
dge <- calcNormFactors(dge, method="TMM")
#log2 transformed cpm
tmm <- edgeR::cpm(dge,normalized.lib.sizes=TRUE,log=TRUE,prior.count=0.25)

rm(cell.subset,labels,dataSub,i,j,w,x.lab,x.spp,x.col,x.ind,x.rep,x.idr,x.adh,x.cnt,keep,dge)
```

Keep human and chimp samples together.

```{r}

avg <- data.frame("pre"=rowMeans(tmm[,1:13]),
                  "obl"=rowMeans(tmm[,14:26]),
                  "emb"=rowMeans(tmm[,27:34]),
                  "min"=rowMeans(tmm[,35:38]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:4,
        columnLabels=c("pre",
                       "obl",
                       "emb",
                       "min"),
        mapping=ggplot2::aes(alpha=0.5))

```

Look at humans separately.

```{r}

avg <- data.frame("pre"=rowMeans(tmm[,1:7]),
                  "obl"=rowMeans(tmm[,14:19]),
                  "emb"=rowMeans(tmm[,27:28]),
                  "min"=tmm[,35],
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:4,
        columnLabels=c("pre",
                       "obl",
                       "emb",
                       "min"),
        mapping=ggplot2::aes(alpha=0.5))

```

Look at chimps separately.

```{r}

avg <- data.frame("pre"=rowMeans(tmm[,8:13]),
                  "obl"=rowMeans(tmm[,20:26]),
                  "emb"=rowMeans(tmm[,29:34]),
                  "min"=rowMeans(tmm[,36:38]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:4,
        columnLabels=c("pre",
                       "obl",
                       "emb",
                       "min"),
        mapping=ggplot2::aes(alpha=0.5))

```

```{r}

rm(tmm,avg)

```

#### 6 genes

```{r}

# Compile log2 normalized gene expression data
#make count matrix and metadata for edgeR object - pseudobulk (pseudocounts, filter genes mean(log2cpm)>0)
cell.subset <- c("preosteoblast","osteoblast","embedding osteoblast","mineralizing osteoblast","maturing osteocyte","unknown osteogenic","not osteogenic")
counts <- c()
metadata <- c()
labels <- c()
for(j in cell.subset) {
  dataSub <- subset(data,subset=OstAdHoc.Assign.6gene.thresh0==j)
  #dataSub <- subset(data,subset=(OstAdHoc.Assign.6gene.thresh0==j & Stage=="Time 2"))
  for (i in unique(dataSub@meta.data$Individual.Replicate)) {
    x.lab <- paste0(i,"_",sub(" ",".",j))
    w <- which(dataSub@meta.data$Individual.Replicate==i)
    if (length(w)>0) {
      x.spp <- dataSub@meta.data$Species[w][1]
      x.col <- dataSub@meta.data$Collection[w][1]
      x.ind <- dataSub@meta.data$Individual[w][1]
      x.rep <- dataSub@meta.data$Replicate[w][1]
      x.idr <- dataSub@meta.data$Individual.Replicate[w][1]
      x.adh <- sub(" ",".",as.character(dataSub@meta.data$OstAdHoc.Assign.6gene.thresh0[w][1]))
      if (length(w)==1) {
        x.cnt <- dataSub@assays$RNA@counts[,w]
      } else {
        x.cnt <- Matrix::rowSums(dataSub@assays$RNA@counts[,w])
      }
      counts <- cbind(counts, x.cnt)
      metadata <- rbind(metadata, c(x.lab, x.spp, x.col, x.ind, x.rep, x.idr, x.adh))
      labels <- c(labels, x.lab)
    }
  }
}
colnames(counts) <- labels
rownames(metadata) <- labels
colnames(metadata) <- c("Sample","Species","Collection","Individual","Replicate","Individual.Replicate","AdHoc")
metadata <- as.data.frame(metadata)
#remove mitochondrial and ribosomal genes
counts <- counts[which(rownames(counts) %in% genes.no.mito.ribo),]
#make edgeR object
dge <- DGEList(counts)
meta_dge <- dge$samples[,c("lib.size","norm.factors")]
meta_dge <- cbind(meta_dge, metadata)
dge$samples <- meta_dge
rm(counts,metadata,meta_dge)
#filter genes
keep <- rowMeans(edgeR::cpm(dge,log=TRUE,prior.count=0.25))>0
dge$counts <- dge$counts[keep,]
#normalize data
dge <- calcNormFactors(dge, method="TMM")
#log2 transformed cpm
tmm <- edgeR::cpm(dge,normalized.lib.sizes=TRUE,log=TRUE,prior.count=0.25)

rm(cell.subset,labels,dataSub,i,j,w,x.lab,x.spp,x.col,x.ind,x.rep,x.idr,x.adh,x.cnt,keep,dge)

```

Keep human and chimp samples together.

```{r}

avg <- data.frame("pre"=rowMeans(tmm[,1:14]),
                  "obl"=rowMeans(tmm[,15:28]),
                  "emb"=rowMeans(tmm[,29:41]),
                  "min"=rowMeans(tmm[,42:55]),
                  "mat"=rowMeans(tmm[,56:67]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:5,
        columnLabels=c("pre",
                       "obl",
                       "emb",
                       "min",
                       "mat"),
        mapping=ggplot2::aes(alpha=0.5))

```

Look at humans separately.

```{r}

avg <- data.frame("pre"=rowMeans(tmm[,1:7]),
                  "obl"=rowMeans(tmm[,15:21]),
                  "emb"=rowMeans(tmm[,29:34]),
                  "min"=rowMeans(tmm[,42:48]),
                  "mat"=rowMeans(tmm[,56:62]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:5,
        columnLabels=c("pre",
                       "obl",
                       "emb",
                       "min",
                       "mat"),
        mapping=ggplot2::aes(alpha=0.5))

```

Look at chimps separately.

```{r}

avg <- data.frame("pre"=rowMeans(tmm[,8:14]),
                  "obl"=rowMeans(tmm[,22:28]),
                  "emb"=rowMeans(tmm[,35:41]),
                  "min"=rowMeans(tmm[,49:55]),
                  "mat"=rowMeans(tmm[,63:67]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:5,
        columnLabels=c("pre",
                       "obl",
                       "emb",
                       "min",
                       "mat"),
        mapping=ggplot2::aes(alpha=0.5))

```

```{r}

rm(tmm,avg)

```

#### 6 genes.x

```{r}

# Compile log2 normalized gene expression data
#make count matrix and metadata for edgeR object - pseudobulk (pseudocounts, filter genes mean(log2cpm)>0)
cell.subset <- c("preosteoblast","osteoblast","embedding osteoblast","mineralizing osteoblast","maturing osteocyte",
                 "x.osteoblast","x.embedding osteoblast","x.mineralizing osteoblast","x.maturing osteocyte"
                 ,"unknown osteogenic","not osteogenic")
counts <- c()
metadata <- c()
labels <- c()
for(j in cell.subset) {
  dataSub <- subset(data,subset=OstAdHoc.Assign.x.6gene.thresh0==j)
  #dataSub <- subset(data,subset=(OstAdHoc.Assign.x.6gene.thresh0==j & Stage=="Time 2"))
  for (i in unique(dataSub@meta.data$Individual.Replicate)) {
    x.lab <- paste0(i,"_",sub(" ",".",j))
    w <- which(dataSub@meta.data$Individual.Replicate==i)
    if (length(w)>0) {
      x.spp <- dataSub@meta.data$Species[w][1]
      x.col <- dataSub@meta.data$Collection[w][1]
      x.ind <- dataSub@meta.data$Individual[w][1]
      x.rep <- dataSub@meta.data$Replicate[w][1]
      x.idr <- dataSub@meta.data$Individual.Replicate[w][1]
      x.adh <- sub(" ",".",as.character(dataSub@meta.data$OstAdHoc.Assign.x.6gene.thresh0[w][1]))
      if (length(w)==1) {
        x.cnt <- dataSub@assays$RNA@counts[,w]
      } else {
        x.cnt <- Matrix::rowSums(dataSub@assays$RNA@counts[,w])
      }
      counts <- cbind(counts, x.cnt)
      metadata <- rbind(metadata, c(x.lab, x.spp, x.col, x.ind, x.rep, x.idr, x.adh))
      labels <- c(labels, x.lab)
    }
  }
}
colnames(counts) <- labels
rownames(metadata) <- labels
colnames(metadata) <- c("Sample","Species","Collection","Individual","Replicate","Individual.Replicate","AdHoc")
metadata <- as.data.frame(metadata)
#remove mitochondrial and ribosomal genes
counts <- counts[which(rownames(counts) %in% genes.no.mito.ribo),]
#make edgeR object
dge <- DGEList(counts)
meta_dge <- dge$samples[,c("lib.size","norm.factors")]
meta_dge <- cbind(meta_dge, metadata)
dge$samples <- meta_dge
rm(counts,metadata,meta_dge)
#filter genes
keep <- rowMeans(edgeR::cpm(dge,log=TRUE,prior.count=0.25))>0
dge$counts <- dge$counts[keep,]
#normalize data
dge <- calcNormFactors(dge, method="TMM")
#log2 transformed cpm
tmm <- edgeR::cpm(dge,normalized.lib.sizes=TRUE,log=TRUE,prior.count=0.25)

rm(cell.subset,labels,dataSub,i,j,w,x.lab,x.spp,x.col,x.ind,x.rep,x.idr,x.adh,x.cnt,keep,dge)

```

Keep human and chimp samples together.

```{r}

avg <- data.frame("pre"=rowMeans(tmm[,1:14]),
                  "obl"=rowMeans(tmm[,15:27]),
                  "emb"=rowMeans(tmm[,28:37]),
                  "min"=rowMeans(tmm[,38:41]),
                  "mat"=rowMeans(tmm[,42:47]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:5,
        columnLabels=c("pre",
                       "obl",
                       "emb",
                       "min",
                       "mat"),
        mapping=ggplot2::aes(alpha=0.5))

```

Look at humans separately.

```{r}

avg <- data.frame("pre"=rowMeans(tmm[,1:7]),
                  "obl"=rowMeans(tmm[,15:20]),
                  "emb"=rowMeans(tmm[,28:30]),
                  "min"=tmm[,38],
                  "mat"=rowMeans(tmm[,42:45]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:5,
        columnLabels=c("pre",
                       "obl",
                       "emb",
                       "min",
                       "mat"),
        mapping=ggplot2::aes(alpha=0.5))

```

Look at chimps separately.

```{r}

avg <- data.frame("pre"=rowMeans(tmm[,8:14]),
                  "obl"=rowMeans(tmm[,21:27]),
                  "emb"=rowMeans(tmm[,31:37]),
                  "min"=rowMeans(tmm[,39:41]),
                  "mat"=rowMeans(tmm[,46:47]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:5,
        columnLabels=c("pre",
                       "obl",
                       "emb",
                       "min",
                       "mat"),
        mapping=ggplot2::aes(alpha=0.5))

```

```{r}

rm(tmm,avg)

```

#### 4 genes

```{r}

# Compile log2 normalized gene expression data
#make count matrix and metadata for edgeR object - pseudobulk (pseudocounts, filter genes mean(log2cpm)>0)
cell.subset <- c("preosteoblast","osteoblast","embedding osteoblast","mineralizing osteoblast","maturing osteocyte","unknown osteogenic","not osteogenic")
counts <- c()
metadata <- c()
labels <- c()
for(j in cell.subset) {
  dataSub <- subset(data,subset=OstAdHoc.Assign.4gene.thresh0==j)
  #dataSub <- subset(data,subset=(OstAdHoc.Assign.4gene.thresh0==j & Stage=="Time 2"))
  for (i in unique(dataSub@meta.data$Individual.Replicate)) {
    x.lab <- paste0(i,"_",sub(" ",".",j))
    w <- which(dataSub@meta.data$Individual.Replicate==i)
    if (length(w)>0) {
      x.spp <- dataSub@meta.data$Species[w][1]
      x.col <- dataSub@meta.data$Collection[w][1]
      x.ind <- dataSub@meta.data$Individual[w][1]
      x.rep <- dataSub@meta.data$Replicate[w][1]
      x.idr <- dataSub@meta.data$Individual.Replicate[w][1]
      x.adh <- sub(" ",".",as.character(dataSub@meta.data$OstAdHoc.Assign.4gene.thresh0[w][1]))
      if (length(w)==1) {
        x.cnt <- dataSub@assays$RNA@counts[,w]
      } else {
        x.cnt <- Matrix::rowSums(dataSub@assays$RNA@counts[,w])
      }
      counts <- cbind(counts, x.cnt)
      metadata <- rbind(metadata, c(x.lab, x.spp, x.col, x.ind, x.rep, x.idr, x.adh))
      labels <- c(labels, x.lab)
    }
  }
}
colnames(counts) <- labels
rownames(metadata) <- labels
colnames(metadata) <- c("Sample","Species","Collection","Individual","Replicate","Individual.Replicate","AdHoc")
metadata <- as.data.frame(metadata)
#remove mitochondrial and ribosomal genes
counts <- counts[which(rownames(counts) %in% genes.no.mito.ribo),]
#make edgeR object
dge <- DGEList(counts)
meta_dge <- dge$samples[,c("lib.size","norm.factors")]
meta_dge <- cbind(meta_dge, metadata)
dge$samples <- meta_dge
rm(counts,metadata,meta_dge)
#filter genes
keep <- rowMeans(edgeR::cpm(dge,log=TRUE,prior.count=0.25))>0
dge$counts <- dge$counts[keep,]
#normalize data
dge <- calcNormFactors(dge, method="TMM")
#log2 transformed cpm
tmm <- edgeR::cpm(dge,normalized.lib.sizes=TRUE,log=TRUE,prior.count=0.25)

rm(cell.subset,labels,dataSub,i,j,w,x.lab,x.spp,x.col,x.ind,x.rep,x.idr,x.adh,x.cnt,keep,dge)

```

Keep human and chimp samples together.

```{r}

avg <- data.frame("pre"=rowMeans(tmm[,1:14]),
                  "obl"=rowMeans(tmm[,15:28]),
                  "emb"=rowMeans(tmm[,29:41]),
                  "min"=rowMeans(tmm[,42:55]),
                  "mat"=rowMeans(tmm[,56:69]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:5,
        columnLabels=c("pre",
                       "obl",
                       "emb",
                       "min",
                       "mat"),
        mapping=ggplot2::aes(alpha=0.5))

```

Look at humans separately.

```{r}

avg <- data.frame("pre"=rowMeans(tmm[,1:7]),
                  "obl"=rowMeans(tmm[,15:21]),
                  "emb"=rowMeans(tmm[,29:34]),
                  "min"=rowMeans(tmm[,42:48]),
                  "mat"=rowMeans(tmm[,56:62]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:5,
        columnLabels=c("pre",
                       "obl",
                       "emb",
                       "min",
                       "mat"),
        mapping=ggplot2::aes(alpha=0.5))

```

Look at chimps separately.

```{r}

avg <- data.frame("pre"=rowMeans(tmm[,8:14]),
                  "obl"=rowMeans(tmm[,22:28]),
                  "emb"=rowMeans(tmm[,35:41]),
                  "min"=rowMeans(tmm[,49:55]),
                  "mat"=rowMeans(tmm[,53:69]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:5,
        columnLabels=c("pre",
                       "obl",
                       "emb",
                       "min",
                       "mat"),
        mapping=ggplot2::aes(alpha=0.5))

```

```{r}

rm(tmm,avg)

```

#### 4 genes.x

```{r}

# Compile log2 normalized gene expression data
#make count matrix and metadata for edgeR object - pseudobulk (pseudocounts, filter genes mean(log2cpm)>0)
cell.subset <- c("preosteoblast","osteoblast","embedding osteoblast","mineralizing osteoblast","maturing osteocyte",
                 "x.osteoblast","x.embedding osteoblast","x.mineralizing osteoblast",
                 "unknown osteogenic","not osteogenic")
counts <- c()
metadata <- c()
labels <- c()
for(j in cell.subset) {
  dataSub <- subset(data,subset=OstAdHoc.Assign.x.4gene.thresh0==j)
  #dataSub <- subset(data,subset=(OstAdHoc.Assign.x.4gene.thresh0==j & Stage=="Time 2"))
  for (i in unique(dataSub@meta.data$Individual.Replicate)) {
    x.lab <- paste0(i,"_",sub(" ",".",j))
    w <- which(dataSub@meta.data$Individual.Replicate==i)
    if (length(w)>0) {
      x.spp <- dataSub@meta.data$Species[w][1]
      x.col <- dataSub@meta.data$Collection[w][1]
      x.ind <- dataSub@meta.data$Individual[w][1]
      x.rep <- dataSub@meta.data$Replicate[w][1]
      x.idr <- dataSub@meta.data$Individual.Replicate[w][1]
      x.adh <- sub(" ",".",as.character(dataSub@meta.data$OstAdHoc.Assign.x.4gene.thresh0[w][1]))
      if (length(w)==1) {
        x.cnt <- dataSub@assays$RNA@counts[,w]
      } else {
        x.cnt <- Matrix::rowSums(dataSub@assays$RNA@counts[,w])
      }
      counts <- cbind(counts, x.cnt)
      metadata <- rbind(metadata, c(x.lab, x.spp, x.col, x.ind, x.rep, x.idr, x.adh))
      labels <- c(labels, x.lab)
    }
  }
}
colnames(counts) <- labels
rownames(metadata) <- labels
colnames(metadata) <- c("Sample","Species","Collection","Individual","Replicate","Individual.Replicate","AdHoc")
metadata <- as.data.frame(metadata)
#remove mitochondrial and ribosomal genes
counts <- counts[which(rownames(counts) %in% genes.no.mito.ribo),]
#make edgeR object
dge <- DGEList(counts)
meta_dge <- dge$samples[,c("lib.size","norm.factors")]
meta_dge <- cbind(meta_dge, metadata)
dge$samples <- meta_dge
rm(counts,metadata,meta_dge)
#filter genes
keep <- rowMeans(edgeR::cpm(dge,log=TRUE,prior.count=0.25))>0
dge$counts <- dge$counts[keep,]
#normalize data
dge <- calcNormFactors(dge, method="TMM")
#log2 transformed cpm
tmm <- edgeR::cpm(dge,normalized.lib.sizes=TRUE,log=TRUE,prior.count=0.25)

rm(cell.subset,labels,dataSub,i,j,w,x.lab,x.spp,x.col,x.ind,x.rep,x.idr,x.adh,x.cnt,keep,dge)

```

Keep human and chimp samples together.

```{r}

avg <- data.frame("pre"=rowMeans(tmm[,1:14]),
                  "obl"=rowMeans(tmm[,15:27]),
                  "emb"=rowMeans(tmm[,28:40]),
                  "min"=rowMeans(tmm[,41:48]),
                  "mat"=rowMeans(tmm[,49:62]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:5,
        columnLabels=c("pre",
                       "obl",
                       "emb",
                       "min",
                       "mat"),
        mapping=ggplot2::aes(alpha=0.5))

```

Look at humans separately.

```{r}

avg <- data.frame("pre"=rowMeans(tmm[,1:7]),
                  "obl"=rowMeans(tmm[,15:20]),
                  "emb"=rowMeans(tmm[,28:33]),
                  "min"=rowMeans(tmm[,41:44]),
                  "mat"=rowMeans(tmm[,49:55]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:5,
        columnLabels=c("pre",
                       "obl",
                       "emb",
                       "min",
                       "mat"),
        mapping=ggplot2::aes(alpha=0.5))

```

Look at chimps separately.

```{r}

avg <- data.frame("pre"=rowMeans(tmm[,8:14]),
                  "obl"=rowMeans(tmm[,21:27]),
                  "emb"=rowMeans(tmm[,34:40]),
                  "min"=rowMeans(tmm[,45:48]),
                  "mat"=rowMeans(tmm[,56:62]),
                  row.names=rownames(tmm))

ggpairs(avg,
        columns=1:5,
        columnLabels=c("pre",
                       "obl",
                       "emb",
                       "min",
                       "mat"),
        mapping=ggplot2::aes(alpha=0.5))

```

```{r}

rm(tmm,avg)

```

### Correlations (pseudobulk: average)
Visualize gene expression correlations across cell classifications.

#### 8 genes

Keep human and chimp samples together.

```{r}

pre <- subset(data, subset=(OstAdHoc.Assign.8gene.thresh0=="preosteoblast"))
Idents(pre) <- "pre"
avg.pre <- log1p(AverageExpression(pre, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.pre$gene <- rownames(avg.pre)

obl <- subset(data, subset=(OstAdHoc.Assign.8gene.thresh0=="osteoblast"))
Idents(obl) <- "obl"
avg.obl <- log1p(AverageExpression(obl, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.obl$gene <- rownames(avg.obl)

emb <- subset(data, subset=(OstAdHoc.Assign.8gene.thresh0=="embedding osteoblast"))
Idents(emb) <- "emb"
avg.emb <- log1p(AverageExpression(emb, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.emb$gene <- rownames(avg.emb)

min <- subset(data, subset=(OstAdHoc.Assign.8gene.thresh0=="mineralizing osteoblast"))
Idents(min) <- "min"
avg.min <- log1p(AverageExpression(min, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.min$gene <- rownames(avg.min)

mat <- subset(data, subset=(OstAdHoc.Assign.8gene.thresh0=="maturing osteocyte"))
Idents(mat) <- "mat"
avg.mat <- log1p(AverageExpression(mat, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.mat$gene <- rownames(avg.mat)

ukn <- subset(data, subset=(OstAdHoc.Assign.8gene.thresh0=="unknown osteogenic"))
Idents(ukn) <- "ukn"
avg.ukn <- log1p(AverageExpression(ukn, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.ukn$gene <- rownames(avg.ukn)

nan <- subset(data, subset=(OstAdHoc.Assign.8gene.thresh0=="not osteogenic"))
Idents(nan) <- "nan"
avg.nan <- log1p(AverageExpression(nan, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.nan$gene <- rownames(avg.nan)

avg <- merge(avg.pre,
             merge(avg.obl, 
                   merge(avg.emb,
                         merge(avg.min,
                               merge(avg.mat,
                                     merge(avg.ukn,
                                           avg.nan,
                                           by="gene"),
                                     by="gene"),
                               by="gene"),
                         by="gene"),
                   by="gene"),
             by="gene")

#ggpairs(avg,
#        columns=2:length(colnames(avg)),
#        columnLabels=c("pre",
#                       "obl",
#                       "emb",
#                       "min",
#                       "mat",
#                       "unk ost",
#                       "not ost"),
#        mapping=ggplot2::aes(alpha=0.5))

ggpairs(avg,
        columns=2:6,
        columnLabels=c("pre",
                       "obl",
                       "emb",
                       "min",
                       "mat"),
        mapping=ggplot2::aes(alpha=0.5))

rm(pre,obl,emb,min,mat,ukn,nan)
rm(avg.pre,avg.obl,avg.emb,avg.min,avg.mat,avg.ukn,avg.nan)
rm(avg)

```

#### 8 genes.x

Keep human and chimp samples together.

```{r}

pre <- subset(data, subset=(OstAdHoc.Assign.x.8gene.thresh0=="preosteoblast"))
Idents(pre) <- "pre"
avg.pre <- log1p(AverageExpression(pre, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.pre$gene <- rownames(avg.pre)

obl <- subset(data, subset=(OstAdHoc.Assign.x.8gene.thresh0=="osteoblast"))
Idents(obl) <- "obl"
avg.obl <- log1p(AverageExpression(obl, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.obl$gene <- rownames(avg.obl)

emb <- subset(data, subset=(OstAdHoc.Assign.x.8gene.thresh0=="embedding osteoblast"))
Idents(emb) <- "emb"
avg.emb <- log1p(AverageExpression(emb, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.emb$gene <- rownames(avg.emb)

min <- subset(data, subset=(OstAdHoc.Assign.x.8gene.thresh0=="mineralizing osteoblast"))
Idents(min) <- "min"
avg.min <- log1p(AverageExpression(min, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.min$gene <- rownames(avg.min)

#mat <- subset(data, subset=(OstAdHoc.Assign.x.8gene.thresh0=="maturing osteocyte"))
#Idents(mat) <- "mat"
#avg.mat <- log1p(AverageExpression(mat, assays="RNA", slot="data", verbose=FALSE)$RNA)
#avg.mat$gene <- rownames(avg.mat)

xobl <- subset(data, subset=(OstAdHoc.Assign.x.8gene.thresh0=="x.osteoblast"))
Idents(xobl) <- "xobl"
avg.xobl <- log1p(AverageExpression(xobl, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.xobl$gene <- rownames(avg.xobl)

xemb <- subset(data, subset=(OstAdHoc.Assign.x.8gene.thresh0=="x.embedding osteoblast"))
Idents(xemb) <- "xemb"
avg.xemb <- log1p(AverageExpression(xemb, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.xemb$gene <- rownames(avg.xemb)

xmin <- subset(data, subset=(OstAdHoc.Assign.x.8gene.thresh0=="x.mineralizing osteoblast"))
Idents(xmin) <- "xmin"
avg.xmin <- log1p(AverageExpression(xmin, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.xmin$gene <- rownames(avg.xmin)

xmat <- subset(data, subset=(OstAdHoc.Assign.x.8gene.thresh0=="x.maturing osteocyte"))
Idents(xmat) <- "xmat"
avg.xmat <- log1p(AverageExpression(xmat, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.xmat$gene <- rownames(avg.xmat)

ukn <- subset(data, subset=(OstAdHoc.Assign.x.8gene.thresh0=="unknown osteogenic"))
Idents(ukn) <- "ukn"
avg.ukn <- log1p(AverageExpression(ukn, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.ukn$gene <- rownames(avg.ukn)

nan <- subset(data, subset=(OstAdHoc.Assign.x.8gene.thresh0=="not osteogenic"))
Idents(nan) <- "nan"
avg.nan <- log1p(AverageExpression(nan, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.nan$gene <- rownames(avg.nan)

avg <- merge(avg.pre,
             merge(avg.obl, 
                   merge(avg.emb,
                         merge(avg.min,
                               #merge(avg.mat,
                                     merge(avg.xobl, 
                                           merge(avg.xemb,
                                                 merge(avg.xmin,
                                                       merge(avg.xmat,
                                                             merge(avg.ukn,
                                                                   avg.nan,
                                                                   by="gene"),
                                                             by="gene"),
                                                       by="gene"),
                                                 by="gene"),
                                           by="gene"),
                                     by="gene"),
                               #by="gene"),
                         by="gene"),
                   by="gene"),
             by="gene")

#ggpairs(avg,
#        columns=2:length(colnames(avg)),
#        columnLabels=c("pre",
#                       "obl",
#                       "emb",
#                       "min",
#                       #"mat",
#                       "x.obl",
#                       "x.emb",
#                       "x.min",
#                       "x.mat",
#                       "unk ost",
#                       "not ost"),
#        mapping=ggplot2::aes(alpha=0.5))

ggpairs(avg,
        columns=2:5,
        columnLabels=c("pre",
                       "obl",
                       "emb",
                       "min"),
        mapping=ggplot2::aes(alpha=0.5))

rm(pre,obl,emb,min,xobl,xemb,xmin,xmat,ukn,nan)
rm(avg.pre,avg.obl,avg.emb,avg.min,avg.xobl,avg.xemb,avg.xmin,avg.xmat,avg.ukn,avg.nan)
rm(avg)

```

#### 6 genes

Keep human and chimp samples together.

```{r}

pre <- subset(data, subset=(OstAdHoc.Assign.6gene.thresh0=="preosteoblast"))
Idents(pre) <- "pre"
avg.pre <- log1p(AverageExpression(pre, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.pre$gene <- rownames(avg.pre)

obl <- subset(data, subset=(OstAdHoc.Assign.6gene.thresh0=="osteoblast"))
Idents(obl) <- "obl"
avg.obl <- log1p(AverageExpression(obl, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.obl$gene <- rownames(avg.obl)

emb <- subset(data, subset=(OstAdHoc.Assign.6gene.thresh0=="embedding osteoblast"))
Idents(emb) <- "emb"
avg.emb <- log1p(AverageExpression(emb, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.emb$gene <- rownames(avg.emb)

min <- subset(data, subset=(OstAdHoc.Assign.6gene.thresh0=="mineralizing osteoblast"))
Idents(min) <- "min"
avg.min <- log1p(AverageExpression(min, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.min$gene <- rownames(avg.min)

mat <- subset(data, subset=(OstAdHoc.Assign.6gene.thresh0=="maturing osteocyte"))
Idents(mat) <- "mat"
avg.mat <- log1p(AverageExpression(mat, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.mat$gene <- rownames(avg.mat)

ukn <- subset(data, subset=(OstAdHoc.Assign.6gene.thresh0=="unknown osteogenic"))
Idents(ukn) <- "ukn"
avg.ukn <- log1p(AverageExpression(ukn, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.ukn$gene <- rownames(avg.ukn)

nan <- subset(data, subset=(OstAdHoc.Assign.6gene.thresh0=="not osteogenic"))
Idents(nan) <- "nan"
avg.nan <- log1p(AverageExpression(nan, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.nan$gene <- rownames(avg.nan)

avg <- merge(avg.pre,
             merge(avg.obl, 
                   merge(avg.emb,
                         merge(avg.min,
                               merge(avg.mat,
                                     merge(avg.ukn,
                                           avg.nan,
                                           by="gene"),
                                     by="gene"),
                               by="gene"),
                         by="gene"),
                   by="gene"),
             by="gene")

#ggpairs(avg,
#        columns=2:length(colnames(avg)),
#        columnLabels=c("pre",
#                       "obl",
#                       "emb",
#                       "min",
#                       "mat",
#                       "unk ost",
#                       "not ost"),
#        mapping=ggplot2::aes(alpha=0.5))

ggpairs(avg,
        columns=2:6,
        columnLabels=c("pre",
                       "obl",
                       "emb",
                       "min",
                       "mat"),
        mapping=ggplot2::aes(alpha=0.5))

rm(pre,obl,emb,min,mat,ukn,nan)
rm(avg.pre,avg.obl,avg.emb,avg.min,avg.mat,avg.ukn,avg.nan)
rm(avg)

```

#### 6 genes.x

Keep human and chimp samples together.

```{r}

pre <- subset(data, subset=(OstAdHoc.Assign.x.6gene.thresh0=="preosteoblast"))
Idents(pre) <- "pre"
avg.pre <- log1p(AverageExpression(pre, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.pre$gene <- rownames(avg.pre)

obl <- subset(data, subset=(OstAdHoc.Assign.x.6gene.thresh0=="osteoblast"))
Idents(obl) <- "obl"
avg.obl <- log1p(AverageExpression(obl, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.obl$gene <- rownames(avg.obl)

emb <- subset(data, subset=(OstAdHoc.Assign.x.6gene.thresh0=="embedding osteoblast"))
Idents(emb) <- "emb"
avg.emb <- log1p(AverageExpression(emb, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.emb$gene <- rownames(avg.emb)

min <- subset(data, subset=(OstAdHoc.Assign.x.6gene.thresh0=="mineralizing osteoblast"))
Idents(min) <- "min"
avg.min <- log1p(AverageExpression(min, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.min$gene <- rownames(avg.min)

mat <- subset(data, subset=(OstAdHoc.Assign.x.6gene.thresh0=="maturing osteocyte"))
Idents(mat) <- "mat"
avg.mat <- log1p(AverageExpression(mat, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.mat$gene <- rownames(avg.mat)

xobl <- subset(data, subset=(OstAdHoc.Assign.x.6gene.thresh0=="x.osteoblast"))
Idents(xobl) <- "xobl"
avg.xobl <- log1p(AverageExpression(xobl, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.xobl$gene <- rownames(avg.xobl)

xemb <- subset(data, subset=(OstAdHoc.Assign.x.6gene.thresh0=="x.embedding osteoblast"))
Idents(xemb) <- "xemb"
avg.xemb <- log1p(AverageExpression(xemb, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.xemb$gene <- rownames(avg.xemb)

xmin <- subset(data, subset=(OstAdHoc.Assign.x.6gene.thresh0=="x.mineralizing osteoblast"))
Idents(xmin) <- "xmin"
avg.xmin <- log1p(AverageExpression(xmin, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.xmin$gene <- rownames(avg.xmin)

xmat <- subset(data, subset=(OstAdHoc.Assign.x.6gene.thresh0=="x.maturing osteocyte"))
Idents(xmat) <- "xmat"
avg.xmat <- log1p(AverageExpression(xmat, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.xmat$gene <- rownames(avg.xmat)

ukn <- subset(data, subset=(OstAdHoc.Assign.x.6gene.thresh0=="unknown osteogenic"))
Idents(ukn) <- "ukn"
avg.ukn <- log1p(AverageExpression(ukn, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.ukn$gene <- rownames(avg.ukn)

nan <- subset(data, subset=(OstAdHoc.Assign.x.6gene.thresh0=="not osteogenic"))
Idents(nan) <- "nan"
avg.nan <- log1p(AverageExpression(nan, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.nan$gene <- rownames(avg.nan)

avg <- merge(avg.pre,
             merge(avg.obl, 
                   merge(avg.emb,
                         merge(avg.min,
                               merge(avg.mat,
                                     merge(avg.xobl, 
                                           merge(avg.xemb,
                                                 merge(avg.xmin,
                                                       merge(avg.xmat,
                                                             merge(avg.ukn,
                                                                   avg.nan,
                                                                   by="gene"),
                                                             by="gene"),
                                                       by="gene"),
                                                 by="gene"),
                                           by="gene"),
                                     by="gene"),
                               by="gene"),
                         by="gene"),
                   by="gene"),
             by="gene")

#ggpairs(avg,
#        columns=2:length(colnames(avg)),
#        columnLabels=c("pre",
#                       "obl",
#                       "emb",
#                       "min",
#                       "mat",
#                       "x.obl",
#                       "x.emb",
#                       "x.min",
#                       "x.mat",
#                       "unk ost",
#                       "not ost"),
#        mapping=ggplot2::aes(alpha=0.5))

ggpairs(avg,
        columns=2:6,
        columnLabels=c("pre",
                       "obl",
                       "emb",
                       "min",
                       "mat"),
        mapping=ggplot2::aes(alpha=0.5))

rm(pre,obl,emb,min,mat,xobl,xemb,xmin,xmat,ukn,nan)
rm(avg.pre,avg.obl,avg.emb,avg.min,avg.mat,avg.xobl,avg.xemb,avg.xmin,avg.xmat,avg.ukn,avg.nan)
rm(avg)

```

#### 4 genes

Keep human and chimp samples together.

```{r}

pre <- subset(data, subset=(OstAdHoc.Assign.4gene.thresh0=="preosteoblast"))
Idents(pre) <- "pre"
avg.pre <- log1p(AverageExpression(pre, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.pre$gene <- rownames(avg.pre)

obl <- subset(data, subset=(OstAdHoc.Assign.4gene.thresh0=="osteoblast"))
Idents(obl) <- "obl"
avg.obl <- log1p(AverageExpression(obl, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.obl$gene <- rownames(avg.obl)

emb <- subset(data, subset=(OstAdHoc.Assign.4gene.thresh0=="embedding osteoblast"))
Idents(emb) <- "emb"
avg.emb <- log1p(AverageExpression(emb, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.emb$gene <- rownames(avg.emb)

min <- subset(data, subset=(OstAdHoc.Assign.4gene.thresh0=="mineralizing osteoblast"))
Idents(min) <- "min"
avg.min <- log1p(AverageExpression(min, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.min$gene <- rownames(avg.min)

mat <- subset(data, subset=(OstAdHoc.Assign.4gene.thresh0=="maturing osteocyte"))
Idents(mat) <- "mat"
avg.mat <- log1p(AverageExpression(mat, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.mat$gene <- rownames(avg.mat)

ukn <- subset(data, subset=(OstAdHoc.Assign.4gene.thresh0=="unknown osteogenic"))
Idents(ukn) <- "ukn"
avg.ukn <- log1p(AverageExpression(ukn, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.ukn$gene <- rownames(avg.ukn)

nan <- subset(data, subset=(OstAdHoc.Assign.4gene.thresh0=="not osteogenic"))
Idents(nan) <- "nan"
avg.nan <- log1p(AverageExpression(nan, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.nan$gene <- rownames(avg.nan)

avg <- merge(avg.pre,
             merge(avg.obl, 
                   merge(avg.emb,
                         merge(avg.min,
                               merge(avg.mat,
                                     merge(avg.ukn,
                                           avg.nan,
                                           by="gene"),
                                     by="gene"),
                               by="gene"),
                         by="gene"),
                   by="gene"),
             by="gene")

#ggpairs(avg,
#        columns=2:length(colnames(avg)),
#        columnLabels=c("pre",
#                       "obl",
#                       "emb",
#                       "min",
#                       "mat",
#                       "unk ost",
#                       "not ost"),
#        mapping=ggplot2::aes(alpha=0.5))

ggpairs(avg,
        columns=2:6,
        columnLabels=c("pre",
                       "obl",
                       "emb",
                       "min",
                       "mat"),
        mapping=ggplot2::aes(alpha=0.5))

rm(pre,obl,emb,min,mat,ukn,nan)
rm(avg.pre,avg.obl,avg.emb,avg.min,avg.mat,avg.ukn,avg.nan)
rm(avg)

```

#### 4 genes.x

Keep human and chimp samples together.

```{r}

pre <- subset(data, subset=(OstAdHoc.Assign.x.4gene.thresh0=="preosteoblast"))
Idents(pre) <- "pre"
avg.pre <- log1p(AverageExpression(pre, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.pre$gene <- rownames(avg.pre)

obl <- subset(data, subset=(OstAdHoc.Assign.x.4gene.thresh0=="osteoblast"))
Idents(obl) <- "obl"
avg.obl <- log1p(AverageExpression(obl, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.obl$gene <- rownames(avg.obl)

emb <- subset(data, subset=(OstAdHoc.Assign.x.4gene.thresh0=="embedding osteoblast"))
Idents(emb) <- "emb"
avg.emb <- log1p(AverageExpression(emb, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.emb$gene <- rownames(avg.emb)

min <- subset(data, subset=(OstAdHoc.Assign.x.4gene.thresh0=="mineralizing osteoblast"))
Idents(min) <- "min"
avg.min <- log1p(AverageExpression(min, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.min$gene <- rownames(avg.min)

mat <- subset(data, subset=(OstAdHoc.Assign.x.4gene.thresh0=="maturing osteocyte"))
Idents(mat) <- "mat"
avg.mat <- log1p(AverageExpression(mat, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.mat$gene <- rownames(avg.mat)

xobl <- subset(data, subset=(OstAdHoc.Assign.x.4gene.thresh0=="x.osteoblast"))
Idents(xobl) <- "xobl"
avg.xobl <- log1p(AverageExpression(xobl, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.xobl$gene <- rownames(avg.xobl)

xemb <- subset(data, subset=(OstAdHoc.Assign.x.4gene.thresh0=="x.embedding osteoblast"))
Idents(xemb) <- "xemb"
avg.xemb <- log1p(AverageExpression(xemb, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.xemb$gene <- rownames(avg.xemb)

xmin <- subset(data, subset=(OstAdHoc.Assign.x.4gene.thresh0=="x.mineralizing osteoblast"))
Idents(xmin) <- "xmin"
avg.xmin <- log1p(AverageExpression(xmin, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.xmin$gene <- rownames(avg.xmin)

#xmat <- subset(data, subset=(OstAdHoc.Assign.x.4gene.thresh0=="x.maturing osteocyte"))
#Idents(xmat) <- "xmat"
#avg.xmat <- log1p(AverageExpression(xmat, assays="RNA", slot="data", verbose=FALSE)$RNA)
#avg.xmat$gene <- rownames(avg.xmat)

ukn <- subset(data, subset=(OstAdHoc.Assign.x.4gene.thresh0=="unknown osteogenic"))
Idents(ukn) <- "ukn"
avg.ukn <- log1p(AverageExpression(ukn, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.ukn$gene <- rownames(avg.ukn)

nan <- subset(data, subset=(OstAdHoc.Assign.x.4gene.thresh0=="not osteogenic"))
Idents(nan) <- "nan"
avg.nan <- log1p(AverageExpression(nan, assays="RNA", slot="data", verbose=FALSE)$RNA)
avg.nan$gene <- rownames(avg.nan)

avg <- merge(avg.pre,
             merge(avg.obl, 
                   merge(avg.emb,
                         merge(avg.min,
                               merge(avg.mat,
                                     merge(avg.xobl, 
                                           merge(avg.xemb,
                                                 merge(avg.xmin,
                                                       #merge(avg.xmat,
                                                             merge(avg.ukn,
                                                                   avg.nan,
                                                                   by="gene"),
                                                             by="gene"),
                                                       #by="gene"),
                                                 by="gene"),
                                           by="gene"),
                                     by="gene"),
                               by="gene"),
                         by="gene"),
                   by="gene"),
             by="gene")

#ggpairs(avg,
#        columns=2:length(colnames(avg)),
#        columnLabels=c("pre",
#                       "obl",
#                       "emb",
#                       "min",
#                       "mat",
#                       "x.obl",
#                       "x.emb",
#                       "x.min",
#                       #"x.mat",
#                       "unk ost",
#                       "not ost"),
#        mapping=ggplot2::aes(alpha=0.5))

ggpairs(avg,
        columns=2:6,
        columnLabels=c("pre",
                       "obl",
                       "emb",
                       "min",
                       "mat"),
        mapping=ggplot2::aes(alpha=0.5))

rm(pre,obl,emb,min,mat,xobl,xemb,xmin,xmat,ukn,nan)
rm(avg.pre,avg.obl,avg.emb,avg.min,avg.mat,avg.xobl,avg.xemb,avg.xmin,avg.xmat,avg.ukn,avg.nan)
rm(avg)

```



###EDIT
## Examine overlap of cells across classification schemes.

Assess the overlap of general ad hoc assignments between tot and t2:

```{r, eval=FALSE}

compare <- inner_join(
  t2 %>%
    select(Cell,AdHoc.Assign.thresh0),
  tot %>%
    filter(Stage=="Time 2") %>% 
    select(Cell,AdHoc.Assign.thresh0),
  by="Cell"
)
colnames(compare) <- c("cell","t2","tot")
compare

conf_mat <- confusion_matrix(targets = compare$t2,
                             predictions = compare$tot)

plot_confusion_matrix(conf_mat$`Confusion Matrix`[[1]],
                      add_normalized=FALSE)

```

Assess the overlap of osteogenic ad hoc assignments between tot and t2:

```{r, eval=FALSE}

compare <- inner_join(
  t2 %>%
    select(Cell,OstAdHoc.Assign.4geneA.median),
  tot %>%
    filter(Stage=="Time 2") %>% 
    select(Cell,OstAdHoc.Assign.4geneA.median),
  by="Cell"
)

compare <- inner_join(
  t2 %>%
    select(Cell,OstAdHoc.Assign.5gene.thresh0),
  tot %>%
    filter(Stage=="Time 2") %>% 
    select(Cell,OstAdHoc.Assign.5gene.thresh0),
  by="Cell"
)

colnames(compare) <- c("cell","t2","tot")
compare

conf_mat <- confusion_matrix(targets = compare$t2,
                             predictions = compare$tot)

plot_confusion_matrix(conf_mat$`Confusion Matrix`[[1]],
                      add_normalized=FALSE)

```
