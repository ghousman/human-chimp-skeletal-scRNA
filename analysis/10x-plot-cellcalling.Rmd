---
title: "10x-plot-cellcalling"
author: "Genevieve Housman"
date: "February 2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 10X Data Cellranger Analysis - Visual Cell Classifications

As detailed in 10x-data-1-process.Rmd and 10x-data-0-process-test, cellranger is really bad at human/chimp assignments, so we instead assigned cells based on the ratio of human-aligned UMIs per cells vs. the total number of aligned UMIs per cells (output from cellranger using combined_genome_index). We used a cutoff ratio <= 0.1 to assign chimpanzee cells and a cutoff ratio >= 0.9 to assign human cells.

Here, we produce plots to compare the cellranger species assignments to our revised species assignments.

```{r load libraries}

library(ggplot2)
library(gridExtra)
library(colorspace)
library(RColorBrewer)

```

```{r load batch information}

#Load batch info
batch <- read.csv(file='./data/scrna-batch.csv', header=TRUE, sep=",")

```

```{r examine cellranger vs. new species assignments}

i <- 1
while (i <= length(batch$Sample_Name_at_Core)) {
  
  print(batch$Sample_Name_at_Core[i])

  #load data
  dir_data <- paste0('./../scRNA/cellranger-data-full/cellranger-data-HumanOrthoV2_and_ChimpOrthoV2/',batch$Sample_Name_at_Core[i],'/outs/analysis/')
  #dir_data <- paste0('./../scRNA/cellranger-data-full/cellranger-data-HumanOrthoV2_and_ChimpOrthoV2/GHO-3/outs/analysis/')
  temp <- read.csv(file=paste0(dir_data,'gem_classification_GHedit.csv'))
  
  #make calls a factor
  temp$call <- factor(temp$call, levels=c("Chimp","Human","Multiplet"), labels=c("Chimp","Human","Multiplet"))
  temp$NEWcall <- factor(temp$NEWcall, levels=c("Chimp","Human","Multiplet"), labels=c("Chimp","Human","Multiplet"))
  
  #number of species assignments (cellranger)
  table(temp$call)
  
  #maximum number of UMIs/cell that aligned to each genome
  max(temp$ChimpOrthoV2)
  max(temp$HumanOrthoV2)
  max_umi <- max(c(temp$ChimpOrthoV2,temp$HumanOrthoV2))
  
  p1 <- ggplot(temp, aes(x=HumanOrthoV2, y=ChimpOrthoV2, color=call)) +
          geom_point() +
          scale_color_manual(drop=FALSE, values=c("blue","red","grey")) +
          lims(x=c(0,max_umi), y=c(0,max_umi)) +
          labs(x="UMI Aligned to Human Genome", y="UMI Aligned to Chimp Genome", color="CellRanger Calls") +
          theme(legend.position=c(0.8,0.8))
  
  p2 <- ggplot(temp, aes(x=call, fill=call)) +
          geom_bar() +
          scale_x_discrete(drop=FALSE) +
          scale_fill_manual(drop=FALSE, values=c("blue","red","grey")) +
          ylim(0,5000) +
          theme(legend.position="none") +
          labs(x="CellRanger Calls", y="Frequency")
  
  grid.arrange(p1,p2, ncol=2, widths=c(2,1))
  
  #examine ratio of human umis to total umis
  c_cutoff <- 0.1
  h_cutoff <- 0.9
  
  p1 <- ggplot(temp, aes(x=RatioOrthoV2)) +
          geom_histogram(binwidth=0.01, color="black", fill="white", alpha=0.2) +
          xlim(0,1) +
          geom_vline(xintercept=c(c_cutoff,h_cutoff), color=c("blue","red")) +
          labs(x="Ratio of Human UMIs to Total UMIs", y="Frequency")
  
  grid.arrange(p1)
  
  #number of species assignments (revised calls)
  table(temp$NEWcall)
  
  p1 <- ggplot(temp, aes(x=HumanOrthoV2, y=ChimpOrthoV2, color=NEWcall)) +
          geom_point() +
          scale_color_manual(drop=FALSE, values=c("blue","red","grey")) +
          lims(x=c(0,max_umi), y=c(0,max_umi)) +
          labs(x="UMI Aligned to Human Genome", y="UMI Aligned to Chimp Genome", color="New Calls") +
          theme(legend.position=c(0.8,0.8))
  
  p2 <- ggplot(temp, aes(x=NEWcall, fill=NEWcall)) +
          geom_bar() +
          scale_x_discrete(drop=FALSE) +
          scale_fill_manual(drop=FALSE, values=c("blue","red","grey")) +
          ylim(0,5000) +
          theme(legend.position="none") +
          labs(x="New Calls", y="Frequency")
  
  grid.arrange(p1,p2, ncol=2, widths=c(2,1))
  
  i=i+1

}

```
