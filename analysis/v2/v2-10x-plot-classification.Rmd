---
title: "10x-plot-classification"
author: "Genevieve Housman"
date: "September 2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 10X Data Cellranger Analysis - Visual Cell Classifications

https://cran.r-project.org/web/packages/cvms/vignettes/creating_a_confusion_matrix.html

```{r}

#Load libraries
library(Seurat)
library(cvms)
library(broom)
library(tibble)

library(dplyr)
library(stringi)
library(stringr)
#library(ggplot2)
#library(colorspace)
#library(RColorBrewer)
#library(ggplot2)
#library(cowplot)
#theme_set(theme_cowplot())


```

```{r}

#Load data
scrna.tot <- "./data/cellranger-data-full/data.filter.log.indv-cell.int19k.reg-tot.assign.rds" #integrate across individuals - total (19k genes)
data.tot <- readRDS(scrna.tot)
data.tot@meta.data$Cell <- rownames(data.tot@meta.data)
tot <- as_tibble(data.tot@meta.data)
tot

scrna.t2 <- "./data/cellranger-data-full/data.filter.log.indv-cell.int19k.reg-t2.assign.rds" #integrate across individuals - time 2 (19k genes)
data.t2 <- readRDS(scrna.t2)
x <- sapply(str_split(rownames(data.t2@meta.data),"_"),`[`,1)
y <- sapply(data.t2@meta.data$Sample, function(x){gsub("-O-","",x)})
z <- sapply(y, function(x){gsub("-O","",x)})
data.t2@meta.data$Cell <- paste0(z,".O_",x)
t2 <- as_tibble(data.t2@meta.data)
t2

rm(scrna.tot,scrna.t2,x,y,z)

```

View unsupervised clustering results

```{r}

#6
DimPlot(data.tot,
        group.by="integrated_snn_res.0.05",
        reduction="umap",
        order=c(2,3,0,5,4,1),
        cols=c("pink","pink3","grey","mediumorchid","dodgerblue","dodgerblue4")) +
  labs(x="UMAP1",y="UMAP2")

#8
DimPlot(data.tot,
        group.by="integrated_snn_res.0.1",
        reduction="umap",
        order=c(2,3,4,1,7,5,6,0),
        cols=c("pink","pink3","pink4","grey","mediumorchid","orchid4","dodgerblue","dodgerblue4")) +
  labs(x="UMAP1",y="UMAP2")

#12
DimPlot(data.tot,
        group.by="integrated_snn_res.0.25",
        reduction="umap",
        order=c(5,2,3,8,4,0,10,11,6,9,7,1),
        cols=c("pink","palevioletred1","pink3","pink4","grey40","grey","mediumorchid","orchid4","purple","dodgerblue","dodgerblue4","navyblue")) +
  labs(x="UMAP1",y="UMAP2")

#17
DimPlot(data.tot,
        group.by="integrated_snn_res.0.5",
        reduction="umap",
        order=c(15,14,9,0,5,11,7,2,4,8,16,13,10,12,3,6,1),
        cols=c("pink","palevioletred1","palevioletred3","pink3","pink4","grey40","grey",
               "mediumorchid","orchid2","orchid3","orchid4","purple",
               "dodgerblue","dodgerblue2","dodgerblue4","navyblue","black")) +
  labs(x="UMAP1",y="UMAP2")

#19
DimPlot(data.tot,
        group.by="integrated_snn_res.0.75",
        reduction="umap",
        order=c(16,15,9,1,3,17,11,5,0,6,8,18,14,10,13,12,7,4,2),
        cols=c("pink","palevioletred1","palevioletred3","palevioletred4","pink3","pink4","grey40","grey",
               "mediumorchid","orchid2","orchid3","orchid4","purple","grey30",
               "dodgerblue","dodgerblue2","dodgerblue4","navyblue","black")) +
  labs(x="UMAP1",y="UMAP2")

#24
DimPlot(data.tot,
        group.by="integrated_snn_res.1",
        reduction="umap",
        order=c(19,22,18,8,11,5,3,17,20,12,4,1,2,7,21,23,10,15,9,14,13,16,6,0),
        cols=c("pink","palevioletred1","hotpink","hotpink3","palevioletred3","palevioletred4","pink3","pink4","grey40","grey",
               "mediumorchid","orchid2","orchid3","orchid4","purple","grey30","grey90",
               "dodgerblue","dodgerblue3","deepskyblue4","dodgerblue4","navyblue","deepskyblue","black")) +
  labs(x="UMAP1",y="UMAP2")

```

Assess GO Functional Enrichment of Genes Defining Each Topic

```{bash, eval=FALSE}

#Use cluster to identify genes defining each cluster
sbatch ./FindMarkers.sh 0.1
sbatch ./FindMarkers.sh 0.25
sbatch ./FindMarkers.sh 0.5
sbatch ./FindMarkers.sh 0.75
sbatch ./FindMarkers.sh 1

```


```{r}

#Load libraries for GO enrichment analysis
library(clusterProfiler)
library(org.Hs.eg.db)
library(viridis)

#Define functions to assess GO functional enrichment
goEnrich <- function(totGenes, deGenes, ontology) {
  ref.df <- bitr(totGenes, fromType="SYMBOL", toType=c("ENSEMBL","ENTREZID"), OrgDb=org.Hs.eg.db)
  gene.df <- bitr(deGenes, fromType="SYMBOL", toType=c("ENSEMBL","ENTREZID"), OrgDb=org.Hs.eg.db)
  ego <- enrichGO(gene          = gene.df$ENSEMBL,
                  OrgDb         = org.Hs.eg.db,
                  universe      = ref.df$ENSEMBL,
                  keyType       = 'ENSEMBL',
                  ont           = ontology,
                  pAdjustMethod = "BH",
                  pvalueCutoff  = 0.01,
                  qvalueCutoff  = 0.05,
                  readable      = TRUE)
  return(ego)
}

#Get total genes included in topics modeling
counts <- as.matrix(data.tot@assays$RNA@counts) #do not use integrated data
counts <- counts[rowSums(counts>0)>0,]          #remove genes with 0 counts across cells
geneTot <- rownames(counts)

#Find top 100 markers for every cluster compared to all remaining clusters, report only the positive ones
genes <- readRDS("./output/markers.res1.data.filter.log.indv-cell.int19k.reg-tot.rds")
geneSub <- genes %>% group_by(cluster) %>% top_n(n=100, wt=avg_logFC) %>% filter(cluster==0)

#Test for functional enrichment
goTot <- goEnrich(totGenes=geneTot, deGenes=geneSub$gene, ontology="ALL")

goTot@result$Description <- str_wrap(goTot@result$Description, width=30)
ggplot(goTot, aes(x=Count, y=Description, color=p.adjust, size=Count), split='ONTOLOGY') +
  geom_point() +
  theme(axis.text.x=element_text(angle=-40, hjust=0)) +
  facet_grid(ONTOLOGY~., scale="free") +
  scale_size_area(max_size=6) +
  scale_color_viridis(option="C") +
  theme_bw() +
  labs(title="GoM Genes")

```


Assess the overlap of general ad hoc assignments between tot and t2:

```{r}

compare <- inner_join(
  t2 %>%
    select(Cell,AdHoc.Assign.thresh0),
  tot %>%
    filter(Stage=="Time 2") %>% 
    select(Cell,AdHoc.Assign.thresh0),
  by="Cell"
)
colnames(compare) <- c("cell","t2","tot")
compare

conf_mat <- confusion_matrix(targets = compare$t2,
                             predictions = compare$tot)

plot_confusion_matrix(conf_mat$`Confusion Matrix`[[1]],
                      add_normalized=FALSE)

```

Assess the overlap of osteogenic ad hoc assignments between tot and t2:

```{r}

compare <- inner_join(
  t2 %>%
    select(Cell,OstAdHoc.Assign.4geneA.median),
  tot %>%
    filter(Stage=="Time 2") %>% 
    select(Cell,OstAdHoc.Assign.4geneA.median),
  by="Cell"
)

compare <- inner_join(
  t2 %>%
    select(Cell,OstAdHoc.Assign.5gene.thresh0),
  tot %>%
    filter(Stage=="Time 2") %>% 
    select(Cell,OstAdHoc.Assign.5gene.thresh0),
  by="Cell"
)

colnames(compare) <- c("cell","t2","tot")
compare

conf_mat <- confusion_matrix(targets = compare$t2,
                             predictions = compare$tot)

plot_confusion_matrix(conf_mat$`Confusion Matrix`[[1]],
                      add_normalized=FALSE)

```

Add ad hoc assignments from data.t2 assignments to data.tot

```{r}

#Add ad hoc assignments from data.t2 assignments to data.tot

compare <- right_join(
  t2 %>%
    dplyr::select(Cell,
                  AdHoc.Assign.thresh0,
                  AdHoc.Assign.l.thresh0,
                  AdHoc.Assign.median,
                  OstAdHoc.Assign.5gene.thresh0,
                  OstAdHoc.Assign.x.5gene.thresh0,
                  OstAdHoc.Assign.5gene.l.thresh0,
                  OstAdHoc.Assign.x.5gene.l.thresh0,
                  OstAdHoc.Assign.5gene.median,
                  OstAdHoc.Assign.x.5gene.median,
                  Cluster),
  tot %>%
    dplyr::select(Cell),
  by="Cell"
)
colnames(compare) <- c("cell","t2.adhoc.0","t2.adhoc.l0","t2.adhoc.m",
                       "t2.ostadhoc.0","t2.ostadhoc.x0","t2.ostadhoc.l0","t2.ostadhoc.xl0","t2.ostadhoc.m","t2.ostadhoc.xm",
                       "t2.cluster")
compare
data.tot@meta.data$AdHoc.Assign.thresh0.t2 <- NA
data.tot@meta.data$AdHoc.Assign.l.thresh0.t2 <- NA
data.tot@meta.data$AdHoc.Assign.median.t2 <- NA
data.tot@meta.data$OstAdHoc.Assign.5gene.thresh0.t2 <- NA
data.tot@meta.data$OstAdHoc.Assign.x.5gene.thresh0.t2 <- NA
data.tot@meta.data$OstAdHoc.Assign.5gene.l.thresh0.t2 <- NA
data.tot@meta.data$OstAdHoc.Assign.x.5gene.l.thresh0.t2 <- NA
data.tot@meta.data$OstAdHoc.Assign.5gene.median.t2 <- NA
data.tot@meta.data$OstAdHoc.Assign.x.5gene.median.t2 <- NA
data.tot@meta.data$Cluster.t2 <- NA
i=1
while(i<=length(rownames(data.tot@meta.data))) {
  if(rownames(data.tot@meta.data)[i] %in% compare$cell) {
    data.tot@meta.data$AdHoc.Assign.thresh0.t2[i]              <- as.character(compare$t2.adhoc.0[which(compare$cell==rownames(data.tot@meta.data)[i])])
    data.tot@meta.data$AdHoc.Assign.l.thresh0.t2[i]            <- as.character(compare$t2.adhoc.l0[which(compare$cell==rownames(data.tot@meta.data)[i])])
    data.tot@meta.data$AdHoc.Assign.median.t2[i]               <- as.character(compare$t2.adhoc.m[which(compare$cell==rownames(data.tot@meta.data)[i])])
    data.tot@meta.data$OstAdHoc.Assign.5gene.thresh0.t2[i]     <- as.character(compare$t2.ostadhoc.0[which(compare$cell==rownames(data.tot@meta.data)[i])])
    data.tot@meta.data$OstAdHoc.Assign.x.5gene.thresh0.t2[i]   <- as.character(compare$t2.ostadhoc.x0[which(compare$cell==rownames(data.tot@meta.data)[i])])
    data.tot@meta.data$OstAdHoc.Assign.5gene.l.thresh0.t2[i]   <- as.character(compare$t2.ostadhoc.l0[which(compare$cell==rownames(data.tot@meta.data)[i])])
    data.tot@meta.data$OstAdHoc.Assign.x.5gene.l.thresh0.t2[i] <- as.character(compare$t2.ostadhoc.xl0[which(compare$cell==rownames(data.tot@meta.data)[i])])
    data.tot@meta.data$OstAdHoc.Assign.5gene.median.t2[i]      <- as.character(compare$t2.ostadhoc.m[which(compare$cell==rownames(data.tot@meta.data)[i])])
    data.tot@meta.data$OstAdHoc.Assign.x.5gene.median.t2[i]    <- as.character(compare$t2.ostadhoc.xm[which(compare$cell==rownames(data.tot@meta.data)[i])])
    data.tot@meta.data$Cluster.t2[i]                           <- as.character(compare$t2.cluster[which(compare$cell==rownames(data.tot@meta.data)[i])])
  }
  i=i+1
}

data.tot@meta.data$OstAdHoc.Assign.5gene.thresh0.t2   <- factor(data.tot@meta.data$OstAdHoc.Assign.5gene.thresh0.t2,
                                                                levels=c("preosteoblast","osteoblast","embedding osteoblast","mineralizing osteoblast","maturing osteocyte",
                                                                         "unknown osteogenic","not osteogenic","other"))
data.tot@meta.data$OstAdHoc.Assign.5gene.l.thresh0.t2 <- factor(data.tot@meta.data$OstAdHoc.Assign.5gene.l.thresh0.t2,
                                                                levels=c("preosteoblast","osteoblast","embedding osteoblast","mineralizing osteoblast","maturing osteocyte",
                                                                         "unknown osteogenic","not osteogenic","other"))
data.tot@meta.data$OstAdHoc.Assign.5gene.median.t2    <- factor(data.tot@meta.data$OstAdHoc.Assign.5gene.median.t2,
                                                                levels=c("preosteoblast","osteoblast","embedding osteoblast","mineralizing osteoblast","maturing osteocyte",
                                                                         "unknown osteogenic","not osteogenic","other"))

data.tot@meta.data$OstAdHoc.Assign.x.5gene.thresh0.t2   <- factor(data.tot@meta.data$OstAdHoc.Assign.x.5gene.thresh0.t2,
                                                                  levels=c("preosteoblast","osteoblast","embedding osteoblast","mineralizing osteoblast","maturing osteocyte",
                                                                           "x.osteoblast","x.embedding osteoblast","x.mineralizing osteoblast","x.maturing osteocyte",
                                                                           "unknown osteogenic","not osteogenic","other"))
data.tot@meta.data$OstAdHoc.Assign.x.5gene.l.thresh0.t2 <- factor(data.tot@meta.data$OstAdHoc.Assign.x.5gene.l.thresh0.t2,
                                                                  levels=c("preosteoblast","osteoblast","embedding osteoblast","mineralizing osteoblast","maturing osteocyte",
                                                                           "x.osteoblast","x.embedding osteoblast","x.mineralizing osteoblast","x.maturing osteocyte",
                                                                           "unknown osteogenic","not osteogenic","other"))
data.tot@meta.data$OstAdHoc.Assign.x.5gene.median.t2    <- factor(data.tot@meta.data$OstAdHoc.Assign.x.5gene.median.t2,
                                                                  levels=c("preosteoblast","osteoblast","embedding osteoblast","mineralizing osteoblast","maturing osteocyte",
                                                                           "x.osteoblast","x.embedding osteoblast","x.mineralizing osteoblast","x.maturing osteocyte",
                                                                           "unknown osteogenic","not osteogenic","other"))

CombinePlots(list(DimPlot(data.tot, group.by="Stage", split.by="AdHoc.Assign.thresh0"),
                  DimPlot(data.tot, group.by="Stage", split.by="AdHoc.Assign.thresh0.t2")),
             ncol=1)

CombinePlots(list(DimPlot(data.tot, group.by="Stage", split.by="OstAdHoc.Assign.5gene.thresh0"),
                  DimPlot(data.tot, group.by="Stage", split.by="OstAdHoc.Assign.5gene.thresh0.t2"),
                  DimPlot(data.tot, group.by="Stage", split.by="OstAdHoc.Assign.5gene.l.thresh0.t2"),
                  DimPlot(data.tot, group.by="Stage", split.by="OstAdHoc.Assign.5gene.median.t2")),
             ncol=1)

CombinePlots(list(DimPlot(data.tot, group.by="Stage", split.by="OstAdHoc.Assign.x.5gene.thresh0"),
                  DimPlot(data.tot, group.by="Stage", split.by="OstAdHoc.Assign.x.5gene.thresh0.t2"),
                  DimPlot(data.tot, group.by="Stage", split.by="OstAdHoc.Assign.x.5gene.l.thresh0.t2"),
                  DimPlot(data.tot, group.by="Stage", split.by="OstAdHoc.Assign.x.5gene.median.t2")),
             ncol=1)

CombinePlots(list(DimPlot(data.tot, group.by="Stage", split.by="Cluster"),
                  DimPlot(data.tot, group.by="Stage", split.by="Cluster.t2")),
             ncol=1)

```

Add ad hoc assignments from data.tot assignments to data.t2

```{r}

#Add ad hoc assignments from data.tot assignments to data.t2

compare <- left_join(
  t2 %>%
    dplyr::select(Cell),
  tot %>%
    dplyr::select(Cell,
                  AdHoc.Assign.thresh0,
                  AdHoc.Assign.l.thresh0,
                  AdHoc.Assign.median,
                  OstAdHoc.Assign.5gene.thresh0,
                  OstAdHoc.Assign.x.5gene.thresh0,
                  OstAdHoc.Assign.5gene.l.thresh0,
                  OstAdHoc.Assign.x.5gene.l.thresh0,
                  OstAdHoc.Assign.5gene.median,
                  OstAdHoc.Assign.x.5gene.median,
                  Cluster,
                  Cluster0.25,
                  Cluster0.5),
  by="Cell"
)
colnames(compare) <- c("cell","tot.adhoc.0","tot.adhoc.l0","tot.adhoc.m",
                       "tot.ostadhoc.0","tot.ostadhoc.x0","tot.ostadhoc.l0","tot.ostadhoc.xl0","tot.ostadhoc.m","tot.ostadhoc.xm",
                       "tot.cluster","tot.cluster0.25","tot.cluster0.5")
compare
data.t2@meta.data$AdHoc.Assign.thresh0.tot              <- compare$tot.adhoc.0
data.t2@meta.data$AdHoc.Assign.l.thresh0.tot            <- compare$tot.adhoc.l0
data.t2@meta.data$AdHoc.Assign.median.tot               <- compare$tot.adhoc.m
data.t2@meta.data$OstAdHoc.Assign.5gene.thresh0.tot     <- compare$tot.ostadhoc.0
data.t2@meta.data$OstAdHoc.Assign.x.5gene.thresh0.tot   <- compare$tot.ostadhoc.x0
data.t2@meta.data$OstAdHoc.Assign.5gene.l.thresh0.tot   <- compare$tot.ostadhoc.l0
data.t2@meta.data$OstAdHoc.Assign.x.5gene.l.thresh0.tot <- compare$tot.ostadhoc.xl0
data.t2@meta.data$OstAdHoc.Assign.5gene.median.tot      <- compare$tot.ostadhoc.m
data.t2@meta.data$OstAdHoc.Assign.x.5gene.median.tot    <- compare$tot.ostadhoc.xm
data.t2@meta.data$Cluster.tot                           <- compare$tot.cluster
data.t2@meta.data$Cluster0.25.tot                       <- compare$tot.cluster0.25
data.t2@meta.data$Cluster0.5.tot                        <- compare$tot.cluster0.5

data.t2@meta.data$OstAdHoc.Assign.5gene.thresh0.tot   <- factor(data.t2@meta.data$OstAdHoc.Assign.5gene.thresh0.tot,
                                                                levels=c("preosteoblast","osteoblast","embedding osteoblast","mineralizing osteoblast","maturing osteocyte",
                                                                         "unknown osteogenic","not osteogenic","other"))
data.t2@meta.data$OstAdHoc.Assign.5gene.l.thresh0.tot <- factor(data.t2@meta.data$OstAdHoc.Assign.5gene.l.thresh0.tot,
                                                                levels=c("preosteoblast","osteoblast","embedding osteoblast","mineralizing osteoblast","maturing osteocyte",
                                                                         "unknown osteogenic","not osteogenic","other"))
data.t2@meta.data$OstAdHoc.Assign.5gene.median.tot    <- factor(data.t2@meta.data$OstAdHoc.Assign.5gene.median.tot,
                                                                levels=c("preosteoblast","osteoblast","embedding osteoblast","mineralizing osteoblast","maturing osteocyte",
                                                                         "unknown osteogenic","not osteogenic","other"))

data.t2@meta.data$OstAdHoc.Assign.x.5gene.thresh0.tot   <- factor(data.t2@meta.data$OstAdHoc.Assign.x.5gene.thresh0.tot,
                                                                  levels=c("preosteoblast","osteoblast","embedding osteoblast","mineralizing osteoblast","maturing osteocyte",
                                                                           "x.osteoblast","x.embedding osteoblast","x.mineralizing osteoblast","x.maturing osteocyte",
                                                                           "unknown osteogenic","not osteogenic","other"))
data.t2@meta.data$OstAdHoc.Assign.x.5gene.l.thresh0.tot <- factor(data.t2@meta.data$OstAdHoc.Assign.x.5gene.l.thresh0.tot,
                                                                  levels=c("preosteoblast","osteoblast","embedding osteoblast","mineralizing osteoblast","maturing osteocyte",
                                                                           "x.osteoblast","x.embedding osteoblast","x.mineralizing osteoblast","x.maturing osteocyte",
                                                                           "unknown osteogenic","not osteogenic","other"))
data.t2@meta.data$OstAdHoc.Assign.x.5gene.median.tot    <- factor(data.t2@meta.data$OstAdHoc.Assign.x.5gene.median.tot,
                                                                  levels=c("preosteoblast","osteoblast","embedding osteoblast","mineralizing osteoblast","maturing osteocyte",
                                                                           "x.osteoblast","x.embedding osteoblast","x.mineralizing osteoblast","x.maturing osteocyte",
                                                                           "unknown osteogenic","not osteogenic","other"))

CombinePlots(list(DimPlot(data.t2, group.by="Stage", split.by="AdHoc.Assign.thresh0"),
                  DimPlot(data.t2, group.by="Stage", split.by="AdHoc.Assign.thresh0.tot")),
             ncol=1)

CombinePlots(list(DimPlot(data.t2, group.by="Stage", split.by="OstAdHoc.Assign.5gene.thresh0"),
                  DimPlot(data.t2, group.by="Stage", split.by="OstAdHoc.Assign.5gene.thresh0.tot"),
                  DimPlot(data.t2, group.by="Stage", split.by="OstAdHoc.Assign.5gene.l.thresh0.tot"),
                  DimPlot(data.t2, group.by="Stage", split.by="OstAdHoc.Assign.5gene.median.tot")),
             ncol=1)

CombinePlots(list(DimPlot(data.t2, group.by="Stage", split.by="OstAdHoc.Assign.x.5gene.thresh0"),
                  DimPlot(data.t2, group.by="Stage", split.by="OstAdHoc.Assign.x.5gene.thresh0.tot"),
                  DimPlot(data.t2, group.by="Stage", split.by="OstAdHoc.Assign.x.5gene.l.thresh0.tot"),
                  DimPlot(data.t2, group.by="Stage", split.by="OstAdHoc.Assign.x.5gene.median.tot")),
             ncol=1)

CombinePlots(list(DimPlot(data.t2, group.by="Stage", split.by="Cluster"),
                  DimPlot(data.t2, group.by="Stage", split.by="Cluster.tot")),
             ncol=1)

```

```{r}

saveRDS(data.tot, file="./data/cellranger-data-full/data.filter.log.indv-cell.int19k.reg-tot.assign.rds")
saveRDS(data.t2, file="./data/cellranger-data-full/data.filter.log.indv-cell.int19k.reg-t2.assign.rds")

```
