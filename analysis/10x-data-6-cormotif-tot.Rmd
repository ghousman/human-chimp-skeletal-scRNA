---
title: "10x-data-cormotif-tot"
author: "Genevieve Housman"
date: "October 2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 10X Data Cellranger Analysis - Correlation Motifs

Test for differential expression correlation motifs between stages of cell differentiation in humans and chimpanzees.

```{r, message=FALSE}

#Load libraries
library(Seurat)
library(dplyr)
library(stringi)
library(stringr)
library(ggplot2)
library(grid)
library(gbm)
library(colorspace)
library(RColorBrewer)
library(edgeR)
library(scran)
library(SingleCellExperiment)
library(Cormotif)
library(gplots)

```

```{r}

#Load data
scrna <- "./data/cellranger-data-full/data.filter.log.indv-cell.int19k.reg-tot.assign.rds" #integrate across individuals - total (19k genes + regress out UMI/mito)
#scrna <- "./data/cellranger-data-full/data.filter.log.indv-cell.int19k-tot.assign.rds" #integrate across individuals - total (19k genes)
data <- readRDS(scrna)
data

#Define individual-replicate sets
data@meta.data$Individual.Replicate <- paste0(data@meta.data$Individual,".",data@meta.data$Replicate)

```

Define genes of interest: all except mitochondrial genes and ribosomal genes

```{r}

genes <- rownames(data@assays$RNA@counts)
genes.mito <- c("MT-ATP6","MT-ATP8","MT-CO1","MT-CO2","MT-CO3","MT-CYB","MT-ND1","MT-ND2","MT-ND3","MT-ND4","MT-ND4L","MT-ND5")
genes.ribo <- grep('^RP',genes,value=T)
genes.no.mito.ribo <- genes[which(!(genes %in% c(genes.mito,genes.ribo)))]
rm(genes,genes.mito,genes.ribo)

```

Assemble normalized gene counts and run cormotif.
https://www.biostars.org/p/317701/

### Run Cormotif using Single-Cell Data

```{r}

# Compile log2 normalized gene expression data
#make count matrix and metadata for edgeR object (filter genes across full dataset with pch=0.2)
counts <- as.matrix(GetAssayData(data, assay="RNA", slot="counts"))
metadata <- data@meta.data[,c("Species","Stage",
                              "Cluster","Cluster0.5","Cluster.t2",
                              "AdHoc.Assign.median","AdHoc.Assign.thresh0",
                              "OstAdHoc.Assign.5gene.median","OstAdHoc.Assign.5gene.thresh0","OstAdHoc.Assign.5gene.thresh0.t2")]
metadata <- metadata[colnames(counts),]
#remove mitochodrial and ribosomal genes
counts <- counts[which(rownames(counts) %in% genes.no.mito.ribo),]
#make edgeR object
dge <- DGEList(counts)
meta_dge <- dge$samples[,c("lib.size","norm.factors")]
meta_dge <- cbind(meta_dge, metadata)
dge$samples <- meta_dge
rm(counts,metadata,meta_dge)
#filter genes
dge$counts <- dge$counts[rowSums(dge$counts!=0)>=(0.2*dim(dge$counts)[2]),]
#normalize data
dge <- calcNormFactors(dge, method="TMM")
#log2 transformed cpm
tmm <- edgeR::cpm(dge,normalized.lib.sizes=TRUE,log=TRUE,prior.count=0.25)

```

### SC: Species vs. Stages - 2 time point comparisons each

```{r}

# Compile group labels of each sample
groupFactor <- factor(paste(dge$samples$Species,sapply(dge$samples$Stage,function(x)sub(" ","",x)),sep = "_"),
                      levels=c("Human_Time0","Human_Time1","Human_Time2","Chimp_Time0","Chimp_Time1","Chimp_Time2"))
groupID <- as.numeric(groupFactor)

# Compile comparison pattern
#(condiditions to compare = time0, time1, and time2 for each species)
compareID <- data.frame(c1 = c(1, 2, 4, 5),
                        c2 = c(2, 3, 5, 6))

# Assess differences during differentiation
set.seed(1)
cormotifData <- cormotiffit(exprs = tmm,
                            groupid = groupID,
                            compid = compareID,
                            K = 1:10,
                            max.iter=1000,
                            BIC=FALSE)

#which BIC and AIC are lowest? - 3 motifs
cormotifData$bic
plotIC(cormotifData)
cormotifData$bestmotif$loglike

#what motif patterns were learned by the algorithm
plotMotif(cormotifData)

#posterior probability of DE for each gene
head(cormotifData$bestmotif$p.post)

#obtain DE pattern at 0.5 posterior distribution cutoff
gene.prob <- cormotifData$bestmotif$p.post
rownames(gene.prob) <- rownames(tmm)
colnames(gene.prob) <- c("H.t0-t1","H.t1-t2","C.t0-t1","C.t1-t2")
head(gene.prob)

heatmap.2(gene.prob,
          dendrogram="none",
          Colv=FALSE,
          breaks=c(0,0.2,0.4,0.6,0.8,1),
          col=c("#fef0d9","#fdcc8a","#fc8d59","#e34a33","#b30000"),
          margins=c(3,0),
          trace="none",
          key.title="",
          key.xlab="posterior prob.",
          key.ylab="",
          #ylab=paste0(length(rownames(gene.prob))," genes"),
          keysize=1,
          key.par=list(mar=c(3.5,0,3,0)),
          lmat=rbind(c(5,4,2),c(6,1,3)),
          lhei=c(2.5,5),
          lwid=c(1,10,1),
          labRow=FALSE,
          cexCol=1,
          srtCol=0,
          adjCol=c(0.5,0))

# Test degree of conservation for time 0-2: posterior probability difference between the humans and the chimps within a motif 
#0.3 (5793 genes) -> 87.88%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.3), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.3), ]))/dim(tmm)[1]
#0.2 (5690 genes) -> 86.31%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.2), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.2), ]))/dim(tmm)[1]
#0.1 (5558 genes) -> 84.31%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.1), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.1), ]))/dim(tmm)[1]

# Examine genes from each motif
prob.motif1  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5),])
length(prob.motif1)
head(prob.motif1)
#boxplot(tmm[prob.motif1[1],]~groupFactor)

prob.motif2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5),])
length(prob.motif2)
head(prob.motif2)
#boxplot(tmm[prob.motif2[1],]~groupFactor)

prob.motif3  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5),])
length(prob.motif3)
head(prob.motif3)
#boxplot(tmm[prob.motif3[1],]~groupFactor)

# Examine human/chimp differences
prob.motifC  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5),])
length(prob.motifC)
head(prob.motifC)
#boxplot(tmm[prob.motifC[1],]~groupFactor)

prob.motifC1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5),])
length(prob.motifC1)
head(prob.motifC1)
#boxplot(tmm[prob.motifC1[1],]~groupFactor)

prob.motifC2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5),])
length(prob.motifC2)
head(prob.motifC2)
#boxplot(tmm[prob.motifC2[1],]~groupFactor)

prob.motifH  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motifH)
head(prob.motifH)
#boxplot(tmm[prob.motifH[1],]~groupFactor)

prob.motifH1  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motifH1)
head(prob.motifH1)
#boxplot(tmm[prob.motifH1[1],]~groupFactor)

prob.motifH2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motifH2)
head(prob.motifH2)
#boxplot(tmm[prob.motifH2[1],]~groupFactor)

```

```{r, eval=FALSE}

saveRDS(gene.prob,"./output/cormotif.sc-stage4.data.filter.log.indv-cell.int19k-tot.rds")

```

### Cormotif: Species vs. Stages - 3 time point comparisons

```{r}

# Compile group labels of each sample
groupFactor <- factor(paste(dge$samples$Species,sapply(dge$samples$Stage,function(x)sub(" ","",x)),sep = "_"),
                      levels=c("Human_Time0","Human_Time1","Human_Time2","Chimp_Time0","Chimp_Time1","Chimp_Time2"))
groupID <- as.numeric(groupFactor)

# Compile comparison pattern
#(condiditions to compare = time0, time1, and time2 for each species)
compareID <- data.frame(c1 = c(1, 2, 1, 4, 5, 4),
                        c2 = c(2, 3, 3, 5, 6, 6))

# Assess differences during differentiation
set.seed(1)
cormotifData <- cormotiffit(exprs = tmm,
                            groupid = groupID,
                            compid = compareID,
                            K = 1:10,
                            max.iter=1000,
                            BIC=FALSE)

#which BIC and AIC are lowest? - 1 motif (WHAT?!)
cormotifData$bic
plotIC(cormotifData)
cormotifData$bestmotif$loglike

#what motif patterns were learned by the algorithm
plotMotif(cormotifData)

#posterior probability of DE for each gene
head(cormotifData$bestmotif$p.post)

#obtain DE pattern at 0.5 posterior distribution cutoff
gene.prob <- cormotifData$bestmotif$p.post
rownames(gene.prob) <- rownames(tmm)
colnames(gene.prob) <- c("H.t0-t1","H.t1-t2","H.t0-t2","C.t0-t1","C.t1-t2","C.t0-t2")
head(gene.prob)

heatmap.2(gene.prob,
          dendrogram="none",
          Colv=FALSE,
          breaks=c(0,0.2,0.4,0.6,0.8,1),
          col=c("#fef0d9","#fdcc8a","#fc8d59","#e34a33","#b30000"),
          margins=c(3,0),
          trace="none",
          key.title="",
          key.xlab="posterior prob.",
          key.ylab="",
          #ylab=paste0(length(rownames(gene.prob))," genes"),
          keysize=1,
          key.par=list(mar=c(3.5,0,3,0)),
          lmat=rbind(c(5,4,2),c(6,1,3)),
          lhei=c(2.5,5),
          lwid=c(1,10,1),
          labRow=FALSE,
          cexCol=1,
          srtCol=0,
          adjCol=c(0.5,0))

# Test degree of conservation for time 0-2: posterior probability difference between the humans and the chimps within a motif 
#0.3 (5453 genes) -> 82.72%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.3) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.3), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.3) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.3), ]))/dim(tmm)[1]
#0.2 (5321 genes) -> 80.72%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.2) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.2), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.2) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.2), ]))/dim(tmm)[1]
#0.1 (5143 genes) -> 78.02%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.1) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.1), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.1) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.1), ]))/dim(tmm)[1]

# Examine genes from each motif
prob.motif1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif1)
head(prob.motif1)
#boxplot(tmm[prob.motif1[1],]~groupFactor)

prob.motif2  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 & gene.prob[,5]<0.5 & gene.prob[,6]>0.5),])
length(prob.motif2)
head(prob.motif2)
#boxplot(tmm[prob.motif2[1],]~groupFactor)

prob.motif3  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif3)
head(prob.motif3)
#boxplot(tmm[prob.motif3[1],]~groupFactor)

prob.motif4  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motif4)
head(prob.motif4)
#boxplot(tmm[prob.motif4[1],]~groupFactor)

prob.motif5  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif5)
head(prob.motif5)
#boxplot(tmm[prob.motif5[1],]~groupFactor)

prob.motif6  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]<0.5),])
length(prob.motif6)
head(prob.motif6)
#boxplot(tmm[prob.motif6[1],]~groupFactor)

# Examine human/chimp differences
prob.motifC  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motifC)
head(prob.motifC)
#boxplot(tmm[prob.motifC[1],]~groupFactor)

prob.motifC0  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]<0.5 & gene.prob[,6]>0.5),])
length(prob.motifC0)
head(prob.motifC0)
#boxplot(tmm[prob.motifC0[1],]~groupFactor)

prob.motifC1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]<0.5),])
length(prob.motifC1)
head(prob.motifC1)
#boxplot(tmm[prob.motifC1[1],]~groupFactor)

prob.motifC2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motifC2)
head(prob.motifC2)
#boxplot(tmm[prob.motifC2[1],]~groupFactor)

prob.motifH  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH)
head(prob.motifH)
#boxplot(tmm[prob.motifH[1],]~groupFactor)

prob.motifH0  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH0)
head(prob.motifH0)
#boxplot(tmm[prob.motifH0[1],]~groupFactor)

prob.motifH1  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH1)
head(prob.motifH1)
#boxplot(tmm[prob.motifH1[1],]~groupFactor)

prob.motifH2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH2)
head(prob.motifH2)
#boxplot(tmm[prob.motifH2[1],]~groupFactor)

```

```{r, eval=FALSE}

saveRDS(gene.prob,"./output/cormotif.sc-stage6.data.filter.log.indv-cell.int19k-tot.rds")

```

### SC: Species vs. General Clusters (res=0.05) - 2 time point comparisons each

```{r}

# Compile group labels of each sample
groupFactor <- factor(paste(dge$samples$Species,dge$samples$Cluster,sep="_"),
                      levels=c("Human_iPSC.c1","Human_iPSC.c2","Human_iPSC.c3","Human_MSC.c1","Human_Osteogenic.c1","Human_Osteogenic.c2",
                               "Chimp_iPSC.c1","Chimp_iPSC.c2","Chimp_iPSC.c3","Chimp_MSC.c1","Chimp_Osteogenic.c1","Chimp_Osteogenic.c2"))
groupID <- as.numeric(groupFactor)

# Compile comparison pattern
#(condiditions to compare = time0, time1, and time2 for each species)
compareID <- data.frame(c1 = c(1, 4,  7, 10),
                        c2 = c(4, 5, 10, 11))

# Assess differences during differentiation
set.seed(1)
cormotifData <- cormotiffit(exprs = tmm,
                            groupid = groupID,
                            compid = compareID,
                            K = 1:10,
                            max.iter=1000,
                            BIC=FALSE)

#which BIC and AIC are lowest? - 3 motifs
cormotifData$bic
plotIC(cormotifData)
cormotifData$bestmotif$loglike

#what motif patterns were learned by the algorithm
plotMotif(cormotifData)

#posterior probability of DE for each gene
head(cormotifData$bestmotif$p.post)

#obtain DE pattern at 0.5 posterior distribution cutoff
gene.prob <- cormotifData$bestmotif$p.post
rownames(gene.prob) <- rownames(tmm)
colnames(gene.prob) <- c("H.iPSC.c1-MSC.c1","H.MSC.c1-Osteogenic.c1","C.iPSC.c1-MSC.c1","C.MSC.c1-Osteogenic.c1")
head(gene.prob)

heatmap.2(gene.prob,
          dendrogram="none",
          Colv=FALSE,
          breaks=c(0,0.2,0.4,0.6,0.8,1),
          col=c("#fef0d9","#fdcc8a","#fc8d59","#e34a33","#b30000"),
          margins=c(3,0),
          trace="none",
          key.title="",
          key.xlab="posterior prob.",
          key.ylab="",
          #ylab=paste0(length(rownames(gene.prob))," genes"),
          keysize=1,
          key.par=list(mar=c(3.5,0,3,0)),
          lmat=rbind(c(5,4,2),c(6,1,3)),
          lhei=c(2.5,5),
          lwid=c(1,10,1),
          labRow=FALSE,
          cexCol=1,
          srtCol=0,
          adjCol=c(0.5,0))

# Test degree of conservation for iPSC.c1-Osteogenic.c1: posterior probability difference between the humans and the chimps within a motif 
#0.3 (5168 genes) -> 78.39%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.3), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.3), ]))/dim(tmm)[1]
#0.2 (5045 genes) -> 76.53%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.2), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.2), ]))/dim(tmm)[1]
#0.1 (4868 genes) -> 73.85%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.1), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.1), ]))/dim(tmm)[1]

# Examine genes from each motif
prob.motif1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5),])
length(prob.motif1)
head(prob.motif1)
#boxplot(tmm[prob.motif1[1],]~groupFactor)

prob.motif2  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5),])
length(prob.motif2)
head(prob.motif2)
#boxplot(tmm[prob.motif2[1],]~groupFactor)

prob.motif3  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5),])
length(prob.motif3)
head(prob.motif3)
#boxplot(tmm[prob.motif3[1],]~groupFactor)

# Examine human/chimp differences
prob.motifC  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5),])
length(prob.motifC)
head(prob.motifC)
#boxplot(tmm[prob.motifC[1],]~groupFactor)

prob.motifC1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5),])
length(prob.motifC1)
head(prob.motifC1)
#boxplot(tmm[prob.motifC1[1],]~groupFactor)

prob.motifC2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5),])
length(prob.motifC2)
head(prob.motifC2)
#boxplot(tmm[prob.motifC2[1],]~groupFactor)

prob.motifH  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motifH)
head(prob.motifH)
#boxplot(tmm[prob.motifH[1],]~groupFactor)

prob.motifH1  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motifH1)
head(prob.motifH1)
#boxplot(tmm[prob.motifH1[1],]~groupFactor)

prob.motifH2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motifH2)
head(prob.motifH2)
#boxplot(tmm[prob.motifH2[1],]~groupFactor)

```

```{r, eval=FALSE}

saveRDS(gene.prob,"./output/cormotif.sc-cluster4.data.filter.log.indv-cell.int19k-tot.rds")

```

### Cormotif: Species vs. General Clusters (res=0.05) - 3 time point comparisons

```{r}

# Compile group labels of each sample
groupFactor <- factor(paste(dge$samples$Species,dge$samples$Cluster,sep="_"),
                      levels=c("Human_iPSC.c1","Human_iPSC.c2","Human_iPSC.c3","Human_MSC.c1","Human_Osteogenic.c1","Human_Osteogenic.c2",
                               "Chimp_iPSC.c1","Chimp_iPSC.c2","Chimp_iPSC.c3","Chimp_MSC.c1","Chimp_Osteogenic.c1","Chimp_Osteogenic.c2"))
groupID <- as.numeric(groupFactor)

# Compile comparison pattern
#(condiditions to compare = time0, time1, and time2 for each species)
compareID <- data.frame(c1 = c(1, 4, 1,  7, 10,  7),
                        c2 = c(4, 5, 5, 10, 11, 11))

# Assess differences during differentiation
set.seed(1)
cormotifData <- cormotiffit(exprs = tmm,
                            groupid = groupID,
                            compid = compareID,
                            K = 1:10,
                            max.iter=1000,
                            BIC=FALSE)

#which BIC and AIC are lowest? - 1 motif (WHAT?!)
cormotifData$bic
plotIC(cormotifData)
cormotifData$bestmotif$loglike

#what motif patterns were learned by the algorithm
plotMotif(cormotifData)

#posterior probability of DE for each gene
head(cormotifData$bestmotif$p.post)

#obtain DE pattern at 0.5 posterior distribution cutoff
gene.prob <- cormotifData$bestmotif$p.post
rownames(gene.prob) <- rownames(tmm)
colnames(gene.prob) <- c("H.iPSC.c1-MSC.c1","H.MSC.c1-Osteogenic.c1","H.iPSC.c1-Osteogenic.c1","C.iPSC.c1-MSC.c1","C.MSC.c1-Osteogenic.c1","C.iPSC.c1-Osteogenic.c1")
head(gene.prob)

heatmap.2(gene.prob,
          dendrogram="none",
          Colv=FALSE,
          breaks=c(0,0.2,0.4,0.6,0.8,1),
          col=c("#fef0d9","#fdcc8a","#fc8d59","#e34a33","#b30000"),
          margins=c(3,0),
          trace="none",
          key.title="",
          key.xlab="posterior prob.",
          key.ylab="",
          #ylab=paste0(length(rownames(gene.prob))," genes"),
          keysize=1,
          key.par=list(mar=c(3.5,0,3,0)),
          lmat=rbind(c(5,4,2),c(6,1,3)),
          lhei=c(2.5,5),
          lwid=c(1,10,1),
          labRow=FALSE,
          cexCol=1,
          srtCol=0,
          adjCol=c(0.5,0))

# Test degree of conservation for iPSC.c1-Osteogenic.c1: posterior probability difference between the humans and the chimps within a motif 
#0.3 (4840 genes) -> 73.42%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.3) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.3), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.3) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.3), ]))/dim(tmm)[1]
#0.2 (4699 genes) -> 71.28%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.2) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.2), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.2) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.2), ]))/dim(tmm)[1]
#0.1 (4502 genes) -> 68.29%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.1) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.1), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.1) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.1), ]))/dim(tmm)[1]

# Examine genes from each motif
prob.motif1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif1)
head(prob.motif1)
#boxplot(tmm[prob.motif1[1],]~groupFactor)

prob.motif2  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif2)
head(prob.motif2)
#boxplot(tmm[prob.motif2[1],]~groupFactor)

prob.motif3  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motif3)
head(prob.motif3)
#boxplot(tmm[prob.motif3[1],]~groupFactor)

prob.motif4  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif4)
head(prob.motif4)
#boxplot(tmm[prob.motif4[1],]~groupFactor)

prob.motif5  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif5)
head(prob.motif5)
#boxplot(tmm[prob.motif5[1],]~groupFactor)

#boxplot(tmm[prob.motif6[1],]~groupFactor)
# Examine human/chimp differences
prob.motifC  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motifC)
head(prob.motifC)
#boxplot(tmm[prob.motifC[1],]~groupFactor)

prob.motifC0  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]<0.5 & gene.prob[,6]>0.5),])
length(prob.motifC0)
head(prob.motifC0)
#boxplot(tmm[prob.motifC0[1],]~groupFactor)

prob.motifC1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]<0.5),])
length(prob.motifC1)
head(prob.motifC1)
#boxplot(tmm[prob.motifC1[1],]~groupFactor)

prob.motifC2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motifC2)
head(prob.motifC2)
#boxplot(tmm[prob.motifC2[1],]~groupFactor)

prob.motifH  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH)
head(prob.motifH)
#boxplot(tmm[prob.motifH[1],]~groupFactor)

prob.motifH0  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH0)
head(prob.motifH0)
#boxplot(tmm[prob.motifH0[1],]~groupFactor)

prob.motifH1  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH1)
head(prob.motifH1)
#boxplot(tmm[prob.motifH1[1],]~groupFactor)

prob.motifH2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH2)
head(prob.motifH2)
#boxplot(tmm[prob.motifH2[1],]~groupFactor)

```

```{r, eval=FALSE}

saveRDS(gene.prob,"./output/cormotif.sc-cluster6.data.filter.log.indv-cell.int19k-tot.rds")

```

### SC: Species vs. General Ad Hoc Classifications (thresh0) - 2 time point comparisons each

```{r}

# Compile group labels of each sample
groupFactor <- factor(paste(dge$samples$Species,dge$samples$AdHoc.Assign.thresh0,sep = "_"),
                      levels=c("Human_iPSC","Human_MSC","Human_Osteogenic","Human_other","Chimp_iPSC","Chimp_MSC","Chimp_Osteogenic","Chimp_other"))
groupID <- as.numeric(groupFactor)

# Compile comparison pattern
#(condiditions to compare = time0, time1, and time2 for each species)
compareID <- data.frame(c1 = c(1, 2, 4, 5),
                        c2 = c(2, 3, 5, 6))

# Assess differences during differentiation
set.seed(1)
cormotifData <- cormotiffit(exprs = tmm,
                            groupid = groupID,
                            compid = compareID,
                            K = 1:10,
                            max.iter=1000,
                            BIC=FALSE)

#which BIC and AIC are lowest? - 2 motifs
cormotifData$bic
plotIC(cormotifData)
cormotifData$bestmotif$loglike

#what motif patterns were learned by the algorithm
plotMotif(cormotifData)

#posterior probability of DE for each gene
head(cormotifData$bestmotif$p.post)

#obtain DE pattern at 0.5 posterior distribution cutoff
gene.prob <- cormotifData$bestmotif$p.post
rownames(gene.prob) <- rownames(tmm)
colnames(gene.prob) <- c("H.iPSC-MSC","H.MSC-Osteogenic","C.iPSC-MSC","C.MSC-Osteogenic")
head(gene.prob)

heatmap.2(gene.prob,
          dendrogram="none",
          Colv=FALSE,
          breaks=c(0,0.2,0.4,0.6,0.8,1),
          col=c("#fef0d9","#fdcc8a","#fc8d59","#e34a33","#b30000"),
          margins=c(3,0),
          trace="none",
          key.title="",
          key.xlab="posterior prob.",
          key.ylab="",
          #ylab=paste0(length(rownames(gene.prob))," genes"),
          keysize=1,
          key.par=list(mar=c(3.5,0,3,0)),
          lmat=rbind(c(5,4,2),c(6,1,3)),
          lhei=c(2.5,5),
          lwid=c(1,10,1),
          labRow=FALSE,
          cexCol=1,
          srtCol=0,
          adjCol=c(0.5,0))

# Test degree of conservation for iPSCs-Osteogenic cells: posterior probability difference between the humans and the chimps within a motif 
#0.3 (4834 genes) -> 73.33%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.3), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.3), ]))/dim(tmm)[1]
#0.2 (4685 genes) -> 71.07%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.2), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.2), ]))/dim(tmm)[1]
#0.1 (4507 genes) -> 68.37%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.1), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.1), ]))/dim(tmm)[1]

# Examine genes from each motif
prob.motif1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5),])
length(prob.motif1)
head(prob.motif1)
#boxplot(tmm[prob.motif1[1],]~groupFactor)

prob.motif2  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5),])
length(prob.motif2)
head(prob.motif2)
#boxplot(tmm[prob.motif2[1],]~groupFactor)

# Examine human/chimp differences
prob.motifC  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5),])
length(prob.motifC)
head(prob.motifC)
#boxplot(tmm[prob.motifC[1],]~groupFactor)

prob.motifC1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5),])
length(prob.motifC1)
head(prob.motifC1)
#boxplot(tmm[prob.motifC1[1],]~groupFactor)

prob.motifC2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5),])
length(prob.motifC2)
head(prob.motifC2)
#boxplot(tmm[prob.motifC2[1],]~groupFactor)

prob.motifH  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motifH)
head(prob.motifH)
#boxplot(tmm[prob.motifH[1],]~groupFactor)

prob.motifH1  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motifH1)
head(prob.motifH1)
#boxplot(tmm[prob.motifH1[1],]~groupFactor)

prob.motifH2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motifH2)
head(prob.motifH2)
#boxplot(tmm[prob.motifH2[1],]~groupFactor)

```

```{r, eval=FALSE}

saveRDS(gene.prob,"./output/cormotif.sc-adhoc.thresh0-4.data.filter.log.indv-cell.int19k-tot.rds")

```

### Cormotif: Species vs. General Ad Hoc Classifications (thresh0) - 3 time point comparisons

```{r}

# Compile group labels of each sample
groupFactor <- factor(paste(dge$samples$Species,dge$samples$AdHoc.Assign.thresh0,sep = "_"),
                      levels=c("Human_iPSC","Human_MSC","Human_Osteogenic","Human_other","Chimp_iPSC","Chimp_MSC","Chimp_Osteogenic","Chimp_other"))
groupID <- as.numeric(groupFactor)

# Compile comparison pattern
#(condiditions to compare = time0, time1, and time2 for each species)
compareID <- data.frame(c1 = c(1, 2, 1, 4, 5, 4),
                        c2 = c(2, 3, 3, 5, 6, 6))

# Assess differences during differentiation
set.seed(1)
cormotifData <- cormotiffit(exprs = tmm,
                            groupid = groupID,
                            compid = compareID,
                            K = 1:10,
                            max.iter=1000,
                            BIC=FALSE)

#which BIC and AIC are lowest? - 5 motifs
cormotifData$bic
plotIC(cormotifData)
cormotifData$bestmotif$loglike

#what motif patterns were learned by the algorithm
plotMotif(cormotifData)

#posterior probability of DE for each gene
head(cormotifData$bestmotif$p.post)

#obtain DE pattern at 0.5 posterior distribution cutoff
gene.prob <- cormotifData$bestmotif$p.post
rownames(gene.prob) <- rownames(tmm)
colnames(gene.prob) <- c("H.iPSC-MSC","H.MSC-Osteogenic","H.iPSC-Osteogenic","C.iPSC-MSC","C.MSC-Osteogenic","C.iPSC-Osteogenic")
head(gene.prob)

heatmap.2(gene.prob,
          dendrogram="none",
          Colv=FALSE,
          breaks=c(0,0.2,0.4,0.6,0.8,1),
          col=c("#fef0d9","#fdcc8a","#fc8d59","#e34a33","#b30000"),
          margins=c(3,0),
          trace="none",
          key.title="",
          key.xlab="posterior prob.",
          key.ylab="",
          #ylab=paste0(length(rownames(gene.prob))," genes"),
          keysize=1,
          key.par=list(mar=c(3.5,0,3,0)),
          lmat=rbind(c(5,4,2),c(6,1,3)),
          lhei=c(2.5,5),
          lwid=c(1,10,1),
          labRow=FALSE,
          cexCol=1,
          srtCol=0,
          adjCol=c(0.5,0))

# Test degree of conservation for iPSCs-Osteogenic cells: posterior probability difference between the humans and the chimps within a motif 
#0.3 (4427 genes) -> 67.16%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.3) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.3), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.3) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.3), ]))/dim(tmm)[1]
#0.2 (4253 genes) -> 64.52%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.2) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.2), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.2) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.2), ]))/dim(tmm)[1]
#0.1 (4031 genes) -> 61.15%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.1) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.1), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.1) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.1), ]))/dim(tmm)[1]

# Examine genes from each motif
prob.motif1  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motif1)
head(prob.motif1)
#boxplot(tmm[prob.motif1[1],]~groupFactor)

prob.motif2  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif2)
head(prob.motif2)
#boxplot(tmm[prob.motif2[1],]~groupFactor)

prob.motif3  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]<0.5 & gene.prob[,6]>0.5),])
length(prob.motif3)
head(prob.motif3)
#boxplot(tmm[prob.motif3[1],]~groupFactor)

prob.motif4  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif4)
head(prob.motif4)
#boxplot(tmm[prob.motif4[1],]~groupFactor)

prob.motif5  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif5)
head(prob.motif5)
#boxplot(tmm[prob.motif5[1],]~groupFactor)

# Examine human/chimp differences
prob.motifC  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motifC)
head(prob.motifC)
#boxplot(tmm[prob.motifC[1],]~groupFactor)

prob.motifC0  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]<0.5 & gene.prob[,6]>0.5),])
length(prob.motifC0)
head(prob.motifC0)
#boxplot(tmm[prob.motifC0[1],]~groupFactor)

prob.motifC1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]<0.5),])
length(prob.motifC1)
head(prob.motifC1)
#boxplot(tmm[prob.motifC1[1],]~groupFactor)

prob.motifC2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motifC2)
head(prob.motifC2)
#boxplot(tmm[prob.motifC2[1],]~groupFactor)

prob.motifH  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH)
head(prob.motifH)
#boxplot(tmm[prob.motifH[1],]~groupFactor)

prob.motifH0  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH0)
head(prob.motifH0)
#boxplot(tmm[prob.motifH0[1],]~groupFactor)

prob.motifH1  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH1)
head(prob.motifH1)
#boxplot(tmm[prob.motifH1[1],]~groupFactor)

prob.motifH2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH2)
head(prob.motifH2)
#boxplot(tmm[prob.motifH2[1],]~groupFactor)

```

```{r, eval=FALSE}

saveRDS(gene.prob,"./output/cormotif.sc-adhoc.thresh0-6.data.filter.log.indv-cell.int19k-tot.rds")

```

### SC: Species vs. General Ad Hoc Classifications (median) - 2 time point comparisons each

```{r, eval=FALSE}

# Compile group labels of each sample
groupFactor <- factor(paste(dge$samples$Species,dge$samples$AdHoc.Assign.median,sep = "_"),
                      levels=c("Human_iPSC","Human_MSC","Human_Osteogenic","Human_other","Chimp_iPSC","Chimp_MSC","Chimp_Osteogenic","Chimp_other"))
groupID <- as.numeric(groupFactor)

# Compile comparison pattern
#(condiditions to compare = time0, time1, and time2 for each species)
compareID <- data.frame(c1 = c(1, 2, 4, 5),
                        c2 = c(2, 3, 5, 6))

# Assess differences during differentiation
set.seed(1)
cormotifData <- cormotiffit(exprs = tmm,
                            groupid = groupID,
                            compid = compareID,
                            K = 1:10,
                            max.iter=1000,
                            BIC=FALSE)

#which BIC and AIC are lowest? - 3 motifs
cormotifData$bic
plotIC(cormotifData)
cormotifData$bestmotif$loglike

#what motif patterns were learned by the algorithm
plotMotif(cormotifData)

#posterior probability of DE for each gene
head(cormotifData$bestmotif$p.post)

#obtain DE pattern at 0.5 posterior distribution cutoff
gene.prob <- cormotifData$bestmotif$p.post
rownames(gene.prob) <- rownames(tmm)
colnames(gene.prob) <- c("H.iPSC-MSC","H.MSC-Osteogenic","C.iPSC-MSC","C.MSC-Osteogenic")
head(gene.prob)

heatmap.2(gene.prob,
          dendrogram="none",
          Colv=FALSE,
          breaks=c(0,0.2,0.4,0.6,0.8,1),
          col=c("#fef0d9","#fdcc8a","#fc8d59","#e34a33","#b30000"),
          margins=c(3,0),
          trace="none",
          key.title="",
          key.xlab="posterior prob.",
          key.ylab="",
          #ylab=paste0(length(rownames(gene.prob))," genes"),
          keysize=1,
          key.par=list(mar=c(3.5,0,3,0)),
          lmat=rbind(c(5,4,2),c(6,1,3)),
          lhei=c(2.5,5),
          lwid=c(1,10,1),
          labRow=FALSE,
          cexCol=1,
          srtCol=0,
          adjCol=c(0.5,0))

# Test degree of conservation for iPSCs-Osteogenic cells: posterior probability difference between the humans and the chimps within a motif 
#0.3 (3094 genes) -> 46.94%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.3), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.3), ]))/dim(tmm)[1]
#0.2 (2842 genes) -> 43.11%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.2), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.2), ]))/dim(tmm)[1]
#0.1 (2559 genes) -> 38.82%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.1), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.1), ]))/dim(tmm)[1]

# Examine genes from each motif
prob.motif1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5),])
length(prob.motif1)
head(prob.motif1)
#boxplot(tmm[prob.motif1[1],]~groupFactor)

prob.motif2  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5),])
length(prob.motif2)
head(prob.motif2)
#boxplot(tmm[prob.motif2[1],]~groupFactor)

# Examine human/chimp differences
prob.motifC  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5),])
length(prob.motifC)
head(prob.motifC)
#boxplot(tmm[prob.motifC[1],]~groupFactor)

prob.motifC1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5),])
length(prob.motifC1)
head(prob.motifC1)
#boxplot(tmm[prob.motifC1[1],]~groupFactor)

prob.motifC2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5),])
length(prob.motifC2)
head(prob.motifC2)
#boxplot(tmm[prob.motifC2[1],]~groupFactor)

prob.motifH  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motifH)
head(prob.motifH)
#boxplot(tmm[prob.motifH[1],]~groupFactor)

prob.motifH1  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motifH1)
head(prob.motifH1)
#boxplot(tmm[prob.motifH1[1],]~groupFactor)

prob.motifH2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motifH2)
head(prob.motifH2)
#boxplot(tmm[prob.motifH2[1],]~groupFactor)

```

```{r, eval=FALSE}

saveRDS(gene.prob,"./output/cormotif.sc-adhoc4.data.filter.log.indv-cell.int19k-tot.rds")

```

### Cormotif: Species vs. General Ad Hoc Classifications (median) - 3 time point comparisons

```{r, eval=FALSE}

# Compile group labels of each sample
groupFactor <- factor(paste(dge$samples$Species,dge$samples$AdHoc.Assign.median,sep = "_"),
                      levels=c("Human_iPSC","Human_MSC","Human_Osteogenic","Human_other","Chimp_iPSC","Chimp_MSC","Chimp_Osteogenic","Chimp_other"))
groupID <- as.numeric(groupFactor)

# Compile comparison pattern
#(condiditions to compare = time0, time1, and time2 for each species)
compareID <- data.frame(c1 = c(1, 2, 1, 4, 5, 4),
                        c2 = c(2, 3, 3, 5, 6, 6))

# Assess differences during differentiation
set.seed(1)
cormotifData <- cormotiffit(exprs = tmm,
                            groupid = groupID,
                            compid = compareID,
                            K = 1:10,
                            max.iter=1000,
                            BIC=FALSE)

#which BIC and AIC are lowest? - 1 motif (WHAT?!)
cormotifData$bic
plotIC(cormotifData)
cormotifData$bestmotif$loglike

#what motif patterns were learned by the algorithm
plotMotif(cormotifData)

#posterior probability of DE for each gene
head(cormotifData$bestmotif$p.post)

#obtain DE pattern at 0.5 posterior distribution cutoff
gene.prob <- cormotifData$bestmotif$p.post
rownames(gene.prob) <- rownames(tmm)
colnames(gene.prob) <- c("H.iPSC-MSC","H.MSC-Osteogenic","H.iPSC-Osteogenic","C.iPSC-MSC","C.MSC-Osteogenic","C.iPSC-Osteogenic")
head(gene.prob)

heatmap.2(gene.prob,
          dendrogram="none",
          Colv=FALSE,
          breaks=c(0,0.2,0.4,0.6,0.8,1),
          col=c("#fef0d9","#fdcc8a","#fc8d59","#e34a33","#b30000"),
          margins=c(3,0),
          trace="none",
          key.title="",
          key.xlab="posterior prob.",
          key.ylab="",
          #ylab=paste0(length(rownames(gene.prob))," genes"),
          keysize=1,
          key.par=list(mar=c(3.5,0,3,0)),
          lmat=rbind(c(5,4,2),c(6,1,3)),
          lhei=c(2.5,5),
          lwid=c(1,10,1),
          labRow=FALSE,
          cexCol=1,
          srtCol=0,
          adjCol=c(0.5,0))

# Test degree of conservation for iPSCs-Osteogenic cells: posterior probability difference between the humans and the chimps within a motif 
#0.3 (2680 genes) -> 40.66%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.3) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.3), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.3) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.3), ]))/dim(tmm)[1]
#0.2 (2421 genes) -> 36.73%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.2) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.2), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.2) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.2), ]))/dim(tmm)[1]
#0.1 (2147 genes) -> 32.57%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.1) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.1), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.1) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.1), ]))/dim(tmm)[1]

# Examine genes from each motif
prob.motif1  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motif1)
head(prob.motif1)
#boxplot(tmm[prob.motif1[1],]~groupFactor)

prob.motif2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif2)
head(prob.motif2)
#boxplot(tmm[prob.motif2[1],]~groupFactor)

prob.motif3  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif3)
head(prob.motif3)
#boxplot(tmm[prob.motif3[1],]~groupFactor)

prob.motif4  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 & gene.prob[,5]<0.5 & gene.prob[,6]>0.5),])
length(prob.motif4)
head(prob.motif4)
#boxplot(tmm[prob.motif4[1],]~groupFactor)

prob.motif5  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif5)
head(prob.motif5)
#boxplot(tmm[prob.motif5[1],]~groupFactor)

prob.motif6  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif6)
head(prob.motif6)
#boxplot(tmm[prob.motif6[1],]~groupFactor)

prob.motif7  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif7)
head(prob.motif7)
#boxplot(tmm[prob.motif7[1],]~groupFactor)

prob.motif8  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]<0.5),])
length(prob.motif8)
head(prob.motif8)
#boxplot(tmm[prob.motif8[1],]~groupFactor)

# Examine human/chimp differences
prob.motifC  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motifC)
head(prob.motifC)
#boxplot(tmm[prob.motifC[1],]~groupFactor)

prob.motifC0  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]<0.5 & gene.prob[,6]>0.5),])
length(prob.motifC0)
head(prob.motifC0)
#boxplot(tmm[prob.motifC0[1],]~groupFactor)

prob.motifC1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]<0.5),])
length(prob.motifC1)
head(prob.motifC1)
#boxplot(tmm[prob.motifC1[1],]~groupFactor)

prob.motifC2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motifC2)
head(prob.motifC2)
#boxplot(tmm[prob.motifC2[1],]~groupFactor)

prob.motifH  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH)
head(prob.motifH)
#boxplot(tmm[prob.motifH[1],]~groupFactor)

prob.motifH0  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH0)
head(prob.motifH0)
#boxplot(tmm[prob.motifH0[1],]~groupFactor)

prob.motifH1  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH1)
head(prob.motifH1)
#boxplot(tmm[prob.motifH1[1],]~groupFactor)

prob.motifH2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH2)
head(prob.motifH2)
#boxplot(tmm[prob.motifH2[1],]~groupFactor)

```

```{r, eval=FALSE}

saveRDS(gene.prob,"./output/cormotif.sc-adhoc6.data.filter.log.indv-cell.int19k-tot.rds")

```

### SC: Species vs. Osteogenic Clusters (res=0.5) - 3 time point comparisons each

```{r}

# Compile group labels of each sample
groupFactor <- factor(paste(dge$samples$Species,dge$samples$Cluster0.5,sep="_"),
                      levels=c("Human_Osteogenic.c1","Human_Osteogenic.c2","Human_Osteogenic.c3","Human_Osteogenic.c5",
                               "Chimp_Osteogenic.c1","Chimp_Osteogenic.c2","Chimp_Osteogenic.c3","Chimp_Osteogenic.c5"))
groupID <- as.numeric(groupFactor)

# Compile comparison pattern
#(condiditions to compare = c1, c2, c3, and c5 for each species)
compareID <- data.frame(c1 = c(1, 2, 3, 5, 6, 7),
                        c2 = c(2, 3, 4, 6, 7, 8))

# Assess differences during differentiation
set.seed(1)
cormotifData <- cormotiffit(exprs = tmm,
                            groupid = groupID,
                            compid = compareID,
                            K = 1:10,
                            max.iter=1000,
                            BIC=FALSE)

#which BIC and AIC are lowest? - 5 motifs
cormotifData$bic
plotIC(cormotifData)
cormotifData$bestmotif$loglike

#what motif patterns were learned by the algorithm
plotMotif(cormotifData)

#posterior probability of DE for each gene
head(cormotifData$bestmotif$p.post)

#obtain DE pattern at 0.5 posterior distribution cutoff
gene.prob <- cormotifData$bestmotif$p.post
rownames(gene.prob) <- rownames(tmm)
colnames(gene.prob) <- c("H.ost.c1-c2","H.ost.c2-c3","H.ost.c3-c5","C.ost.c1-c2","C.ost.c2-c3","C.ost.c3-c5")
head(gene.prob)

heatmap.2(gene.prob,
          dendrogram="none",
          Colv=FALSE,
          breaks=c(0,0.2,0.4,0.6,0.8,1),
          col=c("#fef0d9","#fdcc8a","#fc8d59","#e34a33","#b30000"),
          margins=c(3,0),
          trace="none",
          key.title="",
          key.xlab="posterior prob.",
          key.ylab="",
          #ylab=paste0(length(rownames(gene.prob))," genes"),
          keysize=1,
          key.par=list(mar=c(3.5,0,3,0)),
          lmat=rbind(c(5,4,2),c(6,1,3)),
          lhei=c(2.5,5),
          lwid=c(1,10,1),
          labRow=FALSE,
          cexCol=1,
          srtCol=0,
          adjCol=c(0.5,0))

# Test degree of conservation for iPSCs-Osteogenic cells: posterior probability difference between the humans and the chimps within a motif 
#0.3 (3490 genes) -> 52.94%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.3) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.3), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.3) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.3), ]))/dim(tmm)[1]
#0.2 (3078 genes) -> 46.69%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.2) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.2), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.2) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.2), ]))/dim(tmm)[1]
#0.1 (2428 genes) -> 36.83%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.1) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.1), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.1) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.1), ]))/dim(tmm)[1]

# Examine genes from each motif
prob.motif1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motif1)
head(prob.motif1)
#boxplot(tmm[prob.motif1[1],]~groupFactor)

prob.motif2  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif2)
head(prob.motif2)
#boxplot(tmm[prob.motif2[1],]~groupFactor)

prob.motif3  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]>0.5 & gene.prob[,6]<0.5),])
length(prob.motif3)
head(prob.motif3)
#boxplot(tmm[prob.motif3[1],]~groupFactor)

prob.motif4  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif4)
head(prob.motif4)
#boxplot(tmm[prob.motif4[1],]~groupFactor)

prob.motif5  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]<0.5),])
length(prob.motif5)
head(prob.motif5)
#boxplot(tmm[prob.motif5[1],]~groupFactor)

# Examine human/chimp differences
prob.motifC  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motifC)
head(prob.motifC)
#boxplot(tmm[prob.motifC[1],]~groupFactor)

prob.motifH  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH)
head(prob.motifH)
#boxplot(tmm[prob.motifH[1],]~groupFactor)

```

```{r, eval=FALSE}

saveRDS(gene.prob,"./output/cormotif.sc-cluster0.05-6.data.filter.log.indv-cell.int19k-tot.rds")

```

### SC: Species vs. Osteogenic Clusters (t2 with res=0.1) - 3 time point comparisons each

```{r, eval=FALSE}

# Compile group labels of each sample
groupFactor <- factor(paste(dge$samples$Species,dge$samples$Cluster.t2,sep="_"),
                      levels=c("Human_Osteogenic.c1","Human_Osteogenic.c2","Human_Osteogenic.c3","Human_Osteogenic.c5",
                               "Chimp_Osteogenic.c1","Chimp_Osteogenic.c2","Chimp_Osteogenic.c3","Chimp_Osteogenic.c5"))
groupID <- as.numeric(groupFactor)

# Compile comparison pattern
#(condiditions to compare = c1, c2, c3, and c5 for each species)
compareID <- data.frame(c1 = c(1, 2, 3, 5, 6, 7),
                        c2 = c(2, 3, 4, 6, 7, 8))

# Assess differences during differentiation
set.seed(1)
cormotifData <- cormotiffit(exprs = tmm,
                            groupid = groupID,
                            compid = compareID,
                            K = 1:10,
                            max.iter=1000,
                            BIC=FALSE)

#which BIC and AIC are lowest? - 5 motifs
cormotifData$bic
plotIC(cormotifData)
cormotifData$bestmotif$loglike

#what motif patterns were learned by the algorithm
plotMotif(cormotifData)

#posterior probability of DE for each gene
head(cormotifData$bestmotif$p.post)

#obtain DE pattern at 0.5 posterior distribution cutoff
gene.prob <- cormotifData$bestmotif$p.post
rownames(gene.prob) <- rownames(tmm)
colnames(gene.prob) <- c("H.ost.c1-c2","H.ost.c2-c3","H.ost.c3-c5","C.ost.c1-c2","C.ost.c2-c3","C.ost.c3-c5")
head(gene.prob)

heatmap.2(gene.prob,
          dendrogram="none",
          Colv=FALSE,
          breaks=c(0,0.2,0.4,0.6,0.8,1),
          col=c("#fef0d9","#fdcc8a","#fc8d59","#e34a33","#b30000"),
          margins=c(3,0),
          trace="none",
          key.title="",
          key.xlab="posterior prob.",
          key.ylab="",
          #ylab=paste0(length(rownames(gene.prob))," genes"),
          keysize=1,
          key.par=list(mar=c(3.5,0,3,0)),
          lmat=rbind(c(5,4,2),c(6,1,3)),
          lhei=c(2.5,5),
          lwid=c(1,10,1),
          labRow=FALSE,
          cexCol=1,
          srtCol=0,
          adjCol=c(0.5,0))

# Test degree of conservation for iPSCs-Osteogenic cells: posterior probability difference between the humans and the chimps within a motif 
#0.3 (2769 genes) -> 42.01%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.3) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.3), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.3) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.3), ]))/dim(tmm)[1]
#0.2 (2419 genes) -> 36.70%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.2) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.2), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.2) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.2), ]))/dim(tmm)[1]
#0.1 (1942 genes) -> 29.46%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.1) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.1), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.1) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.1), ]))/dim(tmm)[1]

# Examine genes from each motif
prob.motif1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motif1)
head(prob.motif1)
#boxplot(tmm[prob.motif1[1],]~groupFactor)

prob.motif2  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif2)
head(prob.motif2)
#boxplot(tmm[prob.motif2[1],]~groupFactor)

prob.motif3  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif3)
head(prob.motif3)
#boxplot(tmm[prob.motif3[1],]~groupFactor)

prob.motif4  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]>0.5),])
length(prob.motif4)
head(prob.motif4)
#boxplot(tmm[prob.motif4[1],]~groupFactor)

prob.motif5  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif5)
head(prob.motif5)
#boxplot(tmm[prob.motif5[1],]~groupFactor)

# Examine human/chimp differences
prob.motifC  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motifC)
head(prob.motifC)
#boxplot(tmm[prob.motifC[1],]~groupFactor)

prob.motifH  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH)
head(prob.motifH)
#boxplot(tmm[prob.motifH[1],]~groupFactor)

```

```{r, eval=FALSE}

saveRDS(gene.prob,"./output/cormotif.sc-cluster.t2-6.data.filter.log.indv-cell.int19k-tot.rds")

```

### Cormotif: Species vs. Osteogenic Ad Hoc Classifications (thresh0) - 4 time point comparisons

```{r}

# Compile group labels of each sample
groupFactor <- factor(paste(dge$samples$Species,sapply(dge$samples$OstAdHoc.Assign.5gene.thresh0,function(x)sub(" ",".",x)),sep="_"),
                      levels=c("Human_preosteoblast","Human_osteoblast","Human_embedding.osteoblast","Human_mineralizing.osteoblast","Human_maturing.osteocyte",
                               "Human_unknown.osteogenic","Human_not.osteogenic",
                               "Chimp_preosteoblast","Chimp_osteoblast","Chimp_embedding.osteoblast","Chimp_mineralizing.osteoblast","Chimp_maturing.osteocyte",
                               "Chimp_unknown.osteogenic","Chimp_not.osteogenic"))
groupID <- as.numeric(groupFactor)

# Compile comparison pattern
#(condiditions to compare = time0, time1, and time2 for each species)
compareID <- data.frame(c1 = c(1, 2, 3, 4, 8,  9, 10, 11),
                        c2 = c(2, 3, 4, 5, 9, 10, 11, 12))

# Assess differences during differentiation
set.seed(1)
cormotifData <- cormotiffit(exprs = tmm,
                            groupid = groupID,
                            compid = compareID,
                            K = 1:10,
                            max.iter=1000,
                            BIC=FALSE)

#which BIC and AIC are lowest? - 6 motifs
cormotifData$bic
plotIC(cormotifData)
cormotifData$bestmotif$loglike

#what motif patterns were learned by the algorithm
plotMotif(cormotifData)

#posterior probability of DE for each gene
head(cormotifData$bestmotif$p.post)

#obtain DE pattern at 0.5 posterior distribution cutoff
gene.prob <- cormotifData$bestmotif$p.post
rownames(gene.prob) <- rownames(tmm)
colnames(gene.prob) <- c("H.pre-obl","H.obl-emb","H.emb-min","H.min-mat","C.pre-obl","C.obl-emb","C.emb-min","C.min-mat")
head(gene.prob)

heatmap.2(gene.prob,
          dendrogram="none",
          Colv=FALSE,
          breaks=c(0,0.2,0.4,0.6,0.8,1),
          col=c("#fef0d9","#fdcc8a","#fc8d59","#e34a33","#b30000"),
          margins=c(3,0),
          trace="none",
          key.title="",
          key.xlab="posterior prob.",
          key.ylab="",
          #ylab=paste0(length(rownames(gene.prob))," genes"),
          keysize=1,
          key.par=list(mar=c(3.5,0,3,0)),
          lmat=rbind(c(5,4,2),c(6,1,3)),
          lhei=c(2.5,5),
          lwid=c(1,10,1),
          labRow=FALSE,
          cexCol=1,
          srtCol=0,
          adjCol=c(0.5,0))

# Test degree of conservation for preosteoblasts-maturing osteocytes: posterior probability difference between the humans and the chimps within a motif 
#0.3 (400 genes) ->  6.07%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.3) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.3) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.3) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.3), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.3) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.3) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.3) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.3), ]))/dim(tmm)[1]
#0.2 (212 genes) ->  3.22%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.2) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.2) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.2) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.2), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.2) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.2) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.2) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.2), ]))/dim(tmm)[1]
#0.1 ( 43 genes) ->  0.65%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.1) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.1) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.1) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.1), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.1) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.1) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.1) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.1), ]))/dim(tmm)[1]

# Examine genes from each motif
prob.motif1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motif1)
head(prob.motif1)
#boxplot(tmm[prob.motif1[1],]~groupFactor)

prob.motif2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]>0.5 & gene.prob[,7]<0.5 & gene.prob[,8]>0.5),])
length(prob.motif2)
head(prob.motif2)
#boxplot(tmm[prob.motif2[1],]~groupFactor)

prob.motif3  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]>0.5),])
length(prob.motif3)
head(prob.motif3)
#boxplot(tmm[prob.motif3[1],]~groupFactor)

prob.motif4  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]>0.5 & gene.prob[,8]>0.5),])
length(prob.motif4)
head(prob.motif4)
#boxplot(tmm[prob.motif4[1],]~groupFactor)

prob.motif5  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]>0.5 & gene.prob[,7]<0.5 & gene.prob[,8]>0.5),])
length(prob.motif5)
head(prob.motif5)
#boxplot(tmm[prob.motif5[1],]~groupFactor)

prob.motif6  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]>0.5 & gene.prob[,7]>0.5 & gene.prob[,8]>0.5),])
length(prob.motif6)
head(prob.motif6)
#boxplot(tmm[prob.motif6[1],]~groupFactor)

# Examine human/chimp differences
prob.motifC  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]>0.5 & gene.prob[,6]>0.5 & gene.prob[,7]>0.5 & gene.prob[,8]>0.5),])
length(prob.motifC)
head(prob.motifC)
#boxplot(tmm[prob.motifC[1],]~groupFactor)

prob.motifC1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]>0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifC1)
head(prob.motifC1)
#boxplot(tmm[prob.motifC1[1],]~groupFactor)

prob.motifC2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]>0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifC2)
head(prob.motifC2)
#boxplot(tmm[prob.motifC2[1],]~groupFactor)

prob.motifC3  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]>0.5 & gene.prob[,8]<0.5),])
length(prob.motifC3)
head(prob.motifC3)
#boxplot(tmm[prob.motifC3[1],]~groupFactor)

prob.motifC4  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]>0.5),])
length(prob.motifC4)
head(prob.motifC4)
#boxplot(tmm[prob.motifC4[1],]~groupFactor)

prob.motifH  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH)
head(prob.motifH)
#boxplot(tmm[prob.motifH[1],]~groupFactor)

prob.motifH1  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH1)
head(prob.motifH1)
#boxplot(tmm[prob.motifH1[1],]~groupFactor)

prob.motifH2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH2)
head(prob.motifH2)
#boxplot(tmm[prob.motifH2[1],]~groupFactor)

prob.motifH3  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH3)
head(prob.motifH3)
#boxplot(tmm[prob.motifH3[1],]~groupFactor)

prob.motifH4  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH4)
head(prob.motifH4)
#boxplot(tmm[prob.motifH4[1],]~groupFactor)

```

```{r, eval=FALSE}

saveRDS(gene.prob,"./output/cormotif.sc-ostahoc.thresh0-8.data.filter.log.indv-cell.int19k-tot.rds")

```

### Cormotif: Species vs. Osteogenic Ad Ho Classifications (median) - 4 time point comparisons

```{r, eval=FALSE}

# Compile group labels of each sample
groupFactor <- factor(paste(dge$samples$Species,sapply(dge$samples$OstAdHoc.Assign.5gene.median,function(x)sub(" ",".",x)),sep="_"),
                      levels=c("Human_preosteoblast","Human_osteoblast","Human_embedding.osteoblast","Human_mineralizing.osteoblast","Human_maturing.osteocyte",
                               "Human_unknown.osteogenic","Human_not.osteogenic",
                               "Chimp_preosteoblast","Chimp_osteoblast","Chimp_embedding.osteoblast","Chimp_mineralizing.osteoblast","Chimp_maturing.osteocyte",
                               "Chimp_unknown.osteogenic","Chimp_not.osteogenic"))
groupID <- as.numeric(groupFactor)

# Compile comparison pattern
#(condiditions to compare = time0, time1, and time2 for each species)
compareID <- data.frame(c1 = c(1, 2, 3, 4, 8,  9, 10, 11),
                        c2 = c(2, 3, 4, 5, 9, 10, 11, 12))

# Assess differences during differentiation
set.seed(1)
cormotifData <- cormotiffit(exprs = tmm,
                            groupid = groupID,
                            compid = compareID,
                            K = 1:10,
                            max.iter=1000,
                            BIC=FALSE)

#which BIC and AIC are lowest? - 1 motif (WHAT?!)
cormotifData$bic
plotIC(cormotifData)
cormotifData$bestmotif$loglike

#what motif patterns were learned by the algorithm
plotMotif(cormotifData)

#posterior probability of DE for each gene
head(cormotifData$bestmotif$p.post)

#obtain DE pattern at 0.5 posterior distribution cutoff
gene.prob <- cormotifData$bestmotif$p.post
rownames(gene.prob) <- rownames(tmm)
colnames(gene.prob) <- c("H.pre-obl","H.obl-emb","H.emb-min","H.min-mat","C.pre-obl","C.obl-emb","C.emb-min","C.min-mat")
head(gene.prob)

heatmap.2(gene.prob,
          dendrogram="none",
          Colv=FALSE,
          breaks=c(0,0.2,0.4,0.6,0.8,1),
          col=c("#fef0d9","#fdcc8a","#fc8d59","#e34a33","#b30000"),
          margins=c(3,0),
          trace="none",
          key.title="",
          key.xlab="posterior prob.",
          key.ylab="",
          #ylab=paste0(length(rownames(gene.prob))," genes"),
          keysize=1,
          key.par=list(mar=c(3.5,0,3,0)),
          lmat=rbind(c(5,4,2),c(6,1,3)),
          lhei=c(2.5,5),
          lwid=c(1,10,1),
          labRow=FALSE,
          cexCol=1,
          srtCol=0,
          adjCol=c(0.5,0))

# Test degree of conservation for preosteoblasts-maturing osteocytes: posterior probability difference between the humans and the chimps within a motif 
#0.3 (489 genes) ->  7.42%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.3) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.3) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.3) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.3), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.3) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.3) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.3) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.3), ]))/dim(tmm)[1]
#0.2 (270 genes) ->  4.10%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.2) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.2) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.2) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.2), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.2) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.2) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.2) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.2), ]))/dim(tmm)[1]
#0.1 (110 genes) ->  1.67%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.1) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.1) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.1) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.1), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.1) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.1) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.1) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.1), ]))/dim(tmm)[1]

# Examine genes from each motif
prob.motif1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motif1)
head(prob.motif1)
#boxplot(tmm[prob.motif1[1],]~groupFactor)

prob.motif2  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]>0.5 & gene.prob[,7]>0.5 & gene.prob[,8]>0.5),])
length(prob.motif2)
head(prob.motif2)
#boxplot(tmm[prob.motif2[1],]~groupFactor)

prob.motif3  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]>0.5 & gene.prob[,7]>0.5 & gene.prob[,8]>0.5),])
length(prob.motif3)
head(prob.motif3)
#boxplot(tmm[prob.motif3[1],]~groupFactor)

prob.motif4  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]>0.5 & gene.prob[,6]>0.5 & gene.prob[,7]>0.5 & gene.prob[,8]>0.5),])
length(prob.motif4)
head(prob.motif4)
#boxplot(tmm[prob.motif4[1],]~groupFactor)

prob.motif5  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]>0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motif5)
head(prob.motif5)
#boxplot(tmm[prob.motif5[1],]~groupFactor)

prob.motif6  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motif6)
head(prob.motif6)
#boxplot(tmm[prob.motif6[1],]~groupFactor)

prob.motif7  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]>0.5 & gene.prob[,8]<0.5),])
length(prob.motif7)
head(prob.motif7)
#boxplot(tmm[prob.motif7[1],]~groupFactor)

prob.motif8  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]>0.5 & gene.prob[,6]<0.5 & gene.prob[,7]>0.5 & gene.prob[,8]<0.5),])
length(prob.motif8)
head(prob.motif8)
#boxplot(tmm[prob.motif8[1],]~groupFactor)


# Examine human/chimp differences
prob.motifC  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]>0.5 & gene.prob[,6]>0.5 & gene.prob[,7]>0.5 & gene.prob[,8]>0.5),])
length(prob.motifC)
head(prob.motifC)
#boxplot(tmm[prob.motifC[1],]~groupFactor)

prob.motifC1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]>0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifC1)
head(prob.motifC1)
#boxplot(tmm[prob.motifC1[1],]~groupFactor)

prob.motifC2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]>0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifC2)
head(prob.motifC2)
#boxplot(tmm[prob.motifC2[1],]~groupFactor)

prob.motifC3  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]>0.5 & gene.prob[,8]<0.5),])
length(prob.motifC3)
head(prob.motifC3)
#boxplot(tmm[prob.motifC3[1],]~groupFactor)

prob.motifC4  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]>0.5),])
length(prob.motifC4)
head(prob.motifC4)
#boxplot(tmm[prob.motifC4[1],]~groupFactor)

prob.motifH  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH)
head(prob.motifH)
#boxplot(tmm[prob.motifH[1],]~groupFactor)

prob.motifH1  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH1)
head(prob.motifH1)
#boxplot(tmm[prob.motifH1[1],]~groupFactor)

prob.motifH2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH2)
head(prob.motifH2)
#boxplot(tmm[prob.motifH2[1],]~groupFactor)

prob.motifH3  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH3)
head(prob.motifH3)
#boxplot(tmm[prob.motifH3[1],]~groupFactor)

prob.motifH4  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH4)
head(prob.motifH4)
#boxplot(tmm[prob.motifH4[1],]~groupFactor)

```

```{r, eval=FALSE}

saveRDS(gene.prob,"./output/cormotif.sc-ostahoc8.data.filter.log.indv-cell.int19k-tot.rds")

```

### Cormotif: Species vs. Osteogenic Ad Ho Classifications (thresh0 in t2) - 4 time point comparisons

```{r, eval=FALSE}

# Compile group labels of each sample
groupFactor <- factor(paste(dge$samples$Species,sapply(dge$samples$OstAdHoc.Assign.5gene.thresh0.t2,function(x)sub(" ",".",x)),sep="_"),
                      levels=c("Human_preosteoblast","Human_osteoblast","Human_embedding.osteoblast","Human_mineralizing.osteoblast","Human_maturing.osteocyte",
                               "Human_unknown.osteogenic","Human_not.osteogenic",
                               "Chimp_preosteoblast","Chimp_osteoblast","Chimp_embedding.osteoblast","Chimp_mineralizing.osteoblast","Chimp_maturing.osteocyte",
                               "Chimp_unknown.osteogenic","Chimp_not.osteogenic"))
groupID <- as.numeric(groupFactor)

# Compile comparison pattern
#(condiditions to compare = time0, time1, and time2 for each species)
compareID <- data.frame(c1 = c(1, 2, 3, 4, 8,  9, 10, 11),
                        c2 = c(2, 3, 4, 5, 9, 10, 11, 12))

# Assess differences during differentiation
set.seed(1)
cormotifData <- cormotiffit(exprs = tmm,
                            groupid = groupID,
                            compid = compareID,
                            K = 1:10,
                            max.iter=1000,
                            BIC=FALSE)

#which BIC and AIC are lowest? - 10 motifs
cormotifData$bic
plotIC(cormotifData)
cormotifData$bestmotif$loglike

#what motif patterns were learned by the algorithm
plotMotif(cormotifData)

#posterior probability of DE for each gene
head(cormotifData$bestmotif$p.post)

#obtain DE pattern at 0.5 posterior distribution cutoff
gene.prob <- cormotifData$bestmotif$p.post
rownames(gene.prob) <- rownames(tmm)
colnames(gene.prob) <- c("H.pre-obl","H.obl-emb","H.emb-min","H.min-mat","C.pre-obl","C.obl-emb","C.emb-min","C.min-mat")
head(gene.prob)

heatmap.2(gene.prob,
          dendrogram="none",
          Colv=FALSE,
          breaks=c(0,0.2,0.4,0.6,0.8,1),
          col=c("#fef0d9","#fdcc8a","#fc8d59","#e34a33","#b30000"),
          margins=c(3,0),
          trace="none",
          key.title="",
          key.xlab="posterior prob.",
          key.ylab="",
          #ylab=paste0(length(rownames(gene.prob))," genes"),
          keysize=1,
          key.par=list(mar=c(3.5,0,3,0)),
          lmat=rbind(c(5,4,2),c(6,1,3)),
          lhei=c(2.5,5),
          lwid=c(1,10,1),
          labRow=FALSE,
          cexCol=1,
          srtCol=0,
          adjCol=c(0.5,0))

# Test degree of conservation for preosteoblasts-maturing osteocytes: posterior probability difference between the humans and the chimps within a motif 
#0.3 (228 genes) ->  3.46%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.3) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.3) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.3) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.3), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.3) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.3) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.3) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.3), ]))/dim(tmm)[1]
#0.2 (142 genes) ->  2.15%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.2) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.2) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.2) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.2), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.2) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.2) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.2) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.2), ]))/dim(tmm)[1]
#0.1 ( 67 genes) ->  1.02%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.1) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.1) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.1) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.1), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.1) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.1) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.1) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.1), ]))/dim(tmm)[1]

# Examine genes from each motif
prob.motif1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motif1)
head(prob.motif1)
#boxplot(tmm[prob.motif1[1],]~groupFactor)

prob.motif2  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]>0.5 & gene.prob[,8]<0.5),])
length(prob.motif2)
head(prob.motif2)
#boxplot(tmm[prob.motif2[1],]~groupFactor)

prob.motif3  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]>0.5 & gene.prob[,6]>0.5 & gene.prob[,7]>0.5 & gene.prob[,8]>0.5),])
length(prob.motif3)
head(prob.motif3)
#boxplot(tmm[prob.motif3[1],]~groupFactor)

prob.motif4  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]>0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motif4)
head(prob.motif4)
#boxplot(tmm[prob.motif4[1],]~groupFactor)

prob.motif5  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]>0.5 & gene.prob[,8]>0.5),])
length(prob.motif5)
head(prob.motif5)
#boxplot(tmm[prob.motif5[1],]~groupFactor)

prob.motif6  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]>0.5 & gene.prob[,6]>0.5 & gene.prob[,7]>0.5 & gene.prob[,8]>0.5),])
length(prob.motif6)
head(prob.motif6)
#boxplot(tmm[prob.motif6[1],]~groupFactor)

prob.motif7  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]>0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motif7)
head(prob.motif7)
#boxplot(tmm[prob.motif7[1],]~groupFactor)

prob.motif8  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]>0.5 & gene.prob[,6]<0.5 & gene.prob[,7]>0.5 & gene.prob[,8]<0.5),])
length(prob.motif8)
head(prob.motif8)
#boxplot(tmm[prob.motif8[1],]~groupFactor)

prob.motif9  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]>0.5 & gene.prob[,8]>0.5),])
length(prob.motif9)
head(prob.motif9)
#boxplot(tmm[prob.motif9[1],]~groupFactor)

prob.motif10  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]>0.5 & gene.prob[,6]>0.5 & gene.prob[,7]>0.5 & gene.prob[,8]>0.5),])
length(prob.motif10)
head(prob.motif10)
#boxplot(tmm[prob.motif10[1],]~groupFactor)

# Examine human/chimp differences
prob.motifC  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]>0.5 & gene.prob[,6]>0.5 & gene.prob[,7]>0.5 & gene.prob[,8]>0.5),])
length(prob.motifC)
head(prob.motifC)
#boxplot(tmm[prob.motifC[1],]~groupFactor)

prob.motifC1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]>0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifC1)
head(prob.motifC1)
#boxplot(tmm[prob.motifC1[1],]~groupFactor)

prob.motifC2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]>0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifC2)
head(prob.motifC2)
#boxplot(tmm[prob.motifC2[1],]~groupFactor)

prob.motifC3  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]>0.5 & gene.prob[,8]<0.5),])
length(prob.motifC3)
head(prob.motifC3)
#boxplot(tmm[prob.motifC3[1],]~groupFactor)

prob.motifC4  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]>0.5),])
length(prob.motifC4)
head(prob.motifC4)
#boxplot(tmm[prob.motifC4[1],]~groupFactor)

prob.motifH  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH)
head(prob.motifH)
#boxplot(tmm[prob.motifH[1],]~groupFactor)

prob.motifH1  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH1)
head(prob.motifH1)
#boxplot(tmm[prob.motifH1[1],]~groupFactor)

prob.motifH2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH2)
head(prob.motifH2)
#boxplot(tmm[prob.motifH2[1],]~groupFactor)

prob.motifH3  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH3)
head(prob.motifH3)
#boxplot(tmm[prob.motifH3[1],]~groupFactor)

prob.motifH4  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH4)
head(prob.motifH4)
#boxplot(tmm[prob.motifH4[1],]~groupFactor)

```

```{r, eval=FALSE}

saveRDS(gene.prob,"./output/cormotif.sc-ostahoc.thresh0.t2-8.data.filter.log.indv-cell.int19k-tot.rds")

```

### Run Cormotif using Pseudobulk Data (Species vs. Stages)

```{r}

# Compile log2 normalized gene expression data
#make count matrix and metadata for edgeR object - pseudobulk (pseudocounts, filter genes mean(log2cpm)>0)
cell.subset <- c("Time 0","Time 1","Time 2")
counts <- c()
metadata <- c()
labels <- c()
for(j in cell.subset) {
  dataSub <- subset(data,subset=Stage==j)
  for (i in unique(dataSub@meta.data$Individual.Replicate)) {
    x.lab <- paste0(i,"_",j)
    w <- which(dataSub@meta.data$Individual.Replicate==i)
    if (length(w)>0) {
      x.spp <- dataSub@meta.data$Species[w][1]
      x.col <- dataSub@meta.data$Collection[w][1]
      x.ind <- dataSub@meta.data$Individual[w][1]
      x.rep <- dataSub@meta.data$Replicate[w][1]
      x.idr <- dataSub@meta.data$Individual.Replicate[w][1]
      x.stg <- dataSub@meta.data$Stage[w][1]
      if (length(w)==1) {
        x.cnt <- dataSub@assays$RNA@counts[,w]
      } else {
        x.cnt <- Matrix::rowSums(dataSub@assays$RNA@counts[,w])
      }
      counts <- cbind(counts, x.cnt)
      metadata <- rbind(metadata, c(x.lab, x.spp, x.col, x.ind, x.rep, x.idr, x.stg))
      labels <- c(labels, x.lab)
    }
  }
}
colnames(counts) <- labels
rownames(metadata) <- labels
colnames(metadata) <- c("Sample","Species","Collection","Individual","Replicate","Individual.Replicate","Stage")
metadata <- as.data.frame(metadata)
#remove mitochodrial and ribosomal genes
counts <- counts[which(rownames(counts) %in% genes.no.mito.ribo),]
#make edgeR object
dge <- DGEList(counts)
meta_dge <- dge$samples[,c("lib.size","norm.factors")]
meta_dge <- cbind(meta_dge, metadata)
dge$samples <- meta_dge
rm(counts,metadata,meta_dge)
#filter genes
keep <- rowMeans(edgeR::cpm(dge,log=TRUE,prior.count=0.25))>0
dge$counts <- dge$counts[keep,]
#normalize data
dge <- calcNormFactors(dge, method="TMM")
#log2 transformed cpm
tmm <- edgeR::cpm(dge,normalized.lib.sizes=TRUE,log=TRUE,prior.count=0.25)
##boxplot(tmm,xlab="",ylab="Log2 counts per million",las=2)

```

### Cormotif: Species vs. Stages - 2 time point comparisons

```{r}

# Compile group labels of each sample
groupFactor <- factor(paste(dge$samples$Species,sapply(dge$samples$Stage,function(x)sub(" ","",x)),sep = "."),
                      levels=c("Human.Time0","Human.Time1","Human.Time2","Chimp.Time0","Chimp.Time1","Chimp.Time2"))
groupID <- as.numeric(groupFactor)

# Compile comparison pattern
#(condiditions to compare = time0, time1, and time2 for each species)
compareID <- data.frame(c1 = c(1, 2, 4, 5),
                        c2 = c(2, 3, 5, 6))

# Assess differences during differentiation
set.seed(1)
cormotifData <- cormotiffit(exprs = tmm,
                            groupid = groupID,
                            compid = compareID,
                            K = 1:10,
                            max.iter=1000,
                            BIC=FALSE)

#which BIC and AIC are lowest? - 4 motifs
cormotifData$bic
plotIC(cormotifData)
cormotifData$bestmotif$loglike

#what motif patterns were learned by the algorithm
plotMotif(cormotifData)

#posterior probability of DE for each gene
head(cormotifData$bestmotif$p.post)

#obtain DE pattern at 0.5 posterior distribution cutoff
gene.prob <- cormotifData$bestmotif$p.post
rownames(gene.prob) <- rownames(tmm)
colnames(gene.prob) <- c("H.t0-t1","H.t1-t2","C.t0-t1","C.t1-t2")
head(gene.prob)

heatmap.2(gene.prob,
          dendrogram="none",
          Colv=FALSE,
          breaks=c(0,0.2,0.4,0.6,0.8,1),
          col=c("#fef0d9","#fdcc8a","#fc8d59","#e34a33","#b30000"),
          margins=c(3,0),
          trace="none",
          key.title="",
          key.xlab="posterior prob.",
          key.ylab="",
          #ylab=paste0(length(rownames(gene.prob))," genes"),
          keysize=1,
          key.par=list(mar=c(3.5,0,3,0)),
          lmat=rbind(c(5,4,2),c(6,1,3)),
          lhei=c(2.5,5),
          lwid=c(1,10,1),
          labRow=FALSE,
          cexCol=1,
          srtCol=0,
          adjCol=c(0.5,0))

# Test degree of conservation for time 0-2: posterior probability difference between the humans and the chimps within a motif 
#0.3 (10144 genes) -> 87.58%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.3), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.3), ]))/dim(tmm)[1]
#0.2 ( 9175 genes) -> 79.22%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.2), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.2), ]))/dim(tmm)[1]
#0.1 ( 7404 genes) -> 63.93%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.1), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.1), ]))/dim(tmm)[1]

# Examine genes from each motif
prob.motif1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motif1)
head(prob.motif1)
#boxplot(tmm[prob.motif1[1],]~groupFactor)

prob.motif2  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5),])
length(prob.motif2)
head(prob.motif2)
#boxplot(tmm[prob.motif2[1],]~groupFactor)

prob.motif3  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5),])
length(prob.motif3)
head(prob.motif3)
#boxplot(tmm[prob.motif3[1],]~groupFactor)

prob.motif4  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5),])
length(prob.motif4)
head(prob.motif4)
#boxplot(tmm[prob.motif4[1],]~groupFactor)

# Examine human/chimp differences
prob.motifC  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5),])
length(prob.motifC)
head(prob.motifC)
#boxplot(tmm[prob.motifC[1],]~groupFactor)

prob.motifC1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5),])
length(prob.motifC1)
head(prob.motifC1)
#boxplot(tmm[prob.motifC1[1],]~groupFactor)

prob.motifC2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5),])
length(prob.motifC2)
head(prob.motifC2)
#boxplot(tmm[prob.motifC2[1],]~groupFactor)

prob.motifH  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motifH)
head(prob.motifH)
#boxplot(tmm[prob.motifH[1],]~groupFactor)

prob.motifH1  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motifH1)
head(prob.motifH1)
#boxplot(tmm[prob.motifH1[1],]~groupFactor)

prob.motifH2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motifH2)
head(prob.motifH2)
#boxplot(tmm[prob.motifH2[1],]~groupFactor)

```

```{r, eval=FALSE}

saveRDS(gene.prob,"./output/cormotif.pseudo-stage4.data.filter.log.indv-cell.int19k-tot.rds")

```

### Cormotif: Species vs. Stages - 3 time point comparisons each

```{r}

# Compile group labels of each sample
groupFactor <- factor(paste(dge$samples$Species,sapply(dge$samples$Stage,function(x)sub(" ","",x)),sep = "."),
                      levels=c("Human.Time0","Human.Time1","Human.Time2","Chimp.Time0","Chimp.Time1","Chimp.Time2"))
groupID <- as.numeric(groupFactor)

# Compile comparison pattern
#(condiditions to compare = time0, time1, and time2 for each species)
compareID <- data.frame(c1 = c(1, 2, 1, 4, 5, 4),
                        c2 = c(2, 3, 3, 5, 6, 6))

# Assess differences during differentiation
set.seed(1)
cormotifData <- cormotiffit(exprs = tmm,
                            groupid = groupID,
                            compid = compareID,
                            K = 1:10,
                            max.iter=1000,
                            BIC=FALSE)

#which BIC and AIC are lowest? - 7 motifs
cormotifData$bic
plotIC(cormotifData)
cormotifData$bestmotif$loglike

#what motif patterns were learned by the algorithm
plotMotif(cormotifData)

#posterior probability of DE for each gene
head(cormotifData$bestmotif$p.post)

#obtain DE pattern at 0.5 posterior distribution cutoff
gene.prob <- cormotifData$bestmotif$p.post
rownames(gene.prob) <- rownames(tmm)
colnames(gene.prob) <- c("H.t0-t1","H.t1-t2","H.t0-t2","C.t0-t1","C.t1-t2","C.t0-t2")
head(gene.prob)

heatmap.2(gene.prob,
          dendrogram="none",
          Colv=FALSE,
          breaks=c(0,0.2,0.4,0.6,0.8,1),
          col=c("#fef0d9","#fdcc8a","#fc8d59","#e34a33","#b30000"),
          margins=c(3,0),
          trace="none",
          key.title="",
          key.xlab="posterior prob.",
          key.ylab="",
          #ylab=paste0(length(rownames(gene.prob))," genes"),
          keysize=1,
          key.par=list(mar=c(3.5,0,3,0)),
          lmat=rbind(c(5,4,2),c(6,1,3)),
          lhei=c(2.5,5),
          lwid=c(1,10,1),
          labRow=FALSE,
          cexCol=1,
          srtCol=0,
          adjCol=c(0.5,0))

# Test degree of conservation for time 0-2: posterior probability difference between the humans and the chimps within a motif 
#0.3 (8871 genes) -> 76.59%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.3) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.3), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.3) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.3), ]))/dim(tmm)[1]
#0.2 (8072 genes) -> 69.69%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.2) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.2), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.2) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.2), ]))/dim(tmm)[1]
#0.1 (6632 genes) -> 57.26%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.1) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.1), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.1) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.1), ]))/dim(tmm)[1]

# Examine genes from each motif
prob.motif1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motif1)
head(prob.motif1)
#boxplot(tmm[prob.motif1[1],]~groupFactor)

prob.motif2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif2)
head(prob.motif2)
#boxplot(tmm[prob.motif2[1],]~groupFactor)

prob.motif3  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif3)
head(prob.motif3)
#boxplot(tmm[prob.motif3[1],]~groupFactor)

prob.motif4  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 & gene.prob[,5]<0.5 & gene.prob[,6]>0.5),])
length(prob.motif4)
head(prob.motif4)
#boxplot(tmm[prob.motif4[1],]~groupFactor)

prob.motif5  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]<0.5),])
length(prob.motif5)
head(prob.motif5)
#boxplot(tmm[prob.motif5[1],]~groupFactor)

prob.motif6  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motif6)
head(prob.motif6)
#boxplot(tmm[prob.motif6[1],]~groupFactor)

prob.motif7  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]<0.5 & gene.prob[,6]>0.5),])
length(prob.motif7)
head(prob.motif7)
#boxplot(tmm[prob.motif7[1],]~groupFactor)

# Examine human/chimp differences
prob.motifC  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motifC)
head(prob.motifC)
#boxplot(tmm[prob.motifC[1],]~groupFactor)

prob.motifC0  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]<0.5 & gene.prob[,6]>0.5),])
length(prob.motifC0)
head(prob.motifC0)
#boxplot(tmm[prob.motifC0[1],]~groupFactor)

prob.motifC1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]<0.5),])
length(prob.motifC1)
head(prob.motifC1)
#boxplot(tmm[prob.motifC1[1],]~groupFactor)

prob.motifC2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motifC2)
head(prob.motifC2)
#boxplot(tmm[prob.motifC2[1],]~groupFactor)

prob.motifH  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH)
head(prob.motifH)
#boxplot(tmm[prob.motifH[1],]~groupFactor)

prob.motifH0  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH0)
head(prob.motifH0)
#boxplot(tmm[prob.motifH0[1],]~groupFactor)

prob.motifH1  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH1)
head(prob.motifH1)
#boxplot(tmm[prob.motifH1[1],]~groupFactor)

prob.motifH2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH2)
head(prob.motifH2)
#boxplot(tmm[prob.motifH2[1],]~groupFactor)

```

```{r, eval=FALSE}

saveRDS(gene.prob,"./output/cormotif.pseudo-stage6.data.filter.log.indv-cell.int19k-tot.rds")

```

### Run Cormotif using Pseudobulk Data (Species vs. General Clusters) (res=0.05)

```{r}

# Compile log2 normalized gene expression data
#make count matrix and metadata for edgeR object - pseudobulk (pseudocounts, filter genes mean(log2cpm)>0)
cell.subset <- c("iPSC.c1","iPSC.c2","iPSC.c3","MSC.c1","Osteogenic.c1","Osteogenic.c2")
counts <- c()
metadata <- c()
labels <- c()
for(j in cell.subset) {
  dataSub <- subset(data,subset=Cluster==j)
  for (i in unique(dataSub@meta.data$Individual.Replicate)) {
    x.lab <- paste0(i,"_",j)
    w <- which(dataSub@meta.data$Individual.Replicate==i)
    if (length(w)>0) {
      x.spp <- dataSub@meta.data$Species[w][1]
      x.col <- dataSub@meta.data$Collection[w][1]
      x.ind <- dataSub@meta.data$Individual[w][1]
      x.rep <- dataSub@meta.data$Replicate[w][1]
      x.idr <- dataSub@meta.data$Individual.Replicate[w][1]
      x.clt <- dataSub@meta.data$Cluster[w][1]
      if (length(w)==1) {
        x.cnt <- dataSub@assays$RNA@counts[,w]
      } else {
        x.cnt <- Matrix::rowSums(dataSub@assays$RNA@counts[,w])
      }
      counts <- cbind(counts, x.cnt)
      metadata <- rbind(metadata, c(x.lab, x.spp, x.col, x.ind, x.rep, x.idr, x.clt))
      labels <- c(labels, x.lab)
    }
  }
}
colnames(counts) <- labels
rownames(metadata) <- labels
colnames(metadata) <- c("Sample","Species","Collection","Individual","Replicate","Individual.Replicate","Cluster")
metadata <- as.data.frame(metadata)
#remove mitochodrial and ribosomal genes
counts <- counts[which(rownames(counts) %in% genes.no.mito.ribo),]
#make edgeR object
dge <- DGEList(counts)
meta_dge <- dge$samples[,c("lib.size","norm.factors")]
meta_dge <- cbind(meta_dge, metadata)
dge$samples <- meta_dge
rm(counts,metadata,meta_dge)
#filter genes
keep <- rowMeans(edgeR::cpm(dge,log=TRUE,prior.count=0.25))>0
dge$counts <- dge$counts[keep,]
#normalize data
dge <- calcNormFactors(dge, method="TMM")
#log2 transformed cpm
tmm <- edgeR::cpm(dge,normalized.lib.sizes=TRUE,log=TRUE,prior.count=0.25)
##boxplot(tmm,xlab="",ylab="Log2 counts per million",las=2)

```

### Cormotif: Species vs. General Clusters (res=0.05) - 2 time point comparisons

```{r}

# Compile group labels of each sample
groupFactor <- factor(paste(dge$samples$Species,dge$samples$Cluster,sep="_"),
                      levels=c("Human_iPSC.c1","Human_iPSC.c2","Human_iPSC.c3","Human_MSC.c1","Human_Osteogenic.c1","Human_Osteogenic.c2",
                               "Chimp_iPSC.c1","Chimp_iPSC.c2","Chimp_iPSC.c3","Chimp_MSC.c1","Chimp_Osteogenic.c1","Chimp_Osteogenic.c2"))
groupID <- as.numeric(groupFactor)

# Compile comparison pattern
#(condiditions to compare = time0, time1, and time2 for each species)
compareID <- data.frame(c1 = c(1, 4,  7, 10),
                        c2 = c(4, 5, 10, 11))

# Assess differences during differentiation
set.seed(1)
cormotifData <- cormotiffit(exprs = tmm,
                            groupid = groupID,
                            compid = compareID,
                            K = 1:10,
                            max.iter=1000,
                            BIC=FALSE)

#which BIC and AIC are lowest? - 3 motifs
cormotifData$bic
plotIC(cormotifData)
cormotifData$bestmotif$loglike

#what motif patterns were learned by the algorithm
plotMotif(cormotifData)

#posterior probability of DE for each gene
head(cormotifData$bestmotif$p.post)

#obtain DE pattern at 0.5 posterior distribution cutoff
gene.prob <- cormotifData$bestmotif$p.post
rownames(gene.prob) <- rownames(tmm)
colnames(gene.prob) <- c("H.iPSC.c1-MSC.c1","H.MSC.c1-Osteogenic.c1","C.iPSC.c1-MSC.c1","C.MSC.c1-Osteogenic.c1")
head(gene.prob)

heatmap.2(gene.prob,
          dendrogram="none",
          Colv=FALSE,
          breaks=c(0,0.2,0.4,0.6,0.8,1),
          col=c("#fef0d9","#fdcc8a","#fc8d59","#e34a33","#b30000"),
          margins=c(3,0),
          trace="none",
          key.title="",
          key.xlab="posterior prob.",
          key.ylab="",
          #ylab=paste0(length(rownames(gene.prob))," genes"),
          keysize=1,
          key.par=list(mar=c(3.5,0,3,0)),
          lmat=rbind(c(5,4,2),c(6,1,3)),
          lhei=c(2.5,5),
          lwid=c(1,10,1),
          labRow=FALSE,
          cexCol=1,
          srtCol=0,
          adjCol=c(0.5,0))

# Test degree of conservation for time 0-2: posterior probability difference between the humans and the chimps within a motif 
#0.3 (9873 genes) -> 88.75%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.3), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.3), ]))/dim(tmm)[1]
#0.2 ( 9031 genes) -> 81.18%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.2), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.2), ]))/dim(tmm)[1]
#0.1 ( 7457 genes) -> 67.02%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.1), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.1), ]))/dim(tmm)[1]

# Examine genes from each motif
prob.motif1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motif1)
head(prob.motif1)
#boxplot(tmm[prob.motif1[1],]~groupFactor)

prob.motif2  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5),])
length(prob.motif2)
head(prob.motif2)
#boxplot(tmm[prob.motif2[1],]~groupFactor)

prob.motif3  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5),])
length(prob.motif3)
head(prob.motif3)
#boxplot(tmm[prob.motif3[1],]~groupFactor)

prob.motif4  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5),])
length(prob.motif4)
head(prob.motif4)
#boxplot(tmm[prob.motif4[1],]~groupFactor)

# Examine human/chimp differences
prob.motifC  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5),])
length(prob.motifC)
head(prob.motifC)
#boxplot(tmm[prob.motifC[1],]~groupFactor)

prob.motifC1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5),])
length(prob.motifC1)
head(prob.motifC1)
#boxplot(tmm[prob.motifC1[1],]~groupFactor)

prob.motifC2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5),])
length(prob.motifC2)
head(prob.motifC2)
#boxplot(tmm[prob.motifC2[1],]~groupFactor)

prob.motifH  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motifH)
head(prob.motifH)
#boxplot(tmm[prob.motifH[1],]~groupFactor)

prob.motifH1  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motifH1)
head(prob.motifH1)
#boxplot(tmm[prob.motifH1[1],]~groupFactor)

prob.motifH2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motifH2)
head(prob.motifH2)
#boxplot(tmm[prob.motifH2[1],]~groupFactor)

```

```{r, eval=FALSE}

saveRDS(gene.prob,"./output/cormotif.pseudo-cluster4.data.filter.log.indv-cell.int19k-tot.rds")

```

### Cormotif: Species vs. General Clusters (res=0.05) - 3 time point comparisons each

```{r}

# Compile group labels of each sample
groupFactor <- factor(paste(dge$samples$Species,dge$samples$Cluster,sep="_"),
                      levels=c("Human_iPSC.c1","Human_iPSC.c2","Human_iPSC.c3","Human_MSC.c1","Human_Osteogenic.c1","Human_Osteogenic.c2",
                               "Chimp_iPSC.c1","Chimp_iPSC.c2","Chimp_iPSC.c3","Chimp_MSC.c1","Chimp_Osteogenic.c1","Chimp_Osteogenic.c2"))
groupID <- as.numeric(groupFactor)

# Compile comparison pattern
#(condiditions to compare = time0, time1, and time2 for each species)
compareID <- data.frame(c1 = c(1, 4, 1,  7, 10,  7),
                        c2 = c(4, 5, 5, 10, 11, 11))

# Assess differences during differentiation
set.seed(1)
cormotifData <- cormotiffit(exprs = tmm,
                            groupid = groupID,
                            compid = compareID,
                            K = 1:10,
                            max.iter=1000,
                            BIC=FALSE)

#which BIC and AIC are lowest? - 1 motif (WHAT?!)
cormotifData$bic
plotIC(cormotifData)
cormotifData$bestmotif$loglike

#what motif patterns were learned by the algorithm
plotMotif(cormotifData)

#posterior probability of DE for each gene
head(cormotifData$bestmotif$p.post)

#obtain DE pattern at 0.5 posterior distribution cutoff
gene.prob <- cormotifData$bestmotif$p.post
rownames(gene.prob) <- rownames(tmm)
colnames(gene.prob) <- c("H.iPSC.c1-MSC.c1","H.MSC.c1-Osteogenic.c1","H.iPSC.c1-Osteogenic.c1","C.iPSC.c1-MSC.c1","C.MSC.c1-Osteogenic.c1","C.iPSC.c1-Osteogenic.c1")
head(gene.prob)

heatmap.2(gene.prob,
          dendrogram="none",
          Colv=FALSE,
          breaks=c(0,0.2,0.4,0.6,0.8,1),
          col=c("#fef0d9","#fdcc8a","#fc8d59","#e34a33","#b30000"),
          margins=c(3,0),
          trace="none",
          key.title="",
          key.xlab="posterior prob.",
          key.ylab="",
          #ylab=paste0(length(rownames(gene.prob))," genes"),
          keysize=1,
          key.par=list(mar=c(3.5,0,3,0)),
          lmat=rbind(c(5,4,2),c(6,1,3)),
          lhei=c(2.5,5),
          lwid=c(1,10,1),
          labRow=FALSE,
          cexCol=1,
          srtCol=0,
          adjCol=c(0.5,0))

# Test degree of conservation for time 0-2: posterior probability difference between the humans and the chimps within a motif 
#0.3 (8538 genes) -> 76.75%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.3) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.3), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.3) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.3), ]))/dim(tmm)[1]
#0.2 (7879 genes) -> 70.82%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.2) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.2), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.2) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.2), ]))/dim(tmm)[1]
#0.1 (6606 genes) -> 59.38%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.1) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.1), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.1) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.1), ]))/dim(tmm)[1]

# Examine genes from each motif
prob.motif1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motif1)
head(prob.motif1)
#boxplot(tmm[prob.motif1[1],]~groupFactor)

prob.motif2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]<0.5 & gene.prob[,6]>0.5),])
length(prob.motif2)
head(prob.motif2)
#boxplot(tmm[prob.motif2[1],]~groupFactor)

prob.motif3  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif3)
head(prob.motif3)
#boxplot(tmm[prob.motif3[1],]~groupFactor)

prob.motif4  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motif4)
head(prob.motif4)
#boxplot(tmm[prob.motif4[1],]~groupFactor)

prob.motif5  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]<0.5),])
length(prob.motif5)
head(prob.motif5)
#boxplot(tmm[prob.motif5[1],]~groupFactor)

prob.motif6  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 & gene.prob[,5]<0.5 & gene.prob[,6]>0.5),])
length(prob.motif6)
head(prob.motif6)
#boxplot(tmm[prob.motif6[1],]~groupFactor)

prob.motif7  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif7)
head(prob.motif7)
#boxplot(tmm[prob.motif7[1],]~groupFactor)

prob.motif8  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motif8)
head(prob.motif8)
#boxplot(tmm[prob.motif8[1],]~groupFactor)

# Examine human/chimp differences
prob.motifC  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motifC)
head(prob.motifC)
#boxplot(tmm[prob.motifC[1],]~groupFactor)

prob.motifC0  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]<0.5 & gene.prob[,6]>0.5),])
length(prob.motifC0)
head(prob.motifC0)
#boxplot(tmm[prob.motifC0[1],]~groupFactor)

prob.motifC1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]<0.5),])
length(prob.motifC1)
head(prob.motifC1)
#boxplot(tmm[prob.motifC1[1],]~groupFactor)

prob.motifC2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motifC2)
head(prob.motifC2)
#boxplot(tmm[prob.motifC2[1],]~groupFactor)

prob.motifH  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH)
head(prob.motifH)
#boxplot(tmm[prob.motifH[1],]~groupFactor)

prob.motifH0  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH0)
head(prob.motifH0)
#boxplot(tmm[prob.motifH0[1],]~groupFactor)

prob.motifH1  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH1)
head(prob.motifH1)
#boxplot(tmm[prob.motifH1[1],]~groupFactor)

prob.motifH2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH2)
head(prob.motifH2)
#boxplot(tmm[prob.motifH2[1],]~groupFactor)

```

```{r, eval=FALSE}

saveRDS(gene.prob,"./output/cormotif.pseudo-cluster6.data.filter.log.indv-cell.int19k-tot.rds")

```

### Run Cormotif using Pseudobulk Data (Species vs. General Ad Hoc Classifications) (thresh0)

```{r}

# Compile log2 normalized gene expression data
#make count matrix and metadata for edgeR object - pseudobulk (pseudocounts, filter genes mean(log2cpm)>0)
cell.subset <- c("iPSC","MSC","Osteogenic","other")
counts <- c()
metadata <- c()
labels <- c()
for(j in cell.subset) {
  dataSub <- subset(data,subset=AdHoc.Assign.thresh0==j)
  for (i in unique(dataSub@meta.data$Individual.Replicate)) {
    x.lab <- paste0(i,"_",j)
    w <- which(dataSub@meta.data$Individual.Replicate==i)
    if (length(w)>0) {
      x.spp <- dataSub@meta.data$Species[w][1]
      x.col <- dataSub@meta.data$Collection[w][1]
      x.ind <- dataSub@meta.data$Individual[w][1]
      x.rep <- dataSub@meta.data$Replicate[w][1]
      x.idr <- dataSub@meta.data$Individual.Replicate[w][1]
      x.adh <- as.character(dataSub@meta.data$AdHoc.Assign.thresh0[w][1])
      if (length(w)==1) {
        x.cnt <- dataSub@assays$RNA@counts[,w]
      } else {
        x.cnt <- Matrix::rowSums(dataSub@assays$RNA@counts[,w])
      }
      counts <- cbind(counts, x.cnt)
      metadata <- rbind(metadata, c(x.lab, x.spp, x.col, x.ind, x.rep, x.idr, x.adh))
      labels <- c(labels, x.lab)
    }
  }
}
colnames(counts) <- labels
rownames(metadata) <- labels
colnames(metadata) <- c("Sample","Species","Collection","Individual","Replicate","Individual.Replicate","AdHoc")
metadata <- as.data.frame(metadata)
#remove mitochodrial and ribosomal genes
counts <- counts[which(rownames(counts) %in% genes.no.mito.ribo),]
#make edgeR object
dge <- DGEList(counts)
meta_dge <- dge$samples[,c("lib.size","norm.factors")]
meta_dge <- cbind(meta_dge, metadata)
dge$samples <- meta_dge
rm(counts,metadata,meta_dge)
#filter genes
keep <- rowMeans(edgeR::cpm(dge,log=TRUE,prior.count=0.25))>0
dge$counts <- dge$counts[keep,]
#normalize data
dge <- calcNormFactors(dge, method="TMM")
#log2 transformed cpm
tmm <- edgeR::cpm(dge,normalized.lib.sizes=TRUE,log=TRUE,prior.count=0.25)
##boxplot(tmm,xlab="",ylab="Log2 counts per million",las=2)

```

### Cormotif: Species vs. General Ad Hoc Classifications (thresh0) - 2 time point comparisons

```{r}

# Compile group labels of each sample
groupFactor <- factor(paste(dge$samples$Species,dge$samples$AdHoc,sep = "_"),
                      levels=c("Human_iPSC","Human_MSC","Human_Osteogenic","Human_other","Chimp_iPSC","Chimp_MSC","Chimp_Osteogenic","Chimp_other"))
groupID <- as.numeric(groupFactor)

# Compile comparison pattern
#(condiditions to compare = time0, time1, and time2 for each species)
compareID <- data.frame(c1 = c(1, 2, 4, 5),
                        c2 = c(2, 3, 5, 6))

# Assess differences during differentiation
set.seed(1)
cormotifData <- cormotiffit(exprs = tmm,
                            groupid = groupID,
                            compid = compareID,
                            K = 1:10,
                            max.iter=1000,
                            BIC=FALSE)

#which BIC and AIC are lowest? - 4 motifs
cormotifData$bic
plotIC(cormotifData)
cormotifData$bestmotif$loglike

#what motif patterns were learned by the algorithm
plotMotif(cormotifData)

#posterior probability of DE for each gene
head(cormotifData$bestmotif$p.post)

#obtain DE pattern at 0.5 posterior distribution cutoff
gene.prob <- cormotifData$bestmotif$p.post
rownames(gene.prob) <- rownames(tmm)
colnames(gene.prob) <- c("H.iPSC-MSC","H.MSC-Osteogenic","C.iPSC-MSC","C.MSC-Osteogenic")
head(gene.prob)

heatmap.2(gene.prob,
          dendrogram="none",
          Colv=FALSE,
          breaks=c(0,0.2,0.4,0.6,0.8,1),
          col=c("#fef0d9","#fdcc8a","#fc8d59","#e34a33","#b30000"),
          margins=c(3,0),
          trace="none",
          key.title="",
          key.xlab="posterior prob.",
          key.ylab="",
          #ylab=paste0(length(rownames(gene.prob))," genes"),
          keysize=1,
          key.par=list(mar=c(3.5,0,3,0)),
          lmat=rbind(c(5,4,2),c(6,1,3)),
          lhei=c(2.5,5),
          lwid=c(1,10,1),
          labRow=FALSE,
          cexCol=1,
          srtCol=0,
          adjCol=c(0.5,0))

# Test degree of conservation for time 0-2: posterior probability difference between the humans and the chimps within a motif 
#0.3 (1941 genes) -> 16.39%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.3), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.3), ]))/dim(tmm)[1]
#0.2 (1456 genes) -> 12.30%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.2), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.2), ]))/dim(tmm)[1]
#0.1 ( 836 genes) ->  7.06%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.1), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.1), ]))/dim(tmm)[1]

# Examine genes from each motif
prob.motif1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motif1)
head(prob.motif1)
#boxplot(tmm[prob.motif1[1],]~groupFactor)

prob.motif2  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5),])
length(prob.motif2)
head(prob.motif2)
#boxplot(tmm[prob.motif2[1],]~groupFactor)

prob.motif3  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5),])
length(prob.motif3)
head(prob.motif3)
#boxplot(tmm[prob.motif3[1],]~groupFactor)

prob.motif4  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5),])
length(prob.motif4)
head(prob.motif4)
#boxplot(tmm[prob.motif4[1],]~groupFactor)

# Examine human/chimp differences
prob.motifC  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5),])
length(prob.motifC)
head(prob.motifC)
#boxplot(tmm[prob.motifC[1],]~groupFactor)

prob.motifC1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5),])
length(prob.motifC1)
head(prob.motifC1)
#boxplot(tmm[prob.motifC1[1],]~groupFactor)

prob.motifC2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5),])
length(prob.motifC2)
head(prob.motifC2)
#boxplot(tmm[prob.motifC2[1],]~groupFactor)

prob.motifH  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motifH)
head(prob.motifH)
#boxplot(tmm[prob.motifH[1],]~groupFactor)

prob.motifH1  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motifH1)
head(prob.motifH1)
#boxplot(tmm[prob.motifH1[1],]~groupFactor)

prob.motifH2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motifH2)
head(prob.motifH2)
#boxplot(tmm[prob.motifH2[1],]~groupFactor)

```

```{r, eval=FALSE}

saveRDS(gene.prob,"./output/cormotif.pseudo-adhoc.thresh0-4.data.filter.log.indv-cell.int19k-tot.rds")

```

### Cormotif: Species vs. General Ad Hoc Classifications (thresh0) - 3 time point comparisons each

```{r}

# Compile group labels of each sample
groupFactor <- factor(paste(dge$samples$Species,dge$samples$AdHoc,sep = "_"),
                      levels=c("Human_iPSC","Human_MSC","Human_Osteogenic","Human_other","Chimp_iPSC","Chimp_MSC","Chimp_Osteogenic","Chimp_other"))
groupID <- as.numeric(groupFactor)

# Compile comparison pattern
#(condiditions to compare = time0, time1, and time2 for each species)
compareID <- data.frame(c1 = c(1, 2, 1, 4, 5, 4),
                        c2 = c(2, 3, 3, 5, 6, 6))

# Assess differences during differentiation
set.seed(1)
cormotifData <- cormotiffit(exprs = tmm,
                            groupid = groupID,
                            compid = compareID,
                            K = 1:10,
                            max.iter=1000,
                            BIC=FALSE)

#which BIC and AIC are lowest? - 9 motifs
cormotifData$bic
plotIC(cormotifData)
cormotifData$bestmotif$loglike

#what motif patterns were learned by the algorithm
plotMotif(cormotifData)

#posterior probability of DE for each gene
head(cormotifData$bestmotif$p.post)

#obtain DE pattern at 0.5 posterior distribution cutoff
gene.prob <- cormotifData$bestmotif$p.post
rownames(gene.prob) <- rownames(tmm)
colnames(gene.prob) <- c("H.iPSC-MSC","H.MSC-Osteogenic","H.iPSC-Osteogenic","C.iPSC-MSC","C.MSC-Osteogenic","C.iPSC-Osteogenic")
head(gene.prob)

heatmap.2(gene.prob,
          dendrogram="none",
          Colv=FALSE,
          breaks=c(0,0.2,0.4,0.6,0.8,1),
          col=c("#fef0d9","#fdcc8a","#fc8d59","#e34a33","#b30000"),
          margins=c(3,0),
          trace="none",
          key.title="",
          key.xlab="posterior prob.",
          key.ylab="",
          #ylab=paste0(length(rownames(gene.prob))," genes"),
          keysize=1,
          key.par=list(mar=c(3.5,0,3,0)),
          lmat=rbind(c(5,4,2),c(6,1,3)),
          lhei=c(2.5,5),
          lwid=c(1,10,1),
          labRow=FALSE,
          cexCol=1,
          srtCol=0,
          adjCol=c(0.5,0))

# Test degree of conservation for time 0-2: posterior probability difference between the humans and the chimps within a motif 
#0.3 (1611 genes) -> 13.61%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.3) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.3), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.3) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.3), ]))/dim(tmm)[1]
#0.2 (1306 genes) -> 11.03%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.2) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.2), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.2) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.2), ]))/dim(tmm)[1]
#0.1 ( 968 genes) ->  8.17%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.1) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.1), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.1) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.1), ]))/dim(tmm)[1]

# Examine genes from each motif
prob.motif1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motif1)
head(prob.motif1)
#boxplot(tmm[prob.motif1[1],]~groupFactor)

prob.motif2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motif2)
head(prob.motif2)
#boxplot(tmm[prob.motif2[1],]~groupFactor)

prob.motif3  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif3)
head(prob.motif3)
#boxplot(tmm[prob.motif3[1],]~groupFactor)

prob.motif4  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif4)
head(prob.motif4)
#boxplot(tmm[prob.motif4[1],]~groupFactor)

prob.motif5  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motif5)
head(prob.motif5)
#boxplot(tmm[prob.motif5[1],]~groupFactor)

prob.motif6  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]<0.5),])
length(prob.motif6)
head(prob.motif6)
#boxplot(tmm[prob.motif6[1],]~groupFactor)

prob.motif7  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]<0.5 & gene.prob[,6]>0.5),])
length(prob.motif7)
head(prob.motif7)
#boxplot(tmm[prob.motif7[1],]~groupFactor)

prob.motif8  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motif8)
head(prob.motif8)
#boxplot(tmm[prob.motif8[1],]~groupFactor)

prob.motif9  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]<0.5),])
length(prob.motif9)
head(prob.motif9)
#boxplot(tmm[prob.motif9[1],]~groupFactor)

# Examine human/chimp differences
prob.motifC  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motifC)
head(prob.motifC)
#boxplot(tmm[prob.motifC[1],]~groupFactor)

prob.motifC0  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]<0.5 & gene.prob[,6]>0.5),])
length(prob.motifC0)
head(prob.motifC0)
#boxplot(tmm[prob.motifC0[1],]~groupFactor)

prob.motifC1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]<0.5),])
length(prob.motifC1)
head(prob.motifC1)
#boxplot(tmm[prob.motifC1[1],]~groupFactor)

prob.motifC2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motifC2)
head(prob.motifC2)
#boxplot(tmm[prob.motifC2[1],]~groupFactor)

prob.motifH  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH)
head(prob.motifH)
#boxplot(tmm[prob.motifH[1],]~groupFactor)

prob.motifH0  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH0)
head(prob.motifH0)
#boxplot(tmm[prob.motifH0[1],]~groupFactor)

prob.motifH1  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH1)
head(prob.motifH1)
#boxplot(tmm[prob.motifH1[1],]~groupFactor)

prob.motifH2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH2)
head(prob.motifH2)
#boxplot(tmm[prob.motifH2[1],]~groupFactor)

```

```{r, eval=FALSE}

saveRDS(gene.prob,"./output/cormotif.pseudo-adhoc.thresh0-6.data.filter.log.indv-cell.int19k-tot.rds")

```

### Run Cormotif using Pseudobulk Data (Species vs. General Ad Hoc Classifications) (median)

```{r, eval=FALSE}

# Compile log2 normalized gene expression data
#make count matrix and metadata for edgeR object - pseudobulk (pseudocounts, filter genes mean(log2cpm)>0)
cell.subset <- c("iPSC","MSC","Osteogenic","other")
counts <- c()
metadata <- c()
labels <- c()
for(j in cell.subset) {
  dataSub <- subset(data,subset=AdHoc.Assign.median==j)
  for (i in unique(dataSub@meta.data$Individual.Replicate)) {
    x.lab <- paste0(i,"_",j)
    w <- which(dataSub@meta.data$Individual.Replicate==i)
    if (length(w)>0) {
      x.spp <- dataSub@meta.data$Species[w][1]
      x.col <- dataSub@meta.data$Collection[w][1]
      x.ind <- dataSub@meta.data$Individual[w][1]
      x.rep <- dataSub@meta.data$Replicate[w][1]
      x.idr <- dataSub@meta.data$Individual.Replicate[w][1]
      x.adh <- as.character(dataSub@meta.data$AdHoc.Assign.median[w][1])
      if (length(w)==1) {
        x.cnt <- dataSub@assays$RNA@counts[,w]
      } else {
        x.cnt <- Matrix::rowSums(dataSub@assays$RNA@counts[,w])
      }
      counts <- cbind(counts, x.cnt)
      metadata <- rbind(metadata, c(x.lab, x.spp, x.col, x.ind, x.rep, x.idr, x.adh))
      labels <- c(labels, x.lab)
    }
  }
}
colnames(counts) <- labels
rownames(metadata) <- labels
colnames(metadata) <- c("Sample","Species","Collection","Individual","Replicate","Individual.Replicate","AdHoc")
metadata <- as.data.frame(metadata)
#remove mitochodrial and ribosomal genes
counts <- counts[which(rownames(counts) %in% genes.no.mito.ribo),]
#make edgeR object
dge <- DGEList(counts)
meta_dge <- dge$samples[,c("lib.size","norm.factors")]
meta_dge <- cbind(meta_dge, metadata)
dge$samples <- meta_dge
rm(counts,metadata,meta_dge)
#filter genes
keep <- rowMeans(edgeR::cpm(dge,log=TRUE,prior.count=0.25))>0
dge$counts <- dge$counts[keep,]
#normalize data
dge <- calcNormFactors(dge, method="TMM")
#log2 transformed cpm
tmm <- edgeR::cpm(dge,normalized.lib.sizes=TRUE,log=TRUE,prior.count=0.25)
##boxplot(tmm,xlab="",ylab="Log2 counts per million",las=2)

```

### Cormotif: Species vs. General Ad Hoc Classifications (median) - 2 time point comparisons

```{r, eval=FALSE}

# Compile group labels of each sample
groupFactor <- factor(paste(dge$samples$Species,dge$samples$AdHoc,sep = "_"),
                      levels=c("Human_iPSC","Human_MSC","Human_Osteogenic","Human_other","Chimp_iPSC","Chimp_MSC","Chimp_Osteogenic","Chimp_other"))
groupID <- as.numeric(groupFactor)

# Compile comparison pattern
#(condiditions to compare = time0, time1, and time2 for each species)
compareID <- data.frame(c1 = c(1, 2, 4, 5),
                        c2 = c(2, 3, 5, 6))

# Assess differences during differentiation
set.seed(1)
cormotifData <- cormotiffit(exprs = tmm,
                            groupid = groupID,
                            compid = compareID,
                            K = 1:10,
                            max.iter=1000,
                            BIC=FALSE)

#which BIC and AIC are lowest? - 3 motifs
cormotifData$bic
plotIC(cormotifData)
cormotifData$bestmotif$loglike

#what motif patterns were learned by the algorithm
plotMotif(cormotifData)

#posterior probability of DE for each gene
head(cormotifData$bestmotif$p.post)

#obtain DE pattern at 0.5 posterior distribution cutoff
gene.prob <- cormotifData$bestmotif$p.post
rownames(gene.prob) <- rownames(tmm)
colnames(gene.prob) <- c("H.iPSC-MSC","H.MSC-Osteogenic","C.iPSC-MSC","C.MSC-Osteogenic")
head(gene.prob)

heatmap.2(gene.prob,
          dendrogram="none",
          Colv=FALSE,
          breaks=c(0,0.2,0.4,0.6,0.8,1),
          col=c("#fef0d9","#fdcc8a","#fc8d59","#e34a33","#b30000"),
          margins=c(3,0),
          trace="none",
          key.title="",
          key.xlab="posterior prob.",
          key.ylab="",
          #ylab=paste0(length(rownames(gene.prob))," genes"),
          keysize=1,
          key.par=list(mar=c(3.5,0,3,0)),
          lmat=rbind(c(5,4,2),c(6,1,3)),
          lhei=c(2.5,5),
          lwid=c(1,10,1),
          labRow=FALSE,
          cexCol=1,
          srtCol=0,
          adjCol=c(0.5,0))

# Test degree of conservation for time 0-2: posterior probability difference between the humans and the chimps within a motif 
#0.3 (2318 genes) -> 19.92%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.3), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.3), ]))/dim(tmm)[1]
#0.2 (1875 genes) -> 16.11%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.2), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.2), ]))/dim(tmm)[1]
#0.1 (1248 genes) -> 10.73%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.1), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,3]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,4]) <= 0.1), ]))/dim(tmm)[1]

# Examine genes from each motif
prob.motif1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motif1)
head(prob.motif1)
#boxplot(tmm[prob.motif1[1],]~groupFactor)

prob.motif2  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5),])
length(prob.motif2)
head(prob.motif2)
#boxplot(tmm[prob.motif2[1],]~groupFactor)

prob.motif3  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5),])
length(prob.motif3)
head(prob.motif3)
#boxplot(tmm[prob.motif3[1],]~groupFactor)

# Examine human/chimp differences
prob.motifC  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5),])
length(prob.motifC)
head(prob.motifC)
#boxplot(tmm[prob.motifC[1],]~groupFactor)

prob.motifC1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5),])
length(prob.motifC1)
head(prob.motifC1)
#boxplot(tmm[prob.motifC1[1],]~groupFactor)

prob.motifC2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5),])
length(prob.motifC2)
head(prob.motifC2)
#boxplot(tmm[prob.motifC2[1],]~groupFactor)

prob.motifH  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motifH)
head(prob.motifH)
#boxplot(tmm[prob.motifH[1],]~groupFactor)

prob.motifH1  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motifH1)
head(prob.motifH1)
#boxplot(tmm[prob.motifH1[1],]~groupFactor)

prob.motifH2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5),])
length(prob.motifH2)
head(prob.motifH2)
#boxplot(tmm[prob.motifH2[1],]~groupFactor)

```

```{r, eval=FALSE}

saveRDS(gene.prob,"./output/cormotif.pseudo-adhoc4.data.filter.log.indv-cell.int19k-tot.rds")

```

### Cormotif: Species vs. General Ad Hoc Classifications (median) - 3 time point comparisons each

```{r, eval=FALSE}

# Compile group labels of each sample
groupFactor <- factor(paste(dge$samples$Species,dge$samples$AdHoc,sep = "_"),
                      levels=c("Human_iPSC","Human_MSC","Human_Osteogenic","Human_other","Chimp_iPSC","Chimp_MSC","Chimp_Osteogenic","Chimp_other"))
groupID <- as.numeric(groupFactor)

# Compile comparison pattern
#(condiditions to compare = time0, time1, and time2 for each species)
compareID <- data.frame(c1 = c(1, 2, 1, 4, 5, 4),
                        c2 = c(2, 3, 3, 5, 6, 6))

# Assess differences during differentiation
set.seed(1)
cormotifData <- cormotiffit(exprs = tmm,
                            groupid = groupID,
                            compid = compareID,
                            K = 1:10,
                            max.iter=1000,
                            BIC=FALSE)

#which BIC and AIC are lowest? - 1 motif (WHAT?!)
cormotifData$bic
plotIC(cormotifData)
cormotifData$bestmotif$loglike

#what motif patterns were learned by the algorithm
plotMotif(cormotifData)

#posterior probability of DE for each gene
head(cormotifData$bestmotif$p.post)

#obtain DE pattern at 0.5 posterior distribution cutoff
gene.prob <- cormotifData$bestmotif$p.post
rownames(gene.prob) <- rownames(tmm)
colnames(gene.prob) <- c("H.iPSC-MSC","H.MSC-Osteogenic","H.iPSC-Osteogenic","C.iPSC-MSC","C.MSC-Osteogenic","C.iPSC-Osteogenic")
head(gene.prob)

heatmap.2(gene.prob,
          dendrogram="none",
          Colv=FALSE,
          breaks=c(0,0.2,0.4,0.6,0.8,1),
          col=c("#fef0d9","#fdcc8a","#fc8d59","#e34a33","#b30000"),
          margins=c(3,0),
          trace="none",
          key.title="",
          key.xlab="posterior prob.",
          key.ylab="",
          #ylab=paste0(length(rownames(gene.prob))," genes"),
          keysize=1,
          key.par=list(mar=c(3.5,0,3,0)),
          lmat=rbind(c(5,4,2),c(6,1,3)),
          lhei=c(2.5,5),
          lwid=c(1,10,1),
          labRow=FALSE,
          cexCol=1,
          srtCol=0,
          adjCol=c(0.5,0))

# Test degree of conservation for time 0-2: posterior probability difference between the humans and the chimps within a motif 
#0.3 (1817 genes) -> 15.62%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.3) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.3), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.3) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.3), ]))/dim(tmm)[1]
#0.2 (1534 genes) -> 13.18%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.2) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.2), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.2) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.2), ]))/dim(tmm)[1]
#0.1 (1166 genes) -> 10.02%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.1) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.1), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.1) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.1), ]))/dim(tmm)[1]

# Examine genes from each motif
prob.motif1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motif1)
head(prob.motif1)
#boxplot(tmm[prob.motif1[1],]~groupFactor)

prob.motif2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motif2)
head(prob.motif2)
#boxplot(tmm[prob.motif2[1],]~groupFactor)

prob.motif3  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif3)
head(prob.motif3)
#boxplot(tmm[prob.motif3[1],]~groupFactor)

prob.motif4  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif4)
head(prob.motif4)
#boxplot(tmm[prob.motif4[1],]~groupFactor)

prob.motif5  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motif5)
head(prob.motif5)
#boxplot(tmm[prob.motif5[1],]~groupFactor)

prob.motif6  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]<0.5),])
length(prob.motif6)
head(prob.motif6)
#boxplot(tmm[prob.motif6[1],]~groupFactor)

prob.motif7  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]<0.5 & gene.prob[,6]>0.5),])
length(prob.motif7)
head(prob.motif7)
#boxplot(tmm[prob.motif7[1],]~groupFactor)

prob.motif8  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif8)
head(prob.motif8)
#boxplot(tmm[prob.motif8[1],]~groupFactor)

prob.motif9  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]<0.5),])
length(prob.motif9)
head(prob.motif9)
#boxplot(tmm[prob.motif9[1],]~groupFactor)

# Examine human/chimp differences
prob.motifC  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motifC)
head(prob.motifC)
#boxplot(tmm[prob.motifC[1],]~groupFactor)

prob.motifC0  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]<0.5 & gene.prob[,6]>0.5),])
length(prob.motifC0)
head(prob.motifC0)
#boxplot(tmm[prob.motifC0[1],]~groupFactor)

prob.motifC1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]<0.5),])
length(prob.motifC1)
head(prob.motifC1)
#boxplot(tmm[prob.motifC1[1],]~groupFactor)

prob.motifC2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motifC2)
head(prob.motifC2)
#boxplot(tmm[prob.motifC2[1],]~groupFactor)

prob.motifH  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH)
head(prob.motifH)
#boxplot(tmm[prob.motifH[1],]~groupFactor)

prob.motifH0  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH0)
head(prob.motifH0)
#boxplot(tmm[prob.motifH0[1],]~groupFactor)

prob.motifH1  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH1)
head(prob.motifH1)
#boxplot(tmm[prob.motifH1[1],]~groupFactor)

prob.motifH2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH2)
head(prob.motifH2)
#boxplot(tmm[prob.motifH2[1],]~groupFactor)

```

```{r, eval=FALSE}

saveRDS(gene.prob,"./output/cormotif.pseudo-adhoc6.data.filter.log.indv-cell.int19k-tot.rds")

```

### Run Cormotif using Pseudobulk Data (Species vs. Osteogenic Clusters) (res=0.5)

```{r}

# Compile log2 normalized gene expression data
#make count matrix and metadata for edgeR object - pseudobulk (pseudocounts, filter genes mean(log2cpm)>0)
cell.subset <- c("Osteogenic.c1","Osteogenic.c2","Osteogenic.c3","Osteogenic.c5")
counts <- c()
metadata <- c()
labels <- c()
for(j in cell.subset) {
  dataSub <- subset(data,subset=Cluster0.5==j)
  for (i in unique(dataSub@meta.data$Individual.Replicate)) {
    x.lab <- paste0(i,"_",j)
    w <- which(dataSub@meta.data$Individual.Replicate==i)
    if (length(w)>0) {
      x.spp <- dataSub@meta.data$Species[w][1]
      x.col <- dataSub@meta.data$Collection[w][1]
      x.ind <- dataSub@meta.data$Individual[w][1]
      x.rep <- dataSub@meta.data$Replicate[w][1]
      x.idr <- dataSub@meta.data$Individual.Replicate[w][1]
      x.clt <- dataSub@meta.data$Cluster0.5[w][1]
      if (length(w)==1) {
        x.cnt <- dataSub@assays$RNA@counts[,w]
      } else {
        x.cnt <- Matrix::rowSums(dataSub@assays$RNA@counts[,w])
      }
      counts <- cbind(counts, x.cnt)
      metadata <- rbind(metadata, c(x.lab, x.spp, x.col, x.ind, x.rep, x.idr, x.clt))
      labels <- c(labels, x.lab)
    }
  }
}
colnames(counts) <- labels
rownames(metadata) <- labels
colnames(metadata) <- c("Sample","Species","Collection","Individual","Replicate","Individual.Replicate","Cluster")
metadata <- as.data.frame(metadata)
#remove mitochodrial and ribosomal genes
counts <- counts[which(rownames(counts) %in% genes.no.mito.ribo),]
#make edgeR object
dge <- DGEList(counts)
meta_dge <- dge$samples[,c("lib.size","norm.factors")]
meta_dge <- cbind(meta_dge, metadata)
dge$samples <- meta_dge
rm(counts,metadata,meta_dge)
#filter genes
keep <- rowMeans(edgeR::cpm(dge,log=TRUE,prior.count=0.25))>0
dge$counts <- dge$counts[keep,]
#normalize data
dge <- calcNormFactors(dge, method="TMM")
#log2 transformed cpm
tmm <- edgeR::cpm(dge,normalized.lib.sizes=TRUE,log=TRUE,prior.count=0.25)
##boxplot(tmm,xlab="",ylab="Log2 counts per million",las=2)

```

### Cormotif: Species vs. Osteogenic Clusters (res=0.5) - 3 time point comparisons each

```{r}

# Compile group labels of each sample
groupFactor <- factor(paste(dge$samples$Species,dge$samples$Cluster,sep="_"),
                      levels=c("Human_Osteogenic.c1","Human_Osteogenic.c2","Human_Osteogenic.c3","Human_Osteogenic.c5",
                               "Chimp_Osteogenic.c1","Chimp_Osteogenic.c2","Chimp_Osteogenic.c3","Chimp_Osteogenic.c5"))
groupID <- as.numeric(groupFactor)

# Compile comparison pattern
#(condiditions to compare = c1, c2, c3, and c5 for each species)
compareID <- data.frame(c1 = c(1, 2, 3, 5, 6, 7),
                        c2 = c(2, 3, 4, 6, 7, 8))

# Assess differences during differentiation
set.seed(1)
cormotifData <- cormotiffit(exprs = tmm,
                            groupid = groupID,
                            compid = compareID,
                            K = 1:10,
                            max.iter=1000,
                            BIC=FALSE)

#which BIC and AIC are lowest? - 6 motifs
cormotifData$bic
plotIC(cormotifData)
cormotifData$bestmotif$loglike

#what motif patterns were learned by the algorithm
plotMotif(cormotifData)

#posterior probability of DE for each gene
head(cormotifData$bestmotif$p.post)

#obtain DE pattern at 0.5 posterior distribution cutoff
gene.prob <- cormotifData$bestmotif$p.post
rownames(gene.prob) <- rownames(tmm)
colnames(gene.prob) <- c("H.ost.c1-c2","H.ost.c2-c3","H.ost.c3-c5","C.ost.c1-c2","C.ost.c2-c3","C.ost.c3-c5")
head(gene.prob)

heatmap.2(gene.prob,
          dendrogram="none",
          Colv=FALSE,
          breaks=c(0,0.2,0.4,0.6,0.8,1),
          col=c("#fef0d9","#fdcc8a","#fc8d59","#e34a33","#b30000"),
          margins=c(3,0),
          trace="none",
          key.title="",
          key.xlab="posterior prob.",
          key.ylab="",
          #ylab=paste0(length(rownames(gene.prob))," genes"),
          keysize=1,
          key.par=list(mar=c(3.5,0,3,0)),
          lmat=rbind(c(5,4,2),c(6,1,3)),
          lhei=c(2.5,5),
          lwid=c(1,10,1),
          labRow=FALSE,
          cexCol=1,
          srtCol=0,
          adjCol=c(0.5,0))

# Test degree of conservation for iPSCs-Osteogenic cells: posterior probability difference between the humans and the chimps within a motif 
#0.3 (3789 genes) -> 36.15%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.3) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.3), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.3) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.3), ]))/dim(tmm)[1]
#0.2 (2103 genes) -> 20.06%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.2) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.2), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.2) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.2), ]))/dim(tmm)[1]
#0.1 ( 925 genes) ->  8.83%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.1) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.1), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.1) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.1), ]))/dim(tmm)[1]

# Examine genes from each motif
prob.motif1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]>0.5),])
length(prob.motif1)
head(prob.motif1)
#boxplot(tmm[prob.motif1[1],]~groupFactor)

prob.motif2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]>0.5),])
length(prob.motif2)
head(prob.motif2)
#boxplot(tmm[prob.motif2[1],]~groupFactor)

prob.motif3  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 & gene.prob[,5]<0.5 & gene.prob[,6]>0.5),])
length(prob.motif3)
head(prob.motif3)
#boxplot(tmm[prob.motif3[1],]~groupFactor)

prob.motif4  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motif4)
head(prob.motif4)
#boxplot(tmm[prob.motif4[1],]~groupFactor)

prob.motif5  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif5)
head(prob.motif5)
#boxplot(tmm[prob.motif5[1],]~groupFactor)

prob.motif6  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 & gene.prob[,5]<0.5 & gene.prob[,6]>0.5),])
length(prob.motif6)
head(prob.motif6)
#boxplot(tmm[prob.motif6[1],]~groupFactor)

# Examine human/chimp differences
prob.motifC  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motifC)
head(prob.motifC)
#boxplot(tmm[prob.motifC[1],]~groupFactor)

prob.motifH  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH)
head(prob.motifH)
#boxplot(tmm[prob.motifH[1],]~groupFactor)

```

```{r, eval=FALSE}

saveRDS(gene.prob,"./output/cormotif.pseudo-cluster0.05-6.data.filter.log.indv-cell.int19k-tot.rds")

```

### Run Cormotif using Pseudobulk Data (Species vs. Osteogenic Clusters) (t2 with res=0.1)

```{r, eval=FALSE}

# Compile log2 normalized gene expression data
#make count matrix and metadata for edgeR object - pseudobulk (pseudocounts, filter genes mean(log2cpm)>0)
cell.subset <- c("Osteogenic.c1","Osteogenic.c2","Osteogenic.c3","Osteogenic.c5")
counts <- c()
metadata <- c()
labels <- c()
for(j in cell.subset) {
  dataSub <- subset(data,subset=Cluster.t2==j)
  for (i in unique(dataSub@meta.data$Individual.Replicate)) {
    x.lab <- paste0(i,"_",j)
    w <- which(dataSub@meta.data$Individual.Replicate==i)
    if (length(w)>0) {
      x.spp <- dataSub@meta.data$Species[w][1]
      x.col <- dataSub@meta.data$Collection[w][1]
      x.ind <- dataSub@meta.data$Individual[w][1]
      x.rep <- dataSub@meta.data$Replicate[w][1]
      x.idr <- dataSub@meta.data$Individual.Replicate[w][1]
      x.clt <- dataSub@meta.data$Cluster.t2[w][1]
      if (length(w)==1) {
        x.cnt <- dataSub@assays$RNA@counts[,w]
      } else {
        x.cnt <- Matrix::rowSums(dataSub@assays$RNA@counts[,w])
      }
      counts <- cbind(counts, x.cnt)
      metadata <- rbind(metadata, c(x.lab, x.spp, x.col, x.ind, x.rep, x.idr, x.clt))
      labels <- c(labels, x.lab)
    }
  }
}
colnames(counts) <- labels
rownames(metadata) <- labels
colnames(metadata) <- c("Sample","Species","Collection","Individual","Replicate","Individual.Replicate","Cluster")
metadata <- as.data.frame(metadata)
#remove mitochodrial and ribosomal genes
counts <- counts[which(rownames(counts) %in% genes.no.mito.ribo),]
#make edgeR object
dge <- DGEList(counts)
meta_dge <- dge$samples[,c("lib.size","norm.factors")]
meta_dge <- cbind(meta_dge, metadata)
dge$samples <- meta_dge
rm(counts,metadata,meta_dge)
#filter genes
keep <- rowMeans(edgeR::cpm(dge,log=TRUE,prior.count=0.25))>0
dge$counts <- dge$counts[keep,]
#normalize data
dge <- calcNormFactors(dge, method="TMM")
#log2 transformed cpm
tmm <- edgeR::cpm(dge,normalized.lib.sizes=TRUE,log=TRUE,prior.count=0.25)
##boxplot(tmm,xlab="",ylab="Log2 counts per million",las=2)

```

### Cormotif: Species vs. Osteogenic Clusters (t2 with res=0.1) - 3 time point comparisons each

```{r, eval=FALSE}

# Compile group labels of each sample
groupFactor <- factor(paste(dge$samples$Species,dge$samples$Cluster,sep="_"),
                      levels=c("Human_Osteogenic.c1","Human_Osteogenic.c2","Human_Osteogenic.c3","Human_Osteogenic.c5",
                               "Chimp_Osteogenic.c1","Chimp_Osteogenic.c2","Chimp_Osteogenic.c3","Chimp_Osteogenic.c5"))
groupID <- as.numeric(groupFactor)

# Compile comparison pattern
#(condiditions to compare = c1, c2, c3, and c5 for each species)
compareID <- data.frame(c1 = c(1, 2, 3, 5, 6, 7),
                        c2 = c(2, 3, 4, 6, 7, 8))

# Assess differences during differentiation
set.seed(1)
cormotifData <- cormotiffit(exprs = tmm,
                            groupid = groupID,
                            compid = compareID,
                            K = 1:10,
                            max.iter=1000,
                            BIC=FALSE)

#which BIC and AIC are lowest? - 7 motifs
cormotifData$bic
plotIC(cormotifData)
cormotifData$bestmotif$loglike

#what motif patterns were learned by the algorithm
plotMotif(cormotifData)

#posterior probability of DE for each gene
head(cormotifData$bestmotif$p.post)

#obtain DE pattern at 0.5 posterior distribution cutoff
gene.prob <- cormotifData$bestmotif$p.post
rownames(gene.prob) <- rownames(tmm)
colnames(gene.prob) <- c("H.ost.c1-c2","H.ost.c2-c3","H.ost.c3-c5","C.ost.c1-c2","C.ost.c2-c3","C.ost.c3-c5")
head(gene.prob)

heatmap.2(gene.prob,
          dendrogram="none",
          Colv=FALSE,
          breaks=c(0,0.2,0.4,0.6,0.8,1),
          col=c("#fef0d9","#fdcc8a","#fc8d59","#e34a33","#b30000"),
          margins=c(3,0),
          trace="none",
          key.title="",
          key.xlab="posterior prob.",
          key.ylab="",
          #ylab=paste0(length(rownames(gene.prob))," genes"),
          keysize=1,
          key.par=list(mar=c(3.5,0,3,0)),
          lmat=rbind(c(5,4,2),c(6,1,3)),
          lhei=c(2.5,5),
          lwid=c(1,10,1),
          labRow=FALSE,
          cexCol=1,
          srtCol=0,
          adjCol=c(0.5,0))

# Test degree of conservation for iPSCs-Osteogenic cells: posterior probability difference between the humans and the chimps within a motif 
#0.3 (9100 genes) -> 84.62%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.3) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.3), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.3) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.3) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.3), ]))/dim(tmm)[1]
#0.2 (8184 genes) -> 76.10%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.2) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.2), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.2) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.2) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.2), ]))/dim(tmm)[1]
#0.1 (6424 genes) -> 59.74
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.1) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.1), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,4]) <= 0.1) & (abs(gene.prob[,2] - gene.prob[,5]) <= 0.1) & (abs(gene.prob[,3] - gene.prob[,6]) <= 0.1), ]))/dim(tmm)[1]

# Examine genes from each motif
prob.motif1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motif1)
head(prob.motif1)
#boxplot(tmm[prob.motif1[1],]~groupFactor)

prob.motif2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif2)
head(prob.motif2)
#boxplot(tmm[prob.motif2[1],]~groupFactor)

prob.motif3  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif3)
head(prob.motif3)
#boxplot(tmm[prob.motif3[1],]~groupFactor)

prob.motif4  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motif4)
head(prob.motif4)
#boxplot(tmm[prob.motif4[1],]~groupFactor)

prob.motif5  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motif5)
head(prob.motif5)
#boxplot(tmm[prob.motif5[1],]~groupFactor)

prob.motif6  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motif6)
head(prob.motif6)
#boxplot(tmm[prob.motif6[1],]~groupFactor)

prob.motif7  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motif7)
head(prob.motif7)
#boxplot(tmm[prob.motif7[1],]~groupFactor)

# Examine human/chimp differences
prob.motifC  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 & gene.prob[,5]>0.5 & gene.prob[,6]>0.5),])
length(prob.motifC)
head(prob.motifC)
#boxplot(tmm[prob.motifC[1],]~groupFactor)

prob.motifH  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 & gene.prob[,5]<0.5 & gene.prob[,6]<0.5),])
length(prob.motifH)
head(prob.motifH)
#boxplot(tmm[prob.motifH[1],]~groupFactor)

```

```{r, eval=FALSE}

saveRDS(gene.prob,"./output/cormotif.pseudo-cluster.t2-6.data.filter.log.indv-cell.int19k-tot.rds")

```

### Run Cormotif using Pseudobulk Data (Species vs. Osteogenic Ad Hoc Classifications) (thresh0)

```{r}

# Compile log2 normalized gene expression data
#make count matrix and metadata for edgeR object - pseudobulk (pseudocounts, filter genes mean(log2cpm)>0)
cell.subset <- c("preosteoblast","osteoblast","embedding osteoblast","mineralizing osteoblast","maturing osteocyte","unknown osteogenic","not osteogenic")
counts <- c()
metadata <- c()
labels <- c()
for(j in cell.subset) {
  dataSub <- subset(data,subset=OstAdHoc.Assign.5gene.thresh0==j)
  #dataSub <- subset(data,subset=(OstAdHoc.Assign.5gene.median==j & Stage=="Time 2"))
  for (i in unique(dataSub@meta.data$Individual.Replicate)) {
    x.lab <- paste0(i,"_",sub(" ",".",j))
    w <- which(dataSub@meta.data$Individual.Replicate==i)
    if (length(w)>0) {
      x.spp <- dataSub@meta.data$Species[w][1]
      x.col <- dataSub@meta.data$Collection[w][1]
      x.ind <- dataSub@meta.data$Individual[w][1]
      x.rep <- dataSub@meta.data$Replicate[w][1]
      x.idr <- dataSub@meta.data$Individual.Replicate[w][1]
      x.adh <- sub(" ",".",as.character(dataSub@meta.data$OstAdHoc.Assign.5gene.thresh0[w][1]))
      if (length(w)==1) {
        x.cnt <- dataSub@assays$RNA@counts[,w]
      } else {
        x.cnt <- Matrix::rowSums(dataSub@assays$RNA@counts[,w])
      }
      counts <- cbind(counts, x.cnt)
      metadata <- rbind(metadata, c(x.lab, x.spp, x.col, x.ind, x.rep, x.idr, x.adh))
      labels <- c(labels, x.lab)
    }
  }
}
colnames(counts) <- labels
rownames(metadata) <- labels
colnames(metadata) <- c("Sample","Species","Collection","Individual","Replicate","Individual.Replicate","AdHoc")
metadata <- as.data.frame(metadata)
#remove mitochodrial and ribosomal genes
counts <- counts[which(rownames(counts) %in% genes.no.mito.ribo),]
#make edgeR object
dge <- DGEList(counts)
meta_dge <- dge$samples[,c("lib.size","norm.factors")]
meta_dge <- cbind(meta_dge, metadata)
dge$samples <- meta_dge
rm(counts,metadata,meta_dge)
#filter genes
keep <- rowMeans(edgeR::cpm(dge,log=TRUE,prior.count=0.25))>0
dge$counts <- dge$counts[keep,]
#normalize data
dge <- calcNormFactors(dge, method="TMM")
#log2 transformed cpm
tmm <- edgeR::cpm(dge,normalized.lib.sizes=TRUE,log=TRUE,prior.count=0.25)
##boxplot(tmm,xlab="",ylab="Log2 counts per million",las=2)

```

### Cormotif: Species vs. Osteogenic Ad Hoc Classifications (thresh0) - 4 time point comparisons each

```{r}

# Compile group labels of each sample
groupFactor <- factor(paste(dge$samples$Species,sapply(dge$samples$AdHoc,function(x)sub(" ",".",x)),sep="_"),
                      levels=c("Human_preosteoblast","Human_osteoblast","Human_embedding.osteoblast","Human_mineralizing.osteoblast","Human_maturing.osteocyte",
                               "Human_unknown.osteogenic","Human_not.osteogenic",
                               "Chimp_preosteoblast","Chimp_osteoblast","Chimp_embedding.osteoblast","Chimp_mineralizing.osteoblast","Chimp_maturing.osteocyte",
                               "Chimp_unknown.osteogenic","Chimp_not.osteogenic"))
groupID <- as.numeric(groupFactor)

# Compile comparison pattern
#(condiditions to compare = time0, time1, and time2 for each species)
compareID <- data.frame(c1 = c(1, 2, 3, 4, 8,  9, 10, 11),
                        c2 = c(2, 3, 4, 5, 9, 10, 11, 12))

# Assess differences during differentiation
set.seed(1)
cormotifData <- cormotiffit(exprs = tmm,
                            groupid = groupID,
                            compid = compareID,
                            K = 1:10,
                            max.iter=1000,
                            BIC=FALSE)

#which BIC and AIC are lowest? - 1 motif (WHAT?!)
cormotifData$bic
plotIC(cormotifData)
cormotifData$bestmotif$loglike

#what motif patterns were learned by the algorithm
plotMotif(cormotifData)

#posterior probability of DE for each gene
head(cormotifData$bestmotif$p.post)

#obtain DE pattern at 0.5 posterior distribution cutoff
gene.prob <- cormotifData$bestmotif$p.post
rownames(gene.prob) <- rownames(tmm)
colnames(gene.prob) <- c("H.pre-obl","H.obl-emb","H.emb-min","H.min-mat","C.pre-obl","C.obl-emb","C.emb-min","C.min-mat")
head(gene.prob)

heatmap.2(gene.prob,
          dendrogram="none",
          Colv=FALSE,
          breaks=c(0,0.2,0.4,0.6,0.8,1),
          col=c("#fef0d9","#fdcc8a","#fc8d59","#e34a33","#b30000"),
          margins=c(3,0),
          trace="none",
          key.title="",
          key.xlab="posterior prob.",
          key.ylab="",
          #ylab=paste0(length(rownames(gene.prob))," genes"),
          keysize=1,
          key.par=list(mar=c(3.5,0,3,0)),
          lmat=rbind(c(5,4,2),c(6,1,3)),
          lhei=c(2.5,5),
          lwid=c(1,10,1),
          labRow=FALSE,
          cexCol=1,
          srtCol=0,
          adjCol=c(0.5,0))

# Test degree of conservation for preosteoblasts-maturing osteocytes: posterior probability difference between the humans and the chimps within a motif 
#0.3 (0 genes) ->  0%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.3) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.3) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.3) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.3), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.3) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.3) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.3) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.3), ]))/dim(tmm)[1]
#0.2 (0 genes) ->  0%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.2) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.2) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.2) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.2), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.2) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.2) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.2) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.2), ]))/dim(tmm)[1]
#0.1 (0 genes) ->  0%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.1) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.1) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.1) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.1), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.1) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.1) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.1) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.1), ]))/dim(tmm)[1]

# Examine genes from each motif
prob.motif1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motif1)
head(prob.motif1)
#boxplot(tmm[prob.motif1[1],]~groupFactor)

# Examine human/chimp differences
prob.motifC  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifC)
head(prob.motifC)
#boxplot(tmm[prob.motifC[1],]~groupFactor)

prob.motifC1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]>0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifC1)
head(prob.motifC1)
#boxplot(tmm[prob.motifC1[1],]~groupFactor)

prob.motifC2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]>0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifC2)
head(prob.motifC2)
#boxplot(tmm[prob.motifC2[1],]~groupFactor)

prob.motifC3  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]>0.5 & gene.prob[,8]<0.5),])
length(prob.motifC3)
head(prob.motifC3)
#boxplot(tmm[prob.motifC3[1],]~groupFactor)

prob.motifC4  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]>0.5),])
length(prob.motifC4)
head(prob.motifC4)
#boxplot(tmm[prob.motifC4[1],]~groupFactor)

prob.motifH  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH)
head(prob.motifH)
#boxplot(tmm[prob.motifH[1],]~groupFactor)

prob.motifH1  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH1)
head(prob.motifH1)
#boxplot(tmm[prob.motifH1[1],]~groupFactor)

prob.motifH2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH2)
head(prob.motifH2)
#boxplot(tmm[prob.motifH2[1],]~groupFactor)

prob.motifH3  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH3)
head(prob.motifH3)
#boxplot(tmm[prob.motifH3[1],]~groupFactor)

prob.motifH4  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH4)
head(prob.motifH4)
#boxplot(tmm[prob.motifH4[1],]~groupFactor)

```

```{r, eval=FALSE}

saveRDS(gene.prob,"./output/cormotif.pseudo-ostadhoc.thresh0-8.data.filter.log.indv-cell.int19k-tot.rds")

```

### Run Cormotif using Pseudobulk Data (Species vs. Osteogenic Ad Hoc Classifications) (median)

```{r, eval=FALSE}

# Compile log2 normalized gene expression data
#make count matrix and metadata for edgeR object - pseudobulk (pseudocounts, filter genes mean(log2cpm)>0)
cell.subset <- c("preosteoblast","osteoblast","embedding osteoblast","mineralizing osteoblast","maturing osteocyte","unknown osteogenic","not osteogenic")
counts <- c()
metadata <- c()
labels <- c()
for(j in cell.subset) {
  dataSub <- subset(data,subset=OstAdHoc.Assign.5gene.median==j)
  #dataSub <- subset(data,subset=(OstAdHoc.Assign.5gene.median==j & Stage=="Time 2"))
  for (i in unique(dataSub@meta.data$Individual.Replicate)) {
    x.lab <- paste0(i,"_",sub(" ",".",j))
    w <- which(dataSub@meta.data$Individual.Replicate==i)
    if (length(w)>0) {
      x.spp <- dataSub@meta.data$Species[w][1]
      x.col <- dataSub@meta.data$Collection[w][1]
      x.ind <- dataSub@meta.data$Individual[w][1]
      x.rep <- dataSub@meta.data$Replicate[w][1]
      x.idr <- dataSub@meta.data$Individual.Replicate[w][1]
      x.adh <- sub(" ",".",as.character(dataSub@meta.data$OstAdHoc.Assign.5gene.median[w][1]))
      if (length(w)==1) {
        x.cnt <- dataSub@assays$RNA@counts[,w]
      } else {
        x.cnt <- Matrix::rowSums(dataSub@assays$RNA@counts[,w])
      }
      counts <- cbind(counts, x.cnt)
      metadata <- rbind(metadata, c(x.lab, x.spp, x.col, x.ind, x.rep, x.idr, x.adh))
      labels <- c(labels, x.lab)
    }
  }
}
colnames(counts) <- labels
rownames(metadata) <- labels
colnames(metadata) <- c("Sample","Species","Collection","Individual","Replicate","Individual.Replicate","AdHoc")
metadata <- as.data.frame(metadata)
#remove mitochodrial and ribosomal genes
counts <- counts[which(rownames(counts) %in% genes.no.mito.ribo),]
#make edgeR object
dge <- DGEList(counts)
meta_dge <- dge$samples[,c("lib.size","norm.factors")]
meta_dge <- cbind(meta_dge, metadata)
dge$samples <- meta_dge
rm(counts,metadata,meta_dge)
#filter genes
keep <- rowMeans(edgeR::cpm(dge,log=TRUE,prior.count=0.25))>0
dge$counts <- dge$counts[keep,]
#normalize data
dge <- calcNormFactors(dge, method="TMM")
#log2 transformed cpm
tmm <- edgeR::cpm(dge,normalized.lib.sizes=TRUE,log=TRUE,prior.count=0.25)
##boxplot(tmm,xlab="",ylab="Log2 counts per million",las=2)

```

### Cormotif: Species vs. Osteogenic Ad Hoc Classifications (median) - 4 time point comparisons each

```{r, eval=FALSE}

# Compile group labels of each sample
groupFactor <- factor(paste(dge$samples$Species,sapply(dge$samples$AdHoc,function(x)sub(" ",".",x)),sep="_"),
                      levels=c("Human_preosteoblast","Human_osteoblast","Human_embedding.osteoblast","Human_mineralizing.osteoblast","Human_maturing.osteocyte",
                               "Human_unknown.osteogenic","Human_not.osteogenic",
                               "Chimp_preosteoblast","Chimp_osteoblast","Chimp_embedding.osteoblast","Chimp_mineralizing.osteoblast","Chimp_maturing.osteocyte",
                               "Chimp_unknown.osteogenic","Chimp_not.osteogenic"))
groupID <- as.numeric(groupFactor)

# Compile comparison pattern
#(condiditions to compare = time0, time1, and time2 for each species)
compareID <- data.frame(c1 = c(1, 2, 3, 4, 8,  9, 10, 11),
                        c2 = c(2, 3, 4, 5, 9, 10, 11, 12))

# Assess differences during differentiation
set.seed(1)
cormotifData <- cormotiffit(exprs = tmm,
                            groupid = groupID,
                            compid = compareID,
                            K = 1:10,
                            max.iter=1000,
                            BIC=FALSE)

#which BIC and AIC are lowest? - 1 motif (WHAT?!)
cormotifData$bic
plotIC(cormotifData)
cormotifData$bestmotif$loglike

#what motif patterns were learned by the algorithm
plotMotif(cormotifData)

#posterior probability of DE for each gene
head(cormotifData$bestmotif$p.post)

#obtain DE pattern at 0.5 posterior distribution cutoff
gene.prob <- cormotifData$bestmotif$p.post
rownames(gene.prob) <- rownames(tmm)
colnames(gene.prob) <- c("H.pre-obl","H.obl-emb","H.emb-min","H.min-mat","C.pre-obl","C.obl-emb","C.emb-min","C.min-mat")
head(gene.prob)

heatmap.2(gene.prob,
          dendrogram="none",
          Colv=FALSE,
          breaks=c(0,0.2,0.4,0.6,0.8,1),
          col=c("#fef0d9","#fdcc8a","#fc8d59","#e34a33","#b30000"),
          margins=c(3,0),
          trace="none",
          key.title="",
          key.xlab="posterior prob.",
          key.ylab="",
          #ylab=paste0(length(rownames(gene.prob))," genes"),
          keysize=1,
          key.par=list(mar=c(3.5,0,3,0)),
          lmat=rbind(c(5,4,2),c(6,1,3)),
          lhei=c(2.5,5),
          lwid=c(1,10,1),
          labRow=FALSE,
          cexCol=1,
          srtCol=0,
          adjCol=c(0.5,0))

# Test degree of conservation for preosteoblasts-maturing osteocytes: posterior probability difference between the humans and the chimps within a motif 
#0.3 (22 genes) ->  0.20%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.3) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.3) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.3) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.3), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.3) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.3) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.3) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.3), ]))/dim(tmm)[1]
#0.2 (12 genes) ->  0.11%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.2) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.2) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.2) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.2), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.2) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.2) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.2) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.2), ]))/dim(tmm)[1]
#0.1 (6 genes) ->  0.06%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.1) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.1) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.1) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.1), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.1) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.1) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.1) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.1), ]))/dim(tmm)[1]

# Examine genes from each motif
prob.motif1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motif1)
head(prob.motif1)
#boxplot(tmm[prob.motif1[1],]~groupFactor)

prob.motif2  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]>0.5 & gene.prob[,7]>0.5 & gene.prob[,8]>0.5),])
length(prob.motif2)
head(prob.motif2)
#boxplot(tmm[prob.motif2[1],]~groupFactor)

# Examine human/chimp differences
prob.motifC  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifC)
head(prob.motifC)
#boxplot(tmm[prob.motifC[1],]~groupFactor)

prob.motifC1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]>0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifC1)
head(prob.motifC1)
#boxplot(tmm[prob.motifC1[1],]~groupFactor)

prob.motifC2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]>0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifC2)
head(prob.motifC2)
#boxplot(tmm[prob.motifC2[1],]~groupFactor)

prob.motifC3  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]>0.5 & gene.prob[,8]<0.5),])
length(prob.motifC3)
head(prob.motifC3)
#boxplot(tmm[prob.motifC3[1],]~groupFactor)

prob.motifC4  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]>0.5),])
length(prob.motifC4)
head(prob.motifC4)
#boxplot(tmm[prob.motifC4[1],]~groupFactor)

prob.motifH  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH)
head(prob.motifH)
#boxplot(tmm[prob.motifH[1],]~groupFactor)

prob.motifH1  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH1)
head(prob.motifH1)
#boxplot(tmm[prob.motifH1[1],]~groupFactor)

prob.motifH2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH2)
head(prob.motifH2)
#boxplot(tmm[prob.motifH2[1],]~groupFactor)

prob.motifH3  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH3)
head(prob.motifH3)
#boxplot(tmm[prob.motifH3[1],]~groupFactor)

prob.motifH4  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH4)
head(prob.motifH4)
#boxplot(tmm[prob.motifH4[1],]~groupFactor)

```

```{r, eval=FALSE}

saveRDS(gene.prob,"./output/cormotif.pseudo-ostadhoc8.data.filter.log.indv-cell.int19k-tot.rds")

```

### Run Cormotif using Pseudobulk Data (Species vs. Osteogenic Ad Hoc Classifications) (thresh0 for t2)

```{r, eval=FALSE}

# Compile log2 normalized gene expression data
#make count matrix and metadata for edgeR object - pseudobulk (pseudocounts, filter genes mean(log2cpm)>0)
cell.subset <- c("preosteoblast","osteoblast","embedding osteoblast","mineralizing osteoblast","maturing osteocyte","unknown osteogenic","not osteogenic")
counts <- c()
metadata <- c()
labels <- c()
for(j in cell.subset) {
  dataSub <- subset(data,subset=OstAdHoc.Assign.5gene.thresh0.t2==j)
  #dataSub <- subset(data,subset=(OstAdHoc.Assign.5gene.median==j & Stage=="Time 2"))
  for (i in unique(dataSub@meta.data$Individual.Replicate)) {
    x.lab <- paste0(i,"_",sub(" ",".",j))
    w <- which(dataSub@meta.data$Individual.Replicate==i)
    if (length(w)>0) {
      x.spp <- dataSub@meta.data$Species[w][1]
      x.col <- dataSub@meta.data$Collection[w][1]
      x.ind <- dataSub@meta.data$Individual[w][1]
      x.rep <- dataSub@meta.data$Replicate[w][1]
      x.idr <- dataSub@meta.data$Individual.Replicate[w][1]
      x.adh <- sub(" ",".",as.character(dataSub@meta.data$OstAdHoc.Assign.5gene.thresh0.t2[w][1]))
      if (length(w)==1) {
        x.cnt <- dataSub@assays$RNA@counts[,w]
      } else {
        x.cnt <- Matrix::rowSums(dataSub@assays$RNA@counts[,w])
      }
      counts <- cbind(counts, x.cnt)
      metadata <- rbind(metadata, c(x.lab, x.spp, x.col, x.ind, x.rep, x.idr, x.adh))
      labels <- c(labels, x.lab)
    }
  }
}
colnames(counts) <- labels
rownames(metadata) <- labels
colnames(metadata) <- c("Sample","Species","Collection","Individual","Replicate","Individual.Replicate","AdHoc")
metadata <- as.data.frame(metadata)
#remove mitochodrial and ribosomal genes
counts <- counts[which(rownames(counts) %in% genes.no.mito.ribo),]
#make edgeR object
dge <- DGEList(counts)
meta_dge <- dge$samples[,c("lib.size","norm.factors")]
meta_dge <- cbind(meta_dge, metadata)
dge$samples <- meta_dge
rm(counts,metadata,meta_dge)
#filter genes
keep <- rowMeans(edgeR::cpm(dge,log=TRUE,prior.count=0.25))>0
dge$counts <- dge$counts[keep,]
#normalize data
dge <- calcNormFactors(dge, method="TMM")
#log2 transformed cpm
tmm <- edgeR::cpm(dge,normalized.lib.sizes=TRUE,log=TRUE,prior.count=0.25)
##boxplot(tmm,xlab="",ylab="Log2 counts per million",las=2)

```

### Cormotif: Species vs. Osteogenic Ad Hoc Classifications (thresh0 for t2) - 4 time point comparisons each

```{r, eval=FALSE}

# Compile group labels of each sample
groupFactor <- factor(paste(dge$samples$Species,sapply(dge$samples$AdHoc,function(x)sub(" ",".",x)),sep="_"),
                      levels=c("Human_preosteoblast","Human_osteoblast","Human_embedding.osteoblast","Human_mineralizing.osteoblast","Human_maturing.osteocyte",
                               "Human_unknown.osteogenic","Human_not.osteogenic",
                               "Chimp_preosteoblast","Chimp_osteoblast","Chimp_embedding.osteoblast","Chimp_mineralizing.osteoblast","Chimp_maturing.osteocyte",
                               "Chimp_unknown.osteogenic","Chimp_not.osteogenic"))
groupID <- as.numeric(groupFactor)

# Compile comparison pattern
#(condiditions to compare = time0, time1, and time2 for each species)
compareID <- data.frame(c1 = c(1, 2, 3, 4, 8,  9, 10, 11),
                        c2 = c(2, 3, 4, 5, 9, 10, 11, 12))

# Assess differences during differentiation
set.seed(1)
cormotifData <- cormotiffit(exprs = tmm,
                            groupid = groupID,
                            compid = compareID,
                            K = 1:10,
                            max.iter=1000,
                            BIC=FALSE)

#which BIC and AIC are lowest? - 1 motif (WHAT?!)
cormotifData$bic
plotIC(cormotifData)
cormotifData$bestmotif$loglike

#what motif patterns were learned by the algorithm
plotMotif(cormotifData)

#posterior probability of DE for each gene
head(cormotifData$bestmotif$p.post)

#obtain DE pattern at 0.5 posterior distribution cutoff
gene.prob <- cormotifData$bestmotif$p.post
rownames(gene.prob) <- rownames(tmm)
colnames(gene.prob) <- c("H.pre-obl","H.obl-emb","H.emb-min","H.min-mat","C.pre-obl","C.obl-emb","C.emb-min","C.min-mat")
head(gene.prob)

heatmap.2(gene.prob,
          dendrogram="none",
          Colv=FALSE,
          breaks=c(0,0.2,0.4,0.6,0.8,1),
          col=c("#fef0d9","#fdcc8a","#fc8d59","#e34a33","#b30000"),
          margins=c(3,0),
          trace="none",
          key.title="",
          key.xlab="posterior prob.",
          key.ylab="",
          #ylab=paste0(length(rownames(gene.prob))," genes"),
          keysize=1,
          key.par=list(mar=c(3.5,0,3,0)),
          lmat=rbind(c(5,4,2),c(6,1,3)),
          lhei=c(2.5,5),
          lwid=c(1,10,1),
          labRow=FALSE,
          cexCol=1,
          srtCol=0,
          adjCol=c(0.5,0))

# Test degree of conservation for preosteoblasts-maturing osteocytes: posterior probability difference between the humans and the chimps within a motif 
#0.3 (0 genes) ->  0%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.3) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.3) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.3) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.3), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.3) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.3) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.3) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.3), ]))/dim(tmm)[1]
#0.2 (0 genes) ->  0%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.2) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.2) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.2) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.2), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.2) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.2) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.2) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.2), ]))/dim(tmm)[1]
#0.1 (0 genes) ->  0%
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.1) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.1) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.1) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.1), ]))
length(rownames(gene.prob[(abs(gene.prob[,1] - gene.prob[,5]) <= 0.1) &
                          (abs(gene.prob[,2] - gene.prob[,6]) <= 0.1) &
                          (abs(gene.prob[,3] - gene.prob[,7]) <= 0.1) &
                          (abs(gene.prob[,4] - gene.prob[,8]) <= 0.1), ]))/dim(tmm)[1]

# Examine genes from each motif
prob.motif1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]>0.5 & gene.prob[,8]<0.5),])
length(prob.motif1)
head(prob.motif1)
#boxplot(tmm[prob.motif1[1],]~groupFactor)

# Examine human/chimp differences
prob.motifC  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifC)
head(prob.motifC)
#boxplot(tmm[prob.motifC[1],]~groupFactor)

prob.motifC1  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]>0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifC1)
head(prob.motifC1)
#boxplot(tmm[prob.motifC1[1],]~groupFactor)

prob.motifC2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]>0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifC2)
head(prob.motifC2)
#boxplot(tmm[prob.motifC2[1],]~groupFactor)

prob.motifC3  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]>0.5 & gene.prob[,8]<0.5),])
length(prob.motifC3)
head(prob.motifC3)
#boxplot(tmm[prob.motifC3[1],]~groupFactor)

prob.motifC4  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]>0.5),])
length(prob.motifC4)
head(prob.motifC4)
#boxplot(tmm[prob.motifC4[1],]~groupFactor)

prob.motifH  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]>0.5 & gene.prob[,3]>0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH)
head(prob.motifH)
#boxplot(tmm[prob.motifH[1],]~groupFactor)

prob.motifH1  <- rownames(gene.prob[(gene.prob[,1]>0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH1)
head(prob.motifH1)
#boxplot(tmm[prob.motifH1[1],]~groupFactor)

prob.motifH2  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]>0.5 & gene.prob[,3]<0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH2)
head(prob.motifH2)
#boxplot(tmm[prob.motifH2[1],]~groupFactor)

prob.motifH3  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]>0.5 & gene.prob[,4]<0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH3)
head(prob.motifH3)
#boxplot(tmm[prob.motifH3[1],]~groupFactor)

prob.motifH4  <- rownames(gene.prob[(gene.prob[,1]<0.5 & gene.prob[,2]<0.5 & gene.prob[,3]<0.5 & gene.prob[,4]>0.5 &
                                    gene.prob[,5]<0.5 & gene.prob[,6]<0.5 & gene.prob[,7]<0.5 & gene.prob[,8]<0.5),])
length(prob.motifH4)
head(prob.motifH4)
#boxplot(tmm[prob.motifH4[1],]~groupFactor)

```

```{r, eval=FALSE}

saveRDS(gene.prob,"./output/cormotif.pseudo-ostadhoc.thresh0.t2-8.data.filter.log.indv-cell.int19k-tot.rds")

```
